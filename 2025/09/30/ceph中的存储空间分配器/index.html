<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-m.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-m.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hoshilzy1026.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="Ceph BlueStore åˆ†é…å™¨æ·±åº¦è§£æç›®å½• 1. å¼•è¨€ 2. ä¸ºä»€ä¹ˆéœ€è¦åˆ†é…å™¨ 3. åˆ†é…å™¨æ¶æ„è®¾è®¡ 4. äº”ç§åˆ†é…å™¨å®ç°è¯¦è§£ 5. æ€§èƒ½å¯¹æ¯”ä¸é€‰æ‹© 6. æºç è§£æ 7. æœ€ä½³å®è·µ 8. é—®é¢˜æ’æŸ¥ 9. æ€»ç»“">
<meta property="og:type" content="article">
<meta property="og:title" content="cephä¸­çš„å­˜å‚¨ç©ºé—´åˆ†é…å™¨">
<meta property="og:url" content="https://hoshilzy1026.github.io/2025/09/30/ceph%E4%B8%AD%E7%9A%84%E5%AD%98%E5%82%A8%E7%A9%BA%E9%97%B4%E5%88%86%E9%85%8D%E5%99%A8/index.html">
<meta property="og:site_name" content="Hoshi">
<meta property="og:description" content="Ceph BlueStore åˆ†é…å™¨æ·±åº¦è§£æç›®å½• 1. å¼•è¨€ 2. ä¸ºä»€ä¹ˆéœ€è¦åˆ†é…å™¨ 3. åˆ†é…å™¨æ¶æ„è®¾è®¡ 4. äº”ç§åˆ†é…å™¨å®ç°è¯¦è§£ 5. æ€§èƒ½å¯¹æ¯”ä¸é€‰æ‹© 6. æºç è§£æ 7. æœ€ä½³å®è·µ 8. é—®é¢˜æ’æŸ¥ 9. æ€»ç»“">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-09-30T02:52:47.000Z">
<meta property="article:modified_time" content="2025-10-13T09:56:28.484Z">
<meta property="article:author" content="lzy">
<meta property="article:tag" content="ceph">
<meta property="article:tag" content="seastore">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://hoshilzy1026.github.io/2025/09/30/ceph%E4%B8%AD%E7%9A%84%E5%AD%98%E5%82%A8%E7%A9%BA%E9%97%B4%E5%88%86%E9%85%8D%E5%99%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>cephä¸­çš„å­˜å‚¨ç©ºé—´åˆ†é…å™¨ | Hoshi</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y6XQ2TRE3Y"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-Y6XQ2TRE3Y');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hoshi</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://hoshilzy1026.github.io/2025/09/30/ceph%E4%B8%AD%E7%9A%84%E5%AD%98%E5%82%A8%E7%A9%BA%E9%97%B4%E5%88%86%E9%85%8D%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lzy">
      <meta itemprop="description" content="é€‰æ‹©æœ‰æ—¶å€™æ¯”åŠªåŠ›æ›´é‡è¦">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hoshi">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          cephä¸­çš„å­˜å‚¨ç©ºé—´åˆ†é…å™¨
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-09-30 10:52:47" itemprop="dateCreated datePublished" datetime="2025-09-30T10:52:47+08:00">2025-09-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-10-13 17:56:28" itemprop="dateModified" datetime="2025-10-13T17:56:28+08:00">2025-10-13</time>
              </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>4.2k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>15 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Ceph-BlueStore-åˆ†é…å™¨æ·±åº¦è§£æ"><a href="#Ceph-BlueStore-åˆ†é…å™¨æ·±åº¦è§£æ" class="headerlink" title="Ceph BlueStore åˆ†é…å™¨æ·±åº¦è§£æ"></a>Ceph BlueStore åˆ†é…å™¨æ·±åº¦è§£æ</h1><h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ul>
<li><a href="#1-%E5%BC%95%E8%A8%80">1. å¼•è¨€</a></li>
<li><a href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%88%86%E9%85%8D%E5%99%A8">2. ä¸ºä»€ä¹ˆéœ€è¦åˆ†é…å™¨</a></li>
<li><a href="#3-%E5%88%86%E9%85%8D%E5%99%A8%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1">3. åˆ†é…å™¨æ¶æ„è®¾è®¡</a></li>
<li><a href="#4-%E4%BA%94%E7%A7%8D%E5%88%86%E9%85%8D%E5%99%A8%E5%AE%9E%E7%8E%B0%E8%AF%A6%E8%A7%A3">4. äº”ç§åˆ†é…å™¨å®ç°è¯¦è§£</a></li>
<li><a href="#5-%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E4%B8%8E%E9%80%89%E6%8B%A9">5. æ€§èƒ½å¯¹æ¯”ä¸é€‰æ‹©</a></li>
<li><a href="#6-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90">6. æºç è§£æ</a></li>
<li><a href="#7-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">7. æœ€ä½³å®è·µ</a></li>
<li><a href="#8-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5">8. é—®é¢˜æ’æŸ¥</a></li>
<li><a href="#9-%E6%80%BB%E7%BB%93">9. æ€»ç»“</a></li>
</ul>
<hr>
<span id="more"></span>

<h2 id="1-å¼•è¨€"><a href="#1-å¼•è¨€" class="headerlink" title="1. å¼•è¨€"></a>1. å¼•è¨€</h2><p>åœ¨ Ceph å­˜å‚¨ç³»ç»Ÿä¸­ï¼ŒBlueStore ä½œä¸ºæ–°ä¸€ä»£å¯¹è±¡å­˜å‚¨å¼•æ“ï¼Œç›´æ¥ç®¡ç†è£¸å—è®¾å¤‡ï¼Œæ‘’å¼ƒäº†ä¼ ç»Ÿæ–‡ä»¶ç³»ç»Ÿçš„å¼€é”€ã€‚åœ¨è¿™ç§æ¶æ„ä¸‹ï¼Œ<strong>åˆ†é…å™¨ï¼ˆAllocatorï¼‰</strong> æˆä¸ºäº†è‡³å…³é‡è¦çš„ç»„ä»¶â€”â€”å®ƒè´Ÿè´£ç®¡ç†ç£ç›˜ç©ºé—²ç©ºé—´çš„åˆ†é…å’Œå›æ”¶ï¼Œç›´æ¥å½±å“ç€å­˜å‚¨æ€§èƒ½ã€ç¢ç‰‡åŒ–ç¨‹åº¦å’Œå†…å­˜å ç”¨ã€‚</p>
<p>æœ¬æ–‡å°†æ·±å…¥å‰–æ Ceph åˆ†é…å™¨çš„è®¾è®¡åŸç†ã€å®ç°ç»†èŠ‚å’Œä½¿ç”¨åœºæ™¯ï¼Œå¸®åŠ©ä½ å…¨é¢ç†è§£è¿™ä¸€æ ¸å¿ƒç»„ä»¶ã€‚</p>
<h3 id="æœ¬æ–‡é€‚åˆè°ï¼Ÿ"><a href="#æœ¬æ–‡é€‚åˆè°ï¼Ÿ" class="headerlink" title="æœ¬æ–‡é€‚åˆè°ï¼Ÿ"></a>æœ¬æ–‡é€‚åˆè°ï¼Ÿ</h3><ul>
<li>Ceph è¿ç»´å·¥ç¨‹å¸ˆï¼šäº†è§£å¦‚ä½•é€‰æ‹©å’Œè°ƒä¼˜åˆ†é…å™¨</li>
<li>å­˜å‚¨å¼€å‘è€…ï¼šç†è§£åˆ†é…å™¨çš„è®¾è®¡æ€æƒ³å’Œå®ç°ç»†èŠ‚</li>
<li>ç³»ç»Ÿæ¶æ„å¸ˆï¼šè¯„ä¼°ä¸åŒåˆ†é…å™¨å¯¹ç³»ç»Ÿçš„å½±å“</li>
</ul>
<hr>
<h2 id="2-ä¸ºä»€ä¹ˆéœ€è¦åˆ†é…å™¨"><a href="#2-ä¸ºä»€ä¹ˆéœ€è¦åˆ†é…å™¨" class="headerlink" title="2. ä¸ºä»€ä¹ˆéœ€è¦åˆ†é…å™¨"></a>2. ä¸ºä»€ä¹ˆéœ€è¦åˆ†é…å™¨</h2><h3 id="2-1-BlueStore-çš„å­˜å‚¨æ¶æ„"><a href="#2-1-BlueStore-çš„å­˜å‚¨æ¶æ„" class="headerlink" title="2.1 BlueStore çš„å­˜å‚¨æ¶æ„"></a>2.1 BlueStore çš„å­˜å‚¨æ¶æ„</h3><p>åœ¨ BlueStore ä¸­ï¼Œæ•°æ®æµè½¬è·¯å¾„å¦‚ä¸‹ï¼š</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·å†™å…¥å¯¹è±¡</span><br><span class="line">    â†“</span><br><span class="line"><span class="keyword">BlueStore </span>æ¥æ”¶è¯·æ±‚</span><br><span class="line">    â†“</span><br><span class="line">Allocator åˆ†é…ç£ç›˜ç©ºé—´ â† æœ¬æ–‡é‡ç‚¹</span><br><span class="line">    â†“</span><br><span class="line">å†™å…¥è£¸å—è®¾å¤‡</span><br><span class="line">    â†“</span><br><span class="line">å…ƒæ•°æ®å­˜å‚¨åˆ° RocksDB</span><br></pre></td></tr></table></figure>

<p>BlueStore ç›´æ¥ç®¡ç†è£¸è®¾å¤‡ï¼Œéœ€è¦è‡ªå·±å®ç°ï¼š</p>
<ul>
<li><strong>ç©ºé—²ç©ºé—´ç®¡ç†</strong>ï¼šå“ªäº›ç£ç›˜å—æ˜¯ç©ºé—²çš„ï¼Ÿ</li>
<li><strong>ç©ºé—´åˆ†é…</strong>ï¼šä¸ºæ–°æ•°æ®æ‰¾åˆ°åˆé€‚çš„å­˜å‚¨ä½ç½®</li>
<li><strong>ç©ºé—´å›æ”¶</strong>ï¼šåˆ é™¤æ•°æ®åå›æ”¶ç£ç›˜å—</li>
<li><strong>ç¢ç‰‡ç®¡ç†</strong>ï¼šé¿å…ç£ç›˜ç©ºé—´ç¢ç‰‡åŒ–</li>
</ul>
<p>è¿™å°±æ˜¯åˆ†é…å™¨çš„èŒè´£æ‰€åœ¨ã€‚</p>
<h3 id="2-2-åˆ†é…å™¨çš„æ ¸å¿ƒé—®é¢˜"><a href="#2-2-åˆ†é…å™¨çš„æ ¸å¿ƒé—®é¢˜" class="headerlink" title="2.2 åˆ†é…å™¨çš„æ ¸å¿ƒé—®é¢˜"></a>2.2 åˆ†é…å™¨çš„æ ¸å¿ƒé—®é¢˜</h3><p>åˆ†é…å™¨éœ€è¦è§£å†³ä»¥ä¸‹å…³é”®é—®é¢˜ï¼š</p>
<h4 id="é—®é¢˜-1ï¼šå¦‚ä½•é«˜æ•ˆæŸ¥æ‰¾ç©ºé—²ç©ºé—´ï¼Ÿ"><a href="#é—®é¢˜-1ï¼šå¦‚ä½•é«˜æ•ˆæŸ¥æ‰¾ç©ºé—²ç©ºé—´ï¼Ÿ" class="headerlink" title="é—®é¢˜ 1ï¼šå¦‚ä½•é«˜æ•ˆæŸ¥æ‰¾ç©ºé—²ç©ºé—´ï¼Ÿ"></a>é—®é¢˜ 1ï¼šå¦‚ä½•é«˜æ•ˆæŸ¥æ‰¾ç©ºé—²ç©ºé—´ï¼Ÿ</h4><ul>
<li>å¯¹äº 10TB ç£ç›˜ï¼Œæœ‰æ•°ç™¾ä¸‡ä¸ª 4KB å—</li>
<li>éœ€è¦å¿«é€Ÿæ‰¾åˆ°æ»¡è¶³å¤§å°è¦æ±‚çš„è¿ç»­ç©ºé—´</li>
</ul>
<h4 id="é—®é¢˜-2ï¼šå¦‚ä½•æ§åˆ¶å†…å­˜å ç”¨ï¼Ÿ"><a href="#é—®é¢˜-2ï¼šå¦‚ä½•æ§åˆ¶å†…å­˜å ç”¨ï¼Ÿ" class="headerlink" title="é—®é¢˜ 2ï¼šå¦‚ä½•æ§åˆ¶å†…å­˜å ç”¨ï¼Ÿ"></a>é—®é¢˜ 2ï¼šå¦‚ä½•æ§åˆ¶å†…å­˜å ç”¨ï¼Ÿ</h4><ul>
<li>è®°å½•æ‰€æœ‰ç©ºé—²åŒºé—´éœ€è¦å†…å­˜</li>
<li>ç¢ç‰‡è¶Šå¤šï¼Œå†…å­˜å ç”¨è¶Šå¤§</li>
<li>éœ€è¦åœ¨æ€§èƒ½å’Œå†…å­˜é—´å¹³è¡¡</li>
</ul>
<h4 id="é—®é¢˜-3ï¼šå¦‚ä½•å‡å°‘ç¢ç‰‡ï¼Ÿ"><a href="#é—®é¢˜-3ï¼šå¦‚ä½•å‡å°‘ç¢ç‰‡ï¼Ÿ" class="headerlink" title="é—®é¢˜ 3ï¼šå¦‚ä½•å‡å°‘ç¢ç‰‡ï¼Ÿ"></a>é—®é¢˜ 3ï¼šå¦‚ä½•å‡å°‘ç¢ç‰‡ï¼Ÿ</h4><ul>
<li>éšæœºåˆ†é…å¯¼è‡´ç¢ç‰‡åŒ–</li>
<li>éœ€è¦æ™ºèƒ½çš„åˆ†é…ç­–ç•¥</li>
</ul>
<h4 id="é—®é¢˜-4ï¼šå¦‚ä½•ä¿è¯å¹¶å‘æ€§èƒ½ï¼Ÿ"><a href="#é—®é¢˜-4ï¼šå¦‚ä½•ä¿è¯å¹¶å‘æ€§èƒ½ï¼Ÿ" class="headerlink" title="é—®é¢˜ 4ï¼šå¦‚ä½•ä¿è¯å¹¶å‘æ€§èƒ½ï¼Ÿ"></a>é—®é¢˜ 4ï¼šå¦‚ä½•ä¿è¯å¹¶å‘æ€§èƒ½ï¼Ÿ</h4><ul>
<li>å¤šçº¿ç¨‹å¹¶å‘è¯»å†™</li>
<li>é”ç«äº‰å½±å“æ€§èƒ½</li>
</ul>
<hr>
<h2 id="3-åˆ†é…å™¨æ¶æ„è®¾è®¡"><a href="#3-åˆ†é…å™¨æ¶æ„è®¾è®¡" class="headerlink" title="3. åˆ†é…å™¨æ¶æ„è®¾è®¡"></a>3. åˆ†é…å™¨æ¶æ„è®¾è®¡</h2><h3 id="3-1-æ ¸å¿ƒæ¥å£"><a href="#3-1-æ ¸å¿ƒæ¥å£" class="headerlink" title="3.1 æ ¸å¿ƒæ¥å£"></a>3.1 æ ¸å¿ƒæ¥å£</h3><p>Ceph å®šä¹‰äº†ç»Ÿä¸€çš„åˆ†é…å™¨æ¥å£ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Allocator</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// åˆ†é…æŒ‡å®šå¤§å°çš„ç©ºé—´</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">int64_t</span> <span class="title">allocate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint64_t</span> want_size,      <span class="comment">// æœŸæœ›åˆ†é…çš„å¤§å°</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint64_t</span> alloc_unit,     <span class="comment">// åˆ†é…å•å…ƒï¼ˆé€šå¸¸ 4KBï¼‰</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint64_t</span> max_alloc_size, <span class="comment">// å•ä¸ª extent æœ€å¤§å¤§å°</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int64_t</span> hint,            <span class="comment">// ä½ç½®æç¤ºï¼ˆä¼˜åŒ–å±€éƒ¨æ€§ï¼‰</span></span></span></span><br><span class="line"><span class="params"><span class="function">    PExtentVector *extents   <span class="comment">// [è¾“å‡º] åˆ†é…çš„ç‰©ç† extent åˆ—è¡¨</span></span></span></span><br><span class="line"><span class="params"><span class="function">  )</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é‡Šæ”¾ç©ºé—´</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">release</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> interval_set&lt;<span class="type">uint64_t</span>&gt;&amp; release_set</span></span></span><br><span class="line"><span class="params"><span class="function">  )</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–å¯ç”¨ç©ºé—´å¤§å°</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">uint64_t</span> <span class="title">get_free</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–ç¢ç‰‡ç‡</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">double</span> <span class="title">get_fragmentation</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–æ—¶æ·»åŠ ç©ºé—²ç©ºé—´</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">init_add_free</span><span class="params">(<span class="type">uint64_t</span> offset, <span class="type">uint64_t</span> length)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–æ—¶ç§»é™¤å·²ä½¿ç”¨ç©ºé—´</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">init_rm_free</span><span class="params">(<span class="type">uint64_t</span> offset, <span class="type">uint64_t</span> length)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-å…³é”®æ•°æ®ç»“æ„"><a href="#3-2-å…³é”®æ•°æ®ç»“æ„" class="headerlink" title="3.2 å…³é”®æ•°æ®ç»“æ„"></a>3.2 å…³é”®æ•°æ®ç»“æ„</h3><h4 id="Extentï¼ˆåŒºæ®µï¼‰"><a href="#Extentï¼ˆåŒºæ®µï¼‰" class="headerlink" title="Extentï¼ˆåŒºæ®µï¼‰"></a>Extentï¼ˆåŒºæ®µï¼‰</h4><p>è¡¨ç¤ºä¸€æ®µè¿ç»­çš„ç£ç›˜ç©ºé—´ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">bluestore_pextent_t</span> &#123;</span><br><span class="line">  <span class="type">uint64_t</span> offset;  <span class="comment">// èµ·å§‹åç§»</span></span><br><span class="line">  <span class="type">uint64_t</span> length;  <span class="comment">// é•¿åº¦</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> std::vector&lt;<span class="type">bluestore_pextent_t</span>&gt; PExtentVector;</span><br></pre></td></tr></table></figure>

<h4 id="åˆ†é…ç¤ºä¾‹"><a href="#åˆ†é…ç¤ºä¾‹" class="headerlink" title="åˆ†é…ç¤ºä¾‹"></a>åˆ†é…ç¤ºä¾‹</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ç£ç›˜å¸ƒå±€ï¼š<span class="selector-attr">[å·²ç”¨]</span><span class="selector-attr">[  ç©ºé—²100MB  ]</span><span class="selector-attr">[å·²ç”¨]</span><span class="selector-attr">[  ç©ºé—²50MB  ]</span></span><br><span class="line"></span><br><span class="line">åˆ†é… <span class="number">60</span>MBï¼š</span><br><span class="line">  - æŸ¥æ‰¾ï¼šæ‰¾åˆ° <span class="number">100</span>MB ç©ºé—²å—</span><br><span class="line">  - åˆ†é…ï¼š<span class="selector-attr">[offset: 1000MB, length: 60MB]</span></span><br><span class="line">  - æ›´æ–°ï¼šå‰©ä½™ <span class="selector-attr">[offset: 1060MB, length: 40MB]</span> æ ‡è®°ä¸ºç©ºé—²</span><br></pre></td></tr></table></figure>

<h3 id="3-3-å·¥ä½œæµç¨‹"><a href="#3-3-å·¥ä½œæµç¨‹" class="headerlink" title="3.3 å·¥ä½œæµç¨‹"></a>3.3 å·¥ä½œæµç¨‹</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                      BlueStore                          â”‚</span><br><span class="line">â”‚                                                         â”‚</span><br><span class="line">â”‚  å†™å…¥å¯¹è±¡ â”€â”€â”                                           â”‚</span><br><span class="line">â”‚            â”‚                                            â”‚</span><br><span class="line">â”‚            â†“                                            â”‚</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚</span><br><span class="line">â”‚  â”‚   Allocator      â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚  FreelistManager â”‚     â”‚</span><br><span class="line">â”‚  â”‚                  â”‚        â”‚   (RocksDB)      â”‚     â”‚</span><br><span class="line">â”‚  â”‚ â€¢ å†…å­˜ä¸­ç®¡ç†     â”‚        â”‚  æŒä¹…åŒ–ç©ºé—²ä¿¡æ¯   â”‚     â”‚</span><br><span class="line">â”‚  â”‚ â€¢ å¿«é€Ÿåˆ†é…       â”‚        â”‚                  â”‚     â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚</span><br><span class="line">â”‚            â”‚                                            â”‚</span><br><span class="line">â”‚            â†“                                            â”‚</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚</span><br><span class="line">â”‚  â”‚   Block Device   â”‚                                  â”‚</span><br><span class="line">â”‚  â”‚   (è£¸å—è®¾å¤‡)     â”‚                                  â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>

<p><strong>å…³é”®ç‚¹ï¼š</strong></p>
<ul>
<li><strong>Allocator</strong>ï¼šå†…å­˜ä¸­ç®¡ç†ï¼Œæ€§èƒ½å…³é”®è·¯å¾„</li>
<li><strong>FreelistManager</strong>ï¼šæŒä¹…åŒ–åˆ° RocksDBï¼Œé‡å¯æ—¶æ¢å¤</li>
</ul>
<hr>
<h2 id="4-äº”ç§åˆ†é…å™¨å®ç°è¯¦è§£"><a href="#4-äº”ç§åˆ†é…å™¨å®ç°è¯¦è§£" class="headerlink" title="4. äº”ç§åˆ†é…å™¨å®ç°è¯¦è§£"></a>4. äº”ç§åˆ†é…å™¨å®ç°è¯¦è§£</h2><p>Ceph æä¾›äº† 5 ç§åˆ†é…å™¨å®ç°ï¼Œæ¯ç§éƒ½æœ‰ä¸åŒçš„è®¾è®¡æƒè¡¡ã€‚</p>
<h3 id="4-1-StupidAllocatorï¼ˆç®€å•åˆ†é…å™¨ï¼‰"><a href="#4-1-StupidAllocatorï¼ˆç®€å•åˆ†é…å™¨ï¼‰" class="headerlink" title="4.1 StupidAllocatorï¼ˆç®€å•åˆ†é…å™¨ï¼‰"></a>4.1 StupidAllocatorï¼ˆç®€å•åˆ†é…å™¨ï¼‰</h3><h4 id="è®¾è®¡åŸç†"><a href="#è®¾è®¡åŸç†" class="headerlink" title="è®¾è®¡åŸç†"></a>è®¾è®¡åŸç†</h4><p>StupidAllocator ä½¿ç”¨ <strong>interval_set</strong> ç»“æ„ï¼ŒæŒ‰å¤§å°åˆ†æ¡¶ï¼ˆbinï¼‰ç®¡ç†ç©ºé—²å—ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">StupidAllocator</span> : <span class="keyword">public</span> Allocator &#123;</span><br><span class="line">  <span class="comment">// å¤šä¸ªæ¡¶ï¼ŒæŒ‰ 2 çš„å¹‚æ¬¡åˆ†ç»„</span></span><br><span class="line">  std::vector&lt;<span class="type">interval_set_t</span>&gt; free;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// [0-64KB] â†’ bin 0</span></span><br><span class="line">  <span class="comment">// [64KB-512KB] â†’ bin 1</span></span><br><span class="line">  <span class="comment">// [512KB-4MB] â†’ bin 2</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="åˆ†é…ç­–ç•¥"><a href="#åˆ†é…ç­–ç•¥" class="headerlink" title="åˆ†é…ç­–ç•¥"></a>åˆ†é…ç­–ç•¥</h4><ol>
<li>æ ¹æ®è¯·æ±‚å¤§å°è®¡ç®— bin</li>
<li>ä»å¯¹åº” bin ä¸­æŸ¥æ‰¾</li>
<li>æ‰¾ä¸åˆ°åˆ™å»æ›´å¤§çš„ bin</li>
<li>Simple first-fit ç­–ç•¥</li>
</ol>
<h4 id="ä¼˜ç¼ºç‚¹"><a href="#ä¼˜ç¼ºç‚¹" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h4><p><strong>ä¼˜ç‚¹ï¼š</strong></p>
<ul>
<li>âœ… å®ç°ç®€å•ï¼Œæ˜“äºç†è§£</li>
<li>âœ… å†…å­˜å ç”¨ä¸­ç­‰</li>
</ul>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<ul>
<li>âŒ æ€§èƒ½ä¸€èˆ¬</li>
<li>âŒ ç¢ç‰‡æ§åˆ¶å·®</li>
<li>âŒ ä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> æµ‹è¯•ã€å¼€å‘ç¯å¢ƒ</p>
<hr>
<h3 id="4-2-BitmapAllocatorï¼ˆä½å›¾åˆ†é…å™¨ï¼‰"><a href="#4-2-BitmapAllocatorï¼ˆä½å›¾åˆ†é…å™¨ï¼‰" class="headerlink" title="4.2 BitmapAllocatorï¼ˆä½å›¾åˆ†é…å™¨ï¼‰"></a>4.2 BitmapAllocatorï¼ˆä½å›¾åˆ†é…å™¨ï¼‰</h3><h4 id="è®¾è®¡åŸç†-1"><a href="#è®¾è®¡åŸç†-1" class="headerlink" title="è®¾è®¡åŸç†"></a>è®¾è®¡åŸç†</h4><p>ä½¿ç”¨ <strong>ä½å›¾ï¼ˆBitmapï¼‰</strong> è¡¨ç¤ºæ¯ä¸ªåˆ†é…å•å…ƒçš„çŠ¶æ€ï¼š</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ç£ç›˜åˆ’åˆ†ï¼šæ¯ 4KB ä¸€ä¸ªåˆ†é…å•å…ƒ</span><br><span class="line"></span><br><span class="line">ä½å›¾è¡¨ç¤ºï¼š</span><br><span class="line">Bit:   <span class="number"> 0 </span><span class="number"> 1 </span><span class="number"> 2 </span><span class="number"> 3 </span><span class="number"> 4 </span><span class="number"> 5 </span><span class="number"> 6 </span><span class="number"> 7 </span><span class="number"> 8 </span><span class="number"> 9 </span><span class="number"> 10 </span>11 12</span><br><span class="line">çŠ¶æ€:   å·² ç©º ç©º ç©º å·² å·² ç©º ç©º ç©º ç©º å·² ç©º ç©º</span><br><span class="line">       ç”¨ é—² é—² é—² ç”¨ ç”¨ é—² é—² é—² é—² ç”¨ é—² é—²</span><br><span class="line"></span><br><span class="line">åˆ†é… 16KB (4ä¸ªå•å…ƒ)ï¼š</span><br><span class="line">  - æ‰«æä½å›¾æ‰¾åˆ°è¿ç»­çš„<span class="number"> 4 </span>ä¸ª 1</span><br><span class="line">  - ä½ç½® 6-9 å¯ç”¨</span><br><span class="line">  - æ ‡è®°ä¸ºå·²ç”¨ï¼š...00000111...</span><br></pre></td></tr></table></figure>

<h4 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BitmapAllocator</span> : <span class="keyword">public</span> Allocator,</span><br><span class="line">  <span class="keyword">public</span> AllocatorLevel02&lt;AllocatorLevel01Loose&gt; &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ä¸¤å±‚ä½å›¾ç»“æ„</span></span><br><span class="line">  <span class="comment">// L1: ç²—ç²’åº¦ä½å›¾ï¼ˆæ¯ bit ä»£è¡¨å¤šä¸ª L2 å—ï¼‰</span></span><br><span class="line">  <span class="comment">// L2: ç»†ç²’åº¦ä½å›¾ï¼ˆæ¯ bit ä»£è¡¨ 4KBï¼‰</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="åˆ†é…ç­–ç•¥-1"><a href="#åˆ†é…ç­–ç•¥-1" class="headerlink" title="åˆ†é…ç­–ç•¥"></a>åˆ†é…ç­–ç•¥</h4><ol>
<li>åœ¨ L1 ä½å›¾å¿«é€Ÿå®šä½å¯èƒ½çš„ç©ºé—²åŒºåŸŸ</li>
<li>åœ¨ L2 ä½å›¾ç²¾ç¡®æŸ¥æ‰¾è¿ç»­ç©ºé—²å—</li>
<li>åˆ©ç”¨ä½è¿ç®—åŠ é€ŸæŸ¥æ‰¾</li>
</ol>
<h4 id="ä¼˜ç¼ºç‚¹-1"><a href="#ä¼˜ç¼ºç‚¹-1" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h4><p><strong>ä¼˜ç‚¹ï¼š</strong></p>
<ul>
<li>âœ… <strong>å†…å­˜å ç”¨å¯é¢„æµ‹</strong>ï¼šO(è®¾å¤‡å¤§å°&#x2F;åˆ†é…å•å…ƒ)<ul>
<li>10TB è®¾å¤‡ï¼Œ4KB å•å…ƒ â†’ 320MB å†…å­˜</li>
</ul>
</li>
<li>âœ… <strong>æŸ¥æ‰¾å¿«é€Ÿ</strong>ï¼šä½è¿ç®—é«˜æ•ˆ</li>
<li>âœ… ç¢ç‰‡å¤„ç†å¥½</li>
</ul>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<ul>
<li>âŒ å¤§è®¾å¤‡å†…å­˜å ç”¨é«˜</li>
<li>âŒ åˆå§‹åŒ–æ—¶é—´é•¿</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>âœ… SSD è®¾å¤‡</li>
<li>âœ… å°æ–‡ä»¶è´Ÿè½½</li>
<li>âœ… å†…å­˜å……è¶³åœºæ™¯</li>
</ul>
<hr>
<h3 id="4-3-AvlAllocatorï¼ˆAVL-æ ‘åˆ†é…å™¨ï¼‰"><a href="#4-3-AvlAllocatorï¼ˆAVL-æ ‘åˆ†é…å™¨ï¼‰" class="headerlink" title="4.3 AvlAllocatorï¼ˆAVL æ ‘åˆ†é…å™¨ï¼‰"></a>4.3 AvlAllocatorï¼ˆAVL æ ‘åˆ†é…å™¨ï¼‰</h3><h4 id="è®¾è®¡åŸç†-2"><a href="#è®¾è®¡åŸç†-2" class="headerlink" title="è®¾è®¡åŸç†"></a>è®¾è®¡åŸç†</h4><p>ä½¿ç”¨ <strong>ä¸¤æ£µ AVL æ ‘</strong> ç®¡ç†ç©ºé—²åŒºé—´ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">range_seg_t</span> &#123;</span><br><span class="line">  <span class="type">uint64_t</span> start;  <span class="comment">// èµ·å§‹ä½ç½®</span></span><br><span class="line">  <span class="type">uint64_t</span> end;    <span class="comment">// ç»“æŸä½ç½®</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AvlAllocator</span> : <span class="keyword">public</span> Allocator &#123;</span><br><span class="line">  <span class="comment">// æ ‘ 1ï¼šæŒ‰åç§»é‡æ’åºï¼ˆç”¨äºä½ç½®æŸ¥æ‰¾ï¼‰</span></span><br><span class="line">  avl_set&lt;<span class="type">range_seg_t</span>, by_offset&gt; range_tree;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ ‘ 2ï¼šæŒ‰å¤§å°æ’åºï¼ˆç”¨äºå¤§å°æŸ¥æ‰¾ï¼‰</span></span><br><span class="line">  avl_multiset&lt;<span class="type">range_seg_t</span>, by_size&gt; range_size_tree;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="å¯è§†åŒ–ç¤ºä¾‹"><a href="#å¯è§†åŒ–ç¤ºä¾‹" class="headerlink" title="å¯è§†åŒ–ç¤ºä¾‹"></a>å¯è§†åŒ–ç¤ºä¾‹</h4><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ç©ºé—²åŒºé—´ï¼š<span class="comment">[100MB-200MB]</span> <span class="comment">[500MB-600MB]</span> <span class="comment">[800MB-1000MB]</span></span><br><span class="line"></span><br><span class="line">range_tree (æŒ‰åç§»):</span><br><span class="line">         <span class="comment">[500-600]</span></span><br><span class="line">        /         \</span><br><span class="line">   <span class="comment">[100-200]</span>    <span class="comment">[800-1000]</span></span><br><span class="line"></span><br><span class="line">range_size_tree (æŒ‰å¤§å°):</span><br><span class="line">         <span class="comment">[500-600]</span>  100MB</span><br><span class="line">        /         \</span><br><span class="line">   <span class="comment">[100-200]</span>    <span class="comment">[800-1000]</span></span><br><span class="line">    100MB         200MB</span><br></pre></td></tr></table></figure>

<h4 id="åŠ¨æ€åˆ†é…ç­–ç•¥"><a href="#åŠ¨æ€åˆ†é…ç­–ç•¥" class="headerlink" title="åŠ¨æ€åˆ†é…ç­–ç•¥"></a>åŠ¨æ€åˆ†é…ç­–ç•¥</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç©ºé—´å……è¶³æ—¶ (&gt;1% ç©ºé—²)</span></span><br><span class="line"><span class="keyword">if</span> (free_space_pct &gt; threshold) &#123;</span><br><span class="line">  <span class="comment">// First-Fitï¼šæŒ‰åç§»æŸ¥æ‰¾</span></span><br><span class="line">  <span class="comment">// ä¼˜ç‚¹ï¼šå‡å°‘ç¢ç‰‡ï¼Œæé«˜å±€éƒ¨æ€§</span></span><br><span class="line">  <span class="built_in">search_by_offset</span>(range_tree, cursor);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç©ºé—´ç´§å¼ æ—¶</span></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// Best-Fitï¼šæŒ‰å¤§å°æŸ¥æ‰¾</span></span><br><span class="line">  <span class="comment">// ä¼˜ç‚¹ï¼šæé«˜ç©ºé—´åˆ©ç”¨ç‡</span></span><br><span class="line">  <span class="built_in">search_by_size</span>(range_size_tree, want_size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ä¼˜ç¼ºç‚¹-2"><a href="#ä¼˜ç¼ºç‚¹-2" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h4><p><strong>ä¼˜ç‚¹ï¼š</strong></p>
<ul>
<li>âœ… <strong>åŠ¨æ€ç­–ç•¥</strong>ï¼šæ ¹æ®ç©ºé—²åº¦è‡ªåŠ¨è°ƒæ•´</li>
<li>âœ… <strong>æ€§èƒ½å‡è¡¡</strong>ï¼šO(log N) æŸ¥æ‰¾æ—¶é—´</li>
<li>âœ… <strong>ç¢ç‰‡æ§åˆ¶å¥½</strong></li>
<li>âœ… <strong>ç”Ÿäº§ç¯å¢ƒæ¨è</strong></li>
</ul>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<ul>
<li>âŒ <strong>å†…å­˜ä¸å¯æ§</strong>ï¼šç¢ç‰‡å¤šæ—¶å ç”¨é«˜<ul>
<li>æç«¯æƒ…å†µï¼šæ•°ç™¾ä¸‡ä¸ªå°ç©ºé—²å— â†’ æ•° GB å†…å­˜</li>
</ul>
</li>
<li>âŒ é«˜ç¢ç‰‡ä¸‹æ€§èƒ½ä¸‹é™</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>âœ… é€šç”¨åœºæ™¯</li>
<li>âœ… ç¢ç‰‡å¯æ§ç¯å¢ƒ</li>
<li>âœ… ä¸­ç­‰è§„æ¨¡è®¾å¤‡</li>
</ul>
<hr>
<h3 id="4-4-BtreeAllocatorï¼ˆB-æ ‘åˆ†é…å™¨ï¼‰"><a href="#4-4-BtreeAllocatorï¼ˆB-æ ‘åˆ†é…å™¨ï¼‰" class="headerlink" title="4.4 BtreeAllocatorï¼ˆB æ ‘åˆ†é…å™¨ï¼‰"></a>4.4 BtreeAllocatorï¼ˆB æ ‘åˆ†é…å™¨ï¼‰</h3><h4 id="è®¾è®¡åŸç†-3"><a href="#è®¾è®¡åŸç†-3" class="headerlink" title="è®¾è®¡åŸç†"></a>è®¾è®¡åŸç†</h4><p>ä¸ AvlAllocator ç±»ä¼¼ï¼Œä½†ä½¿ç”¨ <strong>B-tree</strong> æ›¿ä»£ AVL æ ‘ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BtreeAllocator</span> : <span class="keyword">public</span> Allocator &#123;</span><br><span class="line">  <span class="comment">// ä½¿ç”¨ B-tree ç»“æ„</span></span><br><span class="line">  btree::btree_map&lt;<span class="type">uint64_t</span>, <span class="type">range_seg_t</span>&gt; range_tree;</span><br><span class="line">  btree::btree_multimap&lt;<span class="type">uint64_t</span>, <span class="type">range_seg_t</span>&gt; range_size_tree;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="B-tree-vs-AVL"><a href="#B-tree-vs-AVL" class="headerlink" title="B-tree vs AVL"></a>B-tree vs AVL</h4><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">AVL</span> <span class="selector-tag">Tree</span> (äºŒå‰æ ‘):</span><br><span class="line">       <span class="selector-attr">[50]</span></span><br><span class="line">      /    \</span><br><span class="line">   <span class="selector-attr">[30]</span>    <span class="selector-attr">[70]</span></span><br><span class="line">   /  \    /  \</span><br><span class="line"><span class="selector-attr">[20]</span><span class="selector-attr">[40]</span><span class="selector-attr">[60]</span><span class="selector-attr">[80]</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">B</span><span class="selector-tag">-tree</span> (å¤šå‰æ ‘):</span><br><span class="line">    <span class="selector-attr">[30 | 60]</span></span><br><span class="line">    /    |    \</span><br><span class="line"><span class="selector-attr">[10,20]</span><span class="selector-attr">[40,50]</span><span class="selector-attr">[70,80,90]</span></span><br></pre></td></tr></table></figure>

<h4 id="ä¼˜ç¼ºç‚¹-3"><a href="#ä¼˜ç¼ºç‚¹-3" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h4><p><strong>ä¼˜ç‚¹ï¼š</strong></p>
<ul>
<li>âœ… <strong>æ›´å¥½çš„ç¼“å­˜å±€éƒ¨æ€§</strong>ï¼šèŠ‚ç‚¹å­˜å‚¨å¤šä¸ªå…ƒç´ </li>
<li>âœ… æ ‘é«˜åº¦æ›´ä½ï¼šå‡å°‘æŒ‡é’ˆè·³è½¬</li>
<li>âœ… å¤§è§„æ¨¡æ•°æ®æ€§èƒ½å¥½</li>
</ul>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<ul>
<li>âŒ å®ç°å¤æ‚</li>
<li>âŒ å°è§„æ¨¡æ•°æ®å¼€é”€å¤§</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>âœ… å¤§å‹è®¾å¤‡ï¼ˆ&gt;10TBï¼‰</li>
<li>âœ… é«˜ç¢ç‰‡åœºæ™¯</li>
</ul>
<hr>
<h3 id="4-5-HybridAllocatorï¼ˆæ··åˆåˆ†é…å™¨ï¼‰â­-æ¨è"><a href="#4-5-HybridAllocatorï¼ˆæ··åˆåˆ†é…å™¨ï¼‰â­-æ¨è" class="headerlink" title="4.5 HybridAllocatorï¼ˆæ··åˆåˆ†é…å™¨ï¼‰â­ æ¨è"></a>4.5 HybridAllocatorï¼ˆæ··åˆåˆ†é…å™¨ï¼‰â­ æ¨è</h3><h4 id="è®¾è®¡åŸç†-4"><a href="#è®¾è®¡åŸç†-4" class="headerlink" title="è®¾è®¡åŸç†"></a>è®¾è®¡åŸç†</h4><p><strong>ç»“åˆ AVL å’Œ Bitmap çš„ä¼˜åŠ¿</strong>ï¼Œæ§åˆ¶å†…å­˜å ç”¨ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HybridAllocator</span> : <span class="keyword">public</span> AvlAllocator &#123;</span><br><span class="line">  <span class="type">uint64_t</span> max_mem;        <span class="comment">// å†…å­˜ä¸Šé™</span></span><br><span class="line">  BitmapAllocator* bitmap; <span class="comment">// æº¢å‡ºå­˜å‚¨</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">virtual</span> <span class="type">void</span> _spillover_range(<span class="type">uint64_t</span> start, <span class="type">uint64_t</span> end) <span class="keyword">override</span> &#123;</span><br><span class="line">    <span class="comment">// å½“ AVL æ ‘è¶…è¿‡å†…å­˜é™åˆ¶æ—¶</span></span><br><span class="line">    <span class="comment">// å°†æœ€å°çš„ç©ºé—²å—æº¢å‡ºåˆ° Bitmap</span></span><br><span class="line">    bitmap-&gt;<span class="built_in">init_add_free</span>(start, end);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="å·¥ä½œæµç¨‹"><a href="#å·¥ä½œæµç¨‹" class="headerlink" title="å·¥ä½œæµç¨‹"></a>å·¥ä½œæµç¨‹</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚           HybridAllocator                   â”‚</span><br><span class="line">â”‚                                             â”‚</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚</span><br><span class="line">â”‚  â”‚   AVL Tree (in-memory)  â”‚               â”‚</span><br><span class="line">â”‚  â”‚   å­˜å‚¨å¤§ç©ºé—²å—           â”‚  å†…å­˜ &lt; <span class="number">256</span>MB â”‚</span><br><span class="line">â”‚  â”‚   <span class="selector-attr">[1GB-2GB]</span>             â”‚               â”‚</span><br><span class="line">â”‚  â”‚   <span class="selector-attr">[5GB-6GB]</span>             â”‚               â”‚</span><br><span class="line">â”‚  â”‚   ...                   â”‚               â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚</span><br><span class="line">â”‚              â†“ æº¢å‡º                         â”‚</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚</span><br><span class="line">â”‚  â”‚   Bitmap (spillover)    â”‚               â”‚</span><br><span class="line">â”‚  â”‚   å­˜å‚¨å°ç¢ç‰‡å—           â”‚               â”‚</span><br><span class="line">â”‚  â”‚   <span class="selector-attr">[4KB]</span> <span class="selector-attr">[8KB]</span> <span class="selector-attr">[12KB]</span>... â”‚               â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line">åˆ†é…é€»è¾‘ï¼š</span><br><span class="line"><span class="number">1</span>. ä¼˜å…ˆä» AVL æ ‘åˆ†é…ï¼ˆå¿«é€Ÿï¼‰</span><br><span class="line"><span class="number">2</span>. æ‰¾ä¸åˆ°åˆ™æŸ¥è¯¢ Bitmap</span><br><span class="line"><span class="number">3</span>. å®šæœŸæ•´ç†ï¼šBitmap ä¸­å¤§å—åˆå¹¶å› AVL</span><br></pre></td></tr></table></figure>

<h4 id="å†…å­˜æ§åˆ¶ç­–ç•¥"><a href="#å†…å­˜æ§åˆ¶ç­–ç•¥" class="headerlink" title="å†…å­˜æ§åˆ¶ç­–ç•¥"></a>å†…å­˜æ§åˆ¶ç­–ç•¥</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é…ç½®ï¼šæœ€å¤§ 256MB</span></span><br><span class="line">bluestore_hybrid_alloc_mem_cap = <span class="number">268435456</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“ AVL æ ‘è¾¾åˆ°å®¹é‡é™åˆ¶</span></span><br><span class="line"><span class="keyword">if</span> (range_tree.<span class="built_in">size</span>() &gt;= max_ranges) &#123;</span><br><span class="line">  <span class="comment">// ç§»é™¤æœ€å°çš„ç©ºé—²å—åˆ° Bitmap</span></span><br><span class="line">  <span class="keyword">auto</span> smallest = range_size_tree.<span class="built_in">begin</span>();</span><br><span class="line">  <span class="built_in">spillover_to_bitmap</span>(smallest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ä¼˜ç¼ºç‚¹-4"><a href="#ä¼˜ç¼ºç‚¹-4" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h4><p><strong>ä¼˜ç‚¹ï¼š</strong></p>
<ul>
<li>âœ… <strong>å†…å­˜å¯æ§</strong>ï¼šè®¾ç½®ä¸Šé™ï¼Œå¯é¢„æµ‹</li>
<li>âœ… <strong>æ€§èƒ½ä¼˜ç§€</strong>ï¼šå¤§å—åˆ†é…å¿«é€Ÿï¼ˆAVLï¼‰</li>
<li>âœ… <strong>ç¢ç‰‡å¤„ç†å¥½</strong>ï¼šå°ç¢ç‰‡äº¤ç»™ Bitmap</li>
<li>âœ… <strong>ç”Ÿäº§ç¯å¢ƒé¦–é€‰</strong> â­â­â­</li>
</ul>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<ul>
<li>âŒ å®ç°æœ€å¤æ‚</li>
<li>âŒ éœ€è¦è°ƒä¼˜å‚æ•°</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>âœ… <strong>æ‰€æœ‰ç”Ÿäº§ç¯å¢ƒ</strong> ğŸ†</li>
<li>âœ… å¤§è§„æ¨¡éƒ¨ç½²</li>
<li>âœ… æ··åˆè´Ÿè½½</li>
</ul>
<hr>
<h2 id="5-æ€§èƒ½å¯¹æ¯”ä¸é€‰æ‹©"><a href="#5-æ€§èƒ½å¯¹æ¯”ä¸é€‰æ‹©" class="headerlink" title="5. æ€§èƒ½å¯¹æ¯”ä¸é€‰æ‹©"></a>5. æ€§èƒ½å¯¹æ¯”ä¸é€‰æ‹©</h2><h3 id="5-1-ç»¼åˆå¯¹æ¯”è¡¨"><a href="#5-1-ç»¼åˆå¯¹æ¯”è¡¨" class="headerlink" title="5.1 ç»¼åˆå¯¹æ¯”è¡¨"></a>5.1 ç»¼åˆå¯¹æ¯”è¡¨</h3><table>
<thead>
<tr>
<th>åˆ†é…å™¨</th>
<th>å†…å­˜å ç”¨</th>
<th>åˆ†é…é€Ÿåº¦</th>
<th>ç¢ç‰‡å¤„ç†</th>
<th>å¤æ‚åº¦</th>
<th>ç”Ÿäº§æ¨è</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Stupid</strong></td>
<td>ä¸­ç­‰</td>
<td>â­â­</td>
<td>â­â­</td>
<td>ç®€å•</td>
<td>âŒ ä»…æµ‹è¯•</td>
</tr>
<tr>
<td><strong>Bitmap</strong></td>
<td>å›ºå®šï¼ˆé«˜ï¼‰</td>
<td>â­â­â­â­</td>
<td>â­â­â­â­</td>
<td>ä¸­ç­‰</td>
<td>âœ… SSD</td>
</tr>
<tr>
<td><strong>AVL</strong></td>
<td>åŠ¨æ€</td>
<td>â­â­â­</td>
<td>â­â­â­â­</td>
<td>ä¸­ç­‰</td>
<td>âœ… é€šç”¨</td>
</tr>
<tr>
<td><strong>Btree</strong></td>
<td>åŠ¨æ€</td>
<td>â­â­â­</td>
<td>â­â­â­â­</td>
<td>é«˜</td>
<td>âœ… å¤§è®¾å¤‡</td>
</tr>
<tr>
<td><strong>Hybrid</strong></td>
<td>å¯æ§</td>
<td>â­â­â­â­â­</td>
<td>â­â­â­â­â­</td>
<td>é«˜</td>
<td>âœ…âœ… é¦–é€‰</td>
</tr>
</tbody></table>
<h3 id="5-2-é€‰æ‹©å»ºè®®"><a href="#5-2-é€‰æ‹©å»ºè®®" class="headerlink" title="5.2 é€‰æ‹©å»ºè®®"></a>5.2 é€‰æ‹©å»ºè®®</h3><h4 id="å†³ç­–æ ‘"><a href="#å†³ç­–æ ‘" class="headerlink" title="å†³ç­–æ ‘"></a>å†³ç­–æ ‘</h4><figure class="highlight tp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">å¼€å§‹</span><br><span class="line"> â”‚</span><br><span class="line"> â”œâ”€ æµ‹è¯•/å¼€å‘ç¯å¢ƒï¼Ÿ</span><br><span class="line"> â”‚   â””â”€ æ˜¯ â†’ StupidAllocator</span><br><span class="line"> â”‚</span><br><span class="line"> â”œâ”€ å†…å­˜ä¸¥æ ¼å—é™ï¼Ÿ</span><br><span class="line"> â”‚   â””â”€ æ˜¯ â†’ HybridAllocator (è®¾ç½® mem_cap)</span><br><span class="line"> â”‚</span><br><span class="line"> â”œâ”€ è®¾å¤‡ç±»å‹ï¼Ÿ</span><br><span class="line"> â”‚   â”œâ”€ SSD + å°æ–‡ä»¶è´Ÿè½½ â†’ BitmapAllocator</span><br><span class="line"> â”‚   â”œâ”€ å¤§è®¾å¤‡ (&gt;<span class="number">20</span><span class="keyword">TB</span>) â†’ BtreeAllocator</span><br><span class="line"> â”‚   â””â”€ å…¶ä»– â†’ HybridAllocator â­</span><br><span class="line"> â”‚</span><br><span class="line"> â””â”€ ä¸ç¡®å®šï¼Ÿâ†’ HybridAllocator (é»˜è®¤æ¨è)</span><br></pre></td></tr></table></figure>

<h4 id="åœºæ™¯æ¨è"><a href="#åœºæ™¯æ¨è" class="headerlink" title="åœºæ™¯æ¨è"></a>åœºæ™¯æ¨è</h4><p><strong>åœºæ™¯ 1ï¼šé«˜æ€§èƒ½ SSD é›†ç¾¤</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bluestore_allocator = hybrid</span><br><span class="line">bluestore_hybrid_alloc_mem_cap = 536870912  <span class="comment"># 512MB</span></span><br></pre></td></tr></table></figure>

<p><strong>åœºæ™¯ 2ï¼šHDD å¤§å®¹é‡å­˜å‚¨</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bluestore_allocator = btree</span><br></pre></td></tr></table></figure>

<p><strong>åœºæ™¯ 3ï¼šå†…å­˜å—é™ç¯å¢ƒ</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bluestore_allocator = hybrid</span><br><span class="line">bluestore_hybrid_alloc_mem_cap = 134217728  <span class="comment"># 128MB</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-æºç è§£æ"><a href="#6-æºç è§£æ" class="headerlink" title="6. æºç è§£æ"></a>6. æºç è§£æ</h2><h3 id="6-1-æ ¸å¿ƒåˆ†é…æµç¨‹"><a href="#6-1-æ ¸å¿ƒåˆ†é…æµç¨‹" class="headerlink" title="6.1 æ ¸å¿ƒåˆ†é…æµç¨‹"></a>6.1 æ ¸å¿ƒåˆ†é…æµç¨‹</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/os/bluestore/BlueStore.cc</span></span><br><span class="line"><span class="type">int</span> BlueStore::_do_alloc_write(</span><br><span class="line">    TransContext *txc,</span><br><span class="line">    CollectionRef&amp; c,</span><br><span class="line">    OnodeRef o,</span><br><span class="line">    BlueStore::WriteContext *wctx)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint64_t</span> need = wctx-&gt;logical_length;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 1. è°ƒç”¨åˆ†é…å™¨åˆ†é…ç©ºé—´</span></span><br><span class="line">  PExtentVector extents;</span><br><span class="line">  <span class="type">int64_t</span> got = alloc-&gt;<span class="built_in">allocate</span>(</span><br><span class="line">    need,                    <span class="comment">// éœ€è¦çš„å¤§å°</span></span><br><span class="line">    min_alloc_size,          <span class="comment">// æœ€å°åˆ†é…å•å…ƒ (4KB)</span></span><br><span class="line">    need,                    <span class="comment">// æœ€å¤§åˆ†é…å¤§å°</span></span><br><span class="line">    <span class="number">0</span>,                       <span class="comment">// hint (ä½ç½®æç¤º)</span></span><br><span class="line">    &amp;extents                 <span class="comment">// è¾“å‡ºï¼šåˆ†é…çš„ extent åˆ—è¡¨</span></span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (got &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ†é…å¤±è´¥</span></span><br><span class="line">    <span class="keyword">return</span> got;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 2. å†™å…¥æ•°æ®åˆ°åˆ†é…çš„ç‰©ç†ä½ç½®</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; p : extents) &#123;</span><br><span class="line">    r = bdev-&gt;<span class="built_in">aio_write</span>(</span><br><span class="line">      p.offset,              <span class="comment">// ç‰©ç†åç§»</span></span><br><span class="line">      bl,                    <span class="comment">// æ•°æ®</span></span><br><span class="line">      &amp;txc-&gt;ioc,            <span class="comment">// IO ä¸Šä¸‹æ–‡</span></span><br><span class="line">      <span class="literal">false</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 3. æ›´æ–°å…ƒæ•°æ®</span></span><br><span class="line">  o-&gt;extent_map.<span class="built_in">punch_hole</span>(offset, length);</span><br><span class="line">  o-&gt;extent_map.<span class="built_in">add_extent</span>(offset, extents);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-AVL-åˆ†é…å™¨æ ¸å¿ƒä»£ç "><a href="#6-2-AVL-åˆ†é…å™¨æ ¸å¿ƒä»£ç " class="headerlink" title="6.2 AVL åˆ†é…å™¨æ ¸å¿ƒä»£ç "></a>6.2 AVL åˆ†é…å™¨æ ¸å¿ƒä»£ç </h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/os/bluestore/AvlAllocator.cc</span></span><br><span class="line"><span class="type">int64_t</span> AvlAllocator::_allocate(</span><br><span class="line">    <span class="type">uint64_t</span> want,</span><br><span class="line">    <span class="type">uint64_t</span> unit,</span><br><span class="line">    <span class="type">uint64_t</span> max_alloc_size,</span><br><span class="line">    <span class="type">int64_t</span>  hint,</span><br><span class="line">    PExtentVector *extents)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">l</span><span class="params">(lock)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="type">uint64_t</span> allocated = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> (allocated &lt; want) &#123;</span><br><span class="line">    <span class="type">uint64_t</span> offset, length;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é€‰æ‹©åˆ†é…ç­–ç•¥</span></span><br><span class="line">    <span class="keyword">if</span> (_use_first_fit()) &#123;</span><br><span class="line">      <span class="comment">// First-fit: æŒ‰åç§»æŸ¥æ‰¾ï¼ˆå‡å°‘ç¢ç‰‡ï¼‰</span></span><br><span class="line">      offset = _pick_block_after(&amp;cursor, want - allocated, unit);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Best-fit: æŒ‰å¤§å°æŸ¥æ‰¾ï¼ˆæé«˜åˆ©ç”¨ç‡ï¼‰</span></span><br><span class="line">      offset = _pick_block_fits(want - allocated, unit);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (offset == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">break</span>;  <span class="comment">// æ‰¾ä¸åˆ°åˆé€‚çš„å—</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»æ ‘ä¸­ç§»é™¤åˆ†é…çš„åŒºé—´</span></span><br><span class="line">    _remove_from_tree(offset, length);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®°å½•åˆ†é…ç»“æœ</span></span><br><span class="line">    extents-&gt;<span class="built_in">emplace_back</span>(offset, length);</span><br><span class="line">    allocated += length;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> allocated;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒ‰å¤§å°æŸ¥æ‰¾</span></span><br><span class="line"><span class="type">uint64_t</span> AvlAllocator::_pick_block_fits(<span class="type">uint64_t</span> size, <span class="type">uint64_t</span> align)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// åœ¨ range_size_tree ä¸­æŸ¥æ‰¾ &gt;= size çš„æœ€å°å—</span></span><br><span class="line">  <span class="function"><span class="type">range_seg_t</span> <span class="title">search_node</span><span class="params">(<span class="number">0</span>, size)</span></span>;</span><br><span class="line">  <span class="keyword">auto</span> rs_it = range_size_tree.<span class="built_in">lower_bound</span>(search_node);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (rs_it == range_size_tree.<span class="built_in">end</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// æ²¡æœ‰è¶³å¤Ÿå¤§çš„å—</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="type">uint64_t</span> offset = <span class="built_in">p2roundup</span>(rs_it-&gt;start, align);</span><br><span class="line">  <span class="keyword">return</span> offset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-åˆ†é…å™¨åˆ›å»º"><a href="#6-3-åˆ†é…å™¨åˆ›å»º" class="headerlink" title="6.3 åˆ†é…å™¨åˆ›å»º"></a>6.3 åˆ†é…å™¨åˆ›å»º</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/os/bluestore/Allocator.cc</span></span><br><span class="line"><span class="function">Allocator *<span class="title">Allocator::create</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    CephContext* cct,</span></span></span><br><span class="line"><span class="params"><span class="function">    std::string_view type,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int64_t</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int64_t</span> block_size,</span></span></span><br><span class="line"><span class="params"><span class="function">    std::string_view name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Allocator* alloc = <span class="literal">nullptr</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (type == <span class="string">&quot;stupid&quot;</span>) &#123;</span><br><span class="line">    alloc = <span class="keyword">new</span> <span class="built_in">StupidAllocator</span>(cct, size, block_size, name);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="string">&quot;bitmap&quot;</span>) &#123;</span><br><span class="line">    alloc = <span class="keyword">new</span> <span class="built_in">BitmapAllocator</span>(cct, size, block_size, name);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="string">&quot;avl&quot;</span>) &#123;</span><br><span class="line">    alloc = <span class="keyword">new</span> <span class="built_in">AvlAllocator</span>(cct, size, block_size, name);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="string">&quot;btree&quot;</span>) &#123;</span><br><span class="line">    alloc = <span class="keyword">new</span> <span class="built_in">BtreeAllocator</span>(cct, size, block_size, name);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="string">&quot;hybrid&quot;</span>) &#123;</span><br><span class="line">    <span class="type">uint64_t</span> mem_cap = cct-&gt;_conf.<span class="built_in">get_val</span>&lt;<span class="type">uint64_t</span>&gt;(</span><br><span class="line">      <span class="string">&quot;bluestore_hybrid_alloc_mem_cap&quot;</span></span><br><span class="line">    );</span><br><span class="line">    alloc = <span class="keyword">new</span> <span class="built_in">HybridAllocator</span>(cct, size, block_size, mem_cap, name);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> alloc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-æœ€ä½³å®è·µ"><a href="#7-æœ€ä½³å®è·µ" class="headerlink" title="7. æœ€ä½³å®è·µ"></a>7. æœ€ä½³å®è·µ</h2><h3 id="7-1-é…ç½®ä¼˜åŒ–"><a href="#7-1-é…ç½®ä¼˜åŒ–" class="headerlink" title="7.1 é…ç½®ä¼˜åŒ–"></a>7.1 é…ç½®ä¼˜åŒ–</h3><h4 id="åŸºç¡€é…ç½®"><a href="#åŸºç¡€é…ç½®" class="headerlink" title="åŸºç¡€é…ç½®"></a>åŸºç¡€é…ç½®</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ceph.conf</span></span><br><span class="line"></span><br><span class="line"><span class="section">[osd]</span></span><br><span class="line"><span class="comment"># é€‰æ‹©åˆ†é…å™¨ç±»å‹</span></span><br><span class="line"><span class="attr">bluestore_allocator</span> = hybrid</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hybrid åˆ†é…å™¨å†…å­˜ä¸Šé™ (256MB)</span></span><br><span class="line"><span class="attr">bluestore_hybrid_alloc_mem_cap</span> = <span class="number">268435456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ€å°åˆ†é…å•å…ƒ (HDD: 64KB, SSD: 4KB)</span></span><br><span class="line"><span class="attr">bluestore_min_alloc_size_hdd</span> = <span class="number">65536</span></span><br><span class="line"><span class="attr">bluestore_min_alloc_size_ssd</span> = <span class="number">4096</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># AVL åˆ†é…å™¨å‚æ•°</span></span><br><span class="line"><span class="attr">bluestore_avl_alloc_ff_max_search_count</span> = <span class="number">100</span></span><br><span class="line"><span class="attr">bluestore_avl_alloc_ff_max_search_bytes</span> = <span class="number">1048576</span></span><br></pre></td></tr></table></figure>

<h4 id="é«˜æ€§èƒ½-SSD-é…ç½®"><a href="#é«˜æ€§èƒ½-SSD-é…ç½®" class="headerlink" title="é«˜æ€§èƒ½ SSD é…ç½®"></a>é«˜æ€§èƒ½ SSD é…ç½®</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[osd]</span></span><br><span class="line"><span class="attr">bluestore_allocator</span> = hybrid</span><br><span class="line"><span class="attr">bluestore_hybrid_alloc_mem_cap</span> = <span class="number">536870912</span>  <span class="comment"># 512MB</span></span><br><span class="line"><span class="attr">bluestore_min_alloc_size_ssd</span> = <span class="number">4096</span></span><br></pre></td></tr></table></figure>

<h4 id="å¤§å®¹é‡-HDD-é…ç½®"><a href="#å¤§å®¹é‡-HDD-é…ç½®" class="headerlink" title="å¤§å®¹é‡ HDD é…ç½®"></a>å¤§å®¹é‡ HDD é…ç½®</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[osd]</span></span><br><span class="line"><span class="attr">bluestore_allocator</span> = btree</span><br><span class="line"><span class="attr">bluestore_min_alloc_size_hdd</span> = <span class="number">65536</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-ç›‘æ§æŒ‡æ ‡"><a href="#7-2-ç›‘æ§æŒ‡æ ‡" class="headerlink" title="7.2 ç›‘æ§æŒ‡æ ‡"></a>7.2 ç›‘æ§æŒ‡æ ‡</h3><h4 id="æŸ¥çœ‹åˆ†é…å™¨çŠ¶æ€"><a href="#æŸ¥çœ‹åˆ†é…å™¨çŠ¶æ€" class="headerlink" title="æŸ¥çœ‹åˆ†é…å™¨çŠ¶æ€"></a>æŸ¥çœ‹åˆ†é…å™¨çŠ¶æ€</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ OSD åˆ†é…å™¨ä¿¡æ¯</span></span><br><span class="line">ceph daemon osd.0 bluestore allocator dump</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºç¤ºä¾‹</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;allocator_type&quot;</span>: <span class="string">&quot;hybrid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;capacity&quot;</span>: 10737418240,</span><br><span class="line">    <span class="string">&quot;alloc_unit&quot;</span>: 4096,</span><br><span class="line">    <span class="string">&quot;alloc_size_min&quot;</span>: 4096,</span><br><span class="line">    <span class="string">&quot;free&quot;</span>: 8589934592,</span><br><span class="line">    <span class="string">&quot;fragmentation&quot;</span>: 0.15,</span><br><span class="line">    <span class="string">&quot;num_free_ranges&quot;</span>: 12450</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å…³é”®æŒ‡æ ‡"><a href="#å…³é”®æŒ‡æ ‡" class="headerlink" title="å…³é”®æŒ‡æ ‡"></a>å…³é”®æŒ‡æ ‡</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¢ç‰‡ç‡</span></span><br><span class="line">fragmentation_score = num_free_ranges / (free_blocks - 1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç©ºé—´åˆ©ç”¨ç‡</span></span><br><span class="line">utilization = (capacity - free) / capacity</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†é…æˆåŠŸç‡</span></span><br><span class="line">alloc_success_rate = allocated / requested</span><br></pre></td></tr></table></figure>

<h4 id="Prometheus-ç›‘æ§"><a href="#Prometheus-ç›‘æ§" class="headerlink" title="Prometheus ç›‘æ§"></a>Prometheus ç›‘æ§</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ ç›‘æ§å‘Šè­¦</span></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ceph_allocator</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># ç¢ç‰‡ç‡è¿‡é«˜</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighFragmentation</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">ceph_bluestore_fragmentation</span> <span class="string">&gt;</span> <span class="number">0.3</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">10m</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;OSD <span class="template-variable">&#123;&#123; $labels.osd &#125;&#125;</span> fragmentation high&quot;</span></span><br><span class="line">      </span><br><span class="line">  <span class="comment"># å¯ç”¨ç©ºé—´ä¸è¶³</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">LowFreeSpace</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">ceph_bluestore_free_bytes</span> <span class="string">/</span> <span class="string">ceph_bluestore_capacity_bytes</span> <span class="string">&lt;</span> <span class="number">0.1</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br></pre></td></tr></table></figure>

<h3 id="7-3-æ€§èƒ½è°ƒä¼˜"><a href="#7-3-æ€§èƒ½è°ƒä¼˜" class="headerlink" title="7.3 æ€§èƒ½è°ƒä¼˜"></a>7.3 æ€§èƒ½è°ƒä¼˜</h3><h4 id="è°ƒä¼˜æ­¥éª¤"><a href="#è°ƒä¼˜æ­¥éª¤" class="headerlink" title="è°ƒä¼˜æ­¥éª¤"></a>è°ƒä¼˜æ­¥éª¤</h4><p><strong>1. åŸºçº¿æµ‹è¯•</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ fio æµ‹è¯•åŸºçº¿æ€§èƒ½</span></span><br><span class="line">fio --name=<span class="built_in">test</span> --ioengine=libaio --direct=1 \</span><br><span class="line">    --bs=4k --rw=randwrite --numjobs=4 \</span><br><span class="line">    --size=10G --runtime=300</span><br></pre></td></tr></table></figure>

<p><strong>2. è°ƒæ•´åˆ†é…å™¨</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹é…ç½®</span></span><br><span class="line">ceph config <span class="built_in">set</span> osd.* bluestore_allocator hybrid</span><br><span class="line">ceph config <span class="built_in">set</span> osd.* bluestore_hybrid_alloc_mem_cap 536870912</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯ OSD</span></span><br><span class="line">systemctl restart ceph-osd@0</span><br></pre></td></tr></table></figure>

<p><strong>3. å‹åŠ›æµ‹è¯•</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RBD æµ‹è¯•</span></span><br><span class="line">rbd bench --io-type write --io-size 4K --io-pattern rand test-pool/test-image</span><br><span class="line"></span><br><span class="line"><span class="comment"># RADOS æµ‹è¯•</span></span><br><span class="line">rados bench -p test-pool 300 write -t 32</span><br></pre></td></tr></table></figure>

<p><strong>4. å¯¹æ¯”ç»“æœ</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡</span></span><br><span class="line">ceph osd perf</span><br><span class="line">ceph daemon osd.0 perf dump</span><br></pre></td></tr></table></figure>

<h4 id="å¸¸è§é—®é¢˜è°ƒä¼˜"><a href="#å¸¸è§é—®é¢˜è°ƒä¼˜" class="headerlink" title="å¸¸è§é—®é¢˜è°ƒä¼˜"></a>å¸¸è§é—®é¢˜è°ƒä¼˜</h4><p><strong>é—®é¢˜ 1ï¼šåˆ†é…å»¶è¿Ÿé«˜</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç—‡çŠ¶ï¼šapply_latency å’Œ commit_latency é«˜</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹æ¡ˆ 1ï¼šå¢åŠ å†…å­˜ä¸Šé™</span></span><br><span class="line">ceph config <span class="built_in">set</span> osd.* bluestore_hybrid_alloc_mem_cap 1073741824  <span class="comment"># 1GB</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹æ¡ˆ 2ï¼šåˆ‡æ¢åˆ° bitmap (SSD)</span></span><br><span class="line">ceph config <span class="built_in">set</span> osd.* bluestore_allocator bitmap</span><br></pre></td></tr></table></figure>

<p><strong>é—®é¢˜ 2ï¼šå†…å­˜å ç”¨è¿‡é«˜</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç—‡çŠ¶ï¼šOSD å†…å­˜ä½¿ç”¨æŒç»­å¢é•¿</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹æ¡ˆ 1ï¼šé™åˆ¶ hybrid å†…å­˜</span></span><br><span class="line">ceph config <span class="built_in">set</span> osd.* bluestore_hybrid_alloc_mem_cap 134217728  <span class="comment"># 128MB</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹æ¡ˆ 2ï¼šè§¦å‘ç¢ç‰‡æ•´ç†</span></span><br><span class="line">ceph osd compact &lt;osd-id&gt;</span><br></pre></td></tr></table></figure>

<p><strong>é—®é¢˜ 3ï¼šç¢ç‰‡ç‡è¿‡é«˜</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç—‡çŠ¶ï¼šfragmentation &gt; 0.3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹æ¡ˆ 1ï¼šç¦»çº¿ç¢ç‰‡æ•´ç†</span></span><br><span class="line">systemctl stop ceph-osd@0</span><br><span class="line">ceph-bluestore-tool --path /var/lib/ceph/osd/ceph-0 \</span><br><span class="line">                    fsck --deep</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹æ¡ˆ 2ï¼šæ•°æ®é‡å¹³è¡¡</span></span><br><span class="line">ceph osd out osd.0</span><br><span class="line"><span class="comment"># ç­‰å¾…æ•°æ®è¿ç§»</span></span><br><span class="line">ceph osd <span class="keyword">in</span> osd.0</span><br></pre></td></tr></table></figure>

<h3 id="7-4-å‡çº§å’Œè¿ç§»"><a href="#7-4-å‡çº§å’Œè¿ç§»" class="headerlink" title="7.4 å‡çº§å’Œè¿ç§»"></a>7.4 å‡çº§å’Œè¿ç§»</h3><h4 id="åœ¨çº¿åˆ‡æ¢åˆ†é…å™¨"><a href="#åœ¨çº¿åˆ‡æ¢åˆ†é…å™¨" class="headerlink" title="åœ¨çº¿åˆ‡æ¢åˆ†é…å™¨"></a>åœ¨çº¿åˆ‡æ¢åˆ†é…å™¨</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. è®¾ç½®æ–°åˆ†é…å™¨ (ä¸‹æ¬¡é‡å¯ç”Ÿæ•ˆ)</span></span><br><span class="line">ceph config <span class="built_in">set</span> osd.0 bluestore_allocator hybrid</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. å®‰å…¨é‡å¯ OSD</span></span><br><span class="line">ceph osd <span class="built_in">set</span> noout</span><br><span class="line">ceph osd <span class="built_in">set</span> norebalance</span><br><span class="line">systemctl restart ceph-osd@0</span><br><span class="line">ceph osd <span class="built_in">unset</span> noout</span><br><span class="line">ceph osd <span class="built_in">unset</span> norebalance</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. éªŒè¯</span></span><br><span class="line">ceph daemon osd.0 config get bluestore_allocator</span><br></pre></td></tr></table></figure>

<h4 id="æ‰¹é‡è¿ç§»"><a href="#æ‰¹é‡è¿ç§»" class="headerlink" title="æ‰¹é‡è¿ç§»"></a>æ‰¹é‡è¿ç§»</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># æ‰¹é‡åˆ‡æ¢æ‰€æœ‰ OSD åˆ° hybrid åˆ†é…å™¨</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> osd <span class="keyword">in</span> $(ceph osd <span class="built_in">ls</span>); <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Processing OSD.<span class="variable">$osd</span>&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># è®¾ç½®é…ç½®</span></span><br><span class="line">  ceph config <span class="built_in">set</span> osd.<span class="variable">$osd</span> bluestore_allocator hybrid</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># é‡å¯</span></span><br><span class="line">  ceph osd <span class="built_in">set</span> noout</span><br><span class="line">  systemctl restart ceph-osd@<span class="variable">$osd</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># ç­‰å¾… OSD æ¢å¤</span></span><br><span class="line">  <span class="keyword">while</span> ! ceph osd <span class="built_in">stat</span> | grep -q <span class="string">&quot;up <span class="subst">$((osd+1)</span>)&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">sleep</span> 5</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  </span><br><span class="line">  ceph osd <span class="built_in">unset</span> noout</span><br><span class="line">  <span class="built_in">sleep</span> 30  <span class="comment"># é—´éš” 30 ç§’</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-é—®é¢˜æ’æŸ¥"><a href="#8-é—®é¢˜æ’æŸ¥" class="headerlink" title="8. é—®é¢˜æ’æŸ¥"></a>8. é—®é¢˜æ’æŸ¥</h2><h3 id="8-1-å¸¸è§é—®é¢˜"><a href="#8-1-å¸¸è§é—®é¢˜" class="headerlink" title="8.1 å¸¸è§é—®é¢˜"></a>8.1 å¸¸è§é—®é¢˜</h3><h4 id="é—®é¢˜-1ï¼šåˆ†é…å¤±è´¥-ENOSPC"><a href="#é—®é¢˜-1ï¼šåˆ†é…å¤±è´¥-ENOSPC" class="headerlink" title="é—®é¢˜ 1ï¼šåˆ†é…å¤±è´¥ (ENOSPC)"></a>é—®é¢˜ 1ï¼šåˆ†é…å¤±è´¥ (ENOSPC)</h4><p><strong>ç°è±¡ï¼š</strong></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å®¢æˆ·ç«¯å†™å…¥å¤±è´¥: No <span class="literal">space</span> left <span class="keyword">on</span> device</span><br><span class="line">ä½† ceph df æ˜¾ç¤ºè¿˜æœ‰ç©ºé—´</span><br></pre></td></tr></table></figure>

<p><strong>åŸå› ï¼š</strong></p>
<ul>
<li>ç¢ç‰‡åŒ–ä¸¥é‡ï¼Œæ‰¾ä¸åˆ°è¿ç»­ç©ºé—´</li>
<li>åˆ†é…å™¨å†…éƒ¨æ•°æ®ç»“æ„ä¸ä¸€è‡´</li>
</ul>
<p><strong>æ’æŸ¥æ­¥éª¤ï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. æ£€æŸ¥ç¢ç‰‡ç‡</span></span><br><span class="line">ceph daemon osd.0 bluestore allocator dump | grep fragmentation</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æ£€æŸ¥ç©ºé—²ç©ºé—´åˆ†å¸ƒ</span></span><br><span class="line">ceph daemon osd.0 bluestore allocator dump | grep num_free_ranges</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. æŸ¥çœ‹ OSD æ—¥å¿—</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/ceph/ceph-osd.0.<span class="built_in">log</span> | grep -i <span class="string">&quot;alloc\|enospc&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–¹æ¡ˆ 1ï¼šæ•´ç†ç¢ç‰‡ (ç¦»çº¿)</span></span><br><span class="line">ceph osd out 0</span><br><span class="line">systemctl stop ceph-osd@0</span><br><span class="line">ceph-objectstore-tool --data-path /var/lib/ceph/osd/ceph-0 \</span><br><span class="line">                       --op compact</span><br><span class="line">systemctl start ceph-osd@0</span><br><span class="line">ceph osd <span class="keyword">in</span> 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹æ¡ˆ 2ï¼šå¢å¤§åˆ†é…å•å…ƒ (é‡å»º OSD)</span></span><br><span class="line">bluestore_min_alloc_size_hdd = 131072  <span class="comment"># 128KB</span></span><br></pre></td></tr></table></figure>

<h4 id="é—®é¢˜-2ï¼šå†…å­˜æ³„æ¼"><a href="#é—®é¢˜-2ï¼šå†…å­˜æ³„æ¼" class="headerlink" title="é—®é¢˜ 2ï¼šå†…å­˜æ³„æ¼"></a>é—®é¢˜ 2ï¼šå†…å­˜æ³„æ¼</h4><p><strong>ç°è±¡ï¼š</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">OSD</span> å†…å­˜æŒç»­å¢é•¿</span><br><span class="line">æœ€ç»ˆè§¦å‘ OOM killer</span><br></pre></td></tr></table></figure>

<p><strong>æ’æŸ¥æ­¥éª¤ï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. æ£€æŸ¥åˆ†é…å™¨å†…å­˜</span></span><br><span class="line">ceph daemon osd.0 dump_mempools | grep bluestore_alloc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æ£€æŸ¥ç©ºé—²åŒºé—´æ•°é‡</span></span><br><span class="line">ceph daemon osd.0 bluestore allocator dump | grep num_free_ranges</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. å¦‚æœ num_free_ranges å¼‚å¸¸å¤§ (&gt;100ä¸‡)ï¼Œè¯´æ˜ç¢ç‰‡ä¸¥é‡</span></span><br></pre></td></tr></table></figure>

<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸´æ—¶ï¼šé‡å¯ OSD</span></span><br><span class="line">systemctl restart ceph-osd@0</span><br><span class="line"></span><br><span class="line"><span class="comment"># é•¿æœŸï¼šåˆ‡æ¢åˆ°å†…å­˜å¯æ§çš„åˆ†é…å™¨</span></span><br><span class="line">ceph config <span class="built_in">set</span> osd.0 bluestore_allocator hybrid</span><br><span class="line">ceph config <span class="built_in">set</span> osd.0 bluestore_hybrid_alloc_mem_cap 268435456</span><br></pre></td></tr></table></figure>

<h4 id="é—®é¢˜-3ï¼šæ€§èƒ½æŠ–åŠ¨"><a href="#é—®é¢˜-3ï¼šæ€§èƒ½æŠ–åŠ¨" class="headerlink" title="é—®é¢˜ 3ï¼šæ€§èƒ½æŠ–åŠ¨"></a>é—®é¢˜ 3ï¼šæ€§èƒ½æŠ–åŠ¨</h4><p><strong>ç°è±¡ï¼š</strong></p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å†™å…¥å»¶è¿Ÿå‘¨æœŸæ€§å‡é«˜</span><br><span class="line"><span class="keyword">iostat</span> æ˜¾ç¤ºè®¾å¤‡åˆ©ç”¨ç‡ä¸é«˜</span><br></pre></td></tr></table></figure>

<p><strong>æ’æŸ¥æ­¥éª¤ï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. æŸ¥çœ‹åˆ†é…è€—æ—¶</span></span><br><span class="line">ceph daemon osd.0 perf dump | grep -A 5 bluestore_alloc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æŸ¥çœ‹ç¢ç‰‡æƒ…å†µ</span></span><br><span class="line">ceph daemon osd.0 bluestore allocator dump</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. å¯ç”¨è¯¦ç»†æ—¥å¿—</span></span><br><span class="line">ceph daemon osd.0 config <span class="built_in">set</span> debug_bluestore 10</span><br></pre></td></tr></table></figure>

<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¢åŠ åˆ†é…å™¨æœç´¢é™åˆ¶ï¼Œé¿å…è¿‡åº¦æœç´¢</span></span><br><span class="line">ceph config <span class="built_in">set</span> osd.* bluestore_avl_alloc_ff_max_search_count 50</span><br><span class="line">ceph config <span class="built_in">set</span> osd.* bluestore_avl_alloc_ff_max_search_bytes 524288</span><br></pre></td></tr></table></figure>

<h3 id="8-2-è°ƒè¯•å·¥å…·"><a href="#8-2-è°ƒè¯•å·¥å…·" class="headerlink" title="8.2 è°ƒè¯•å·¥å…·"></a>8.2 è°ƒè¯•å·¥å…·</h3><h4 id="BlueStore-Tool"><a href="#BlueStore-Tool" class="headerlink" title="BlueStore Tool"></a>BlueStore Tool</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥ allocator çŠ¶æ€</span></span><br><span class="line">ceph-bluestore-tool --path /var/lib/ceph/osd/ceph-0 \</span><br><span class="line">                    show-label</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·±åº¦æ£€æŸ¥</span></span><br><span class="line">ceph-bluestore-tool --path /var/lib/ceph/osd/ceph-0 \</span><br><span class="line">                    fsck --deep</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç©ºé—²ç©ºé—´</span></span><br><span class="line">ceph-bluestore-tool --path /var/lib/ceph/osd/ceph-0 \</span><br><span class="line">                    free-dump</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®å¤ä¸ä¸€è‡´</span></span><br><span class="line">ceph-bluestore-tool --path /var/lib/ceph/osd/ceph-0 \</span><br><span class="line">                    repair</span><br></pre></td></tr></table></figure>

<h4 id="æ€§èƒ½åˆ†æ"><a href="#æ€§èƒ½åˆ†æ" class="headerlink" title="æ€§èƒ½åˆ†æ"></a>æ€§èƒ½åˆ†æ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ perf åˆ†æåˆ†é…å™¨çƒ­ç‚¹</span></span><br><span class="line">perf record -g -p $(pidof ceph-osd) -- <span class="built_in">sleep</span> 30</span><br><span class="line">perf report --stdio | grep -A 10 Allocator</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ gdb è°ƒè¯•</span></span><br><span class="line">gdb -p $(pidof ceph-osd)</span><br><span class="line">(gdb) thread apply all bt</span><br><span class="line">(gdb) <span class="built_in">print</span> allocator-&gt;get_free()</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-æ€»ç»“"><a href="#9-æ€»ç»“" class="headerlink" title="9. æ€»ç»“"></a>9. æ€»ç»“</h2><h3 id="9-1-æ ¸å¿ƒè¦ç‚¹"><a href="#9-1-æ ¸å¿ƒè¦ç‚¹" class="headerlink" title="9.1 æ ¸å¿ƒè¦ç‚¹"></a>9.1 æ ¸å¿ƒè¦ç‚¹</h3><ol>
<li><p><strong>åˆ†é…å™¨æ˜¯ BlueStore çš„æ ¸å¿ƒ</strong></p>
<ul>
<li>ç›´æ¥å½±å“æ€§èƒ½ã€å†…å­˜ã€ç¢ç‰‡</li>
</ul>
</li>
<li><p><strong>äº”ç§å®ç°ï¼Œå„æœ‰åƒç§‹</strong></p>
<ul>
<li>Stupid: æµ‹è¯•ç”¨</li>
<li>Bitmap: SSD ä¼˜åŒ–ï¼Œå†…å­˜å›ºå®š</li>
<li>AVL: é€šç”¨ï¼ŒåŠ¨æ€å¹³è¡¡</li>
<li>Btree: å¤§è®¾å¤‡ä¼˜åŒ–</li>
<li><strong>Hybrid: ç”Ÿäº§é¦–é€‰</strong> â­</li>
</ul>
</li>
<li><p><strong>å…³é”®æƒè¡¡</strong></p>
<ul>
<li>æ€§èƒ½ vs å†…å­˜</li>
<li>ç¢ç‰‡æ§åˆ¶ vs åˆ†é…é€Ÿåº¦</li>
<li>ç®€å• vs åŠŸèƒ½</li>
</ul>
</li>
<li><p><strong>å®è·µå»ºè®®</strong></p>
<ul>
<li>é»˜è®¤ä½¿ç”¨ Hybrid</li>
<li>ç›‘æ§ç¢ç‰‡ç‡å’Œå†…å­˜</li>
<li>å®šæœŸæ•´ç†ç¢ç‰‡</li>
<li>æ ¹æ®è´Ÿè½½è°ƒä¼˜</li>
</ul>
</li>
</ol>
<h3 id="9-2-å†³ç­–å»ºè®®"><a href="#9-2-å†³ç­–å»ºè®®" class="headerlink" title="9.2 å†³ç­–å»ºè®®"></a>9.2 å†³ç­–å»ºè®®</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ä½ åº”è¯¥ä½¿ç”¨å“ªä¸ªåˆ†é…å™¨ï¼Ÿ</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚  ç”Ÿäº§ç¯å¢ƒï¼Ÿ                          â”‚</span><br><span class="line">â”‚  â”œâ”€ æ˜¯ â†’ Hybrid Allocator â­â­â­    â”‚</span><br><span class="line">â”‚  â””â”€ å¦ â†’ Stupid (æµ‹è¯•) <span class="symbol">/</span> AVL        â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line">ç‰¹æ®Šåœºæ™¯ï¼š</span><br><span class="line">â€¢ é«˜æ€§èƒ½ SSD <span class="operator">+</span> å†…å­˜å……è¶³ â†’ Bitmap</span><br><span class="line">â€¢ è¶…å¤§è®¾å¤‡ (<span class="operator">&gt;</span><span class="number">20</span>TB) â†’ Btree</span><br><span class="line">â€¢ å†…å­˜ä¸¥æ ¼å—é™ â†’ Hybrid (è®¾ç½® mem_cap)</span><br></pre></td></tr></table></figure>

<h3 id="9-3-æœªæ¥å±•æœ›"><a href="#9-3-æœªæ¥å±•æœ›" class="headerlink" title="9.3 æœªæ¥å±•æœ›"></a>9.3 æœªæ¥å±•æœ›</h3><p>Ceph ç¤¾åŒºæ­£åœ¨æŒç»­ä¼˜åŒ–åˆ†é…å™¨ï¼š</p>
<ol>
<li><p><strong>æ›´æ™ºèƒ½çš„ç­–ç•¥</strong></p>
<ul>
<li>åŸºäº workload çš„è‡ªé€‚åº”åˆ†é…</li>
<li>æœºå™¨å­¦ä¹ ä¼˜åŒ–ä½ç½®é€‰æ‹©</li>
</ul>
</li>
<li><p><strong>æ›´ä½çš„å¼€é”€</strong></p>
<ul>
<li>æ— é”æ•°æ®ç»“æ„</li>
<li>å¹¶è¡Œåˆ†é…</li>
</ul>
</li>
<li><p><strong>æ›´å¥½çš„ç¢ç‰‡æ§åˆ¶</strong></p>
<ul>
<li>åœ¨çº¿ç¢ç‰‡æ•´ç†</li>
<li>é¢„æµ‹æ€§ç©ºé—´ç®¡ç†</li>
</ul>
</li>
<li><p><strong>æŒä¹…åŒ–å†…å­˜æ”¯æŒ</strong></p>
<ul>
<li>PMem åŠ é€Ÿå…ƒæ•°æ®</li>
<li>é™ä½é‡å¯æ¢å¤æ—¶é—´</li>
</ul>
</li>
</ol>
<hr>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol>
<li><p><strong>æºç </strong></p>
<ul>
<li><code>src/os/bluestore/Allocator.h</code> - åˆ†é…å™¨æ¥å£</li>
<li><code>src/os/bluestore/*Allocator.cc</code> - å„å®ç°</li>
</ul>
</li>
<li><p><strong>æ–‡æ¡£</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/rados/configuration/bluestore-config-ref/">BlueStore Configuration Reference</a></li>
<li><a target="_blank" rel="noopener" href="https://ceph.io/en/news/blog/2016/bluestore-allocator-performance/">BlueStore Allocator Analysis</a></li>
</ul>
</li>
<li><p><strong>è®ºæ–‡</strong></p>
<ul>
<li>â€œBlueStore: A New, Faster Storage Backend for Cephâ€</li>
</ul>
</li>
<li><p><strong>ç¤¾åŒº</strong></p>
<ul>
<li>Ceph Dev Mailing List</li>
<li>#ceph-devel IRC</li>
</ul>
</li>
</ol>
<hr>
<h2 id="å…³äºä½œè€…"><a href="#å…³äºä½œè€…" class="headerlink" title="å…³äºä½œè€…"></a>å…³äºä½œè€…</h2><p>by hoshi<br>æœ¬æ–‡åŸºäº Ceph æœ€æ–°ä»£ç ï¼ˆPacific&#x2F;Quincy ç‰ˆæœ¬ï¼‰åˆ†æç¼–å†™ï¼Œæ¶µç›–äº†åˆ†é…å™¨çš„è®¾è®¡åŸç†ã€å®ç°ç»†èŠ‚å’Œæœ€ä½³å®è·µã€‚</p>
<hr>
<p><strong>å¦‚æœè§‰å¾—æœ¬æ–‡æœ‰å¸®åŠ©ï¼Œæ¬¢è¿åˆ†äº«ï¼</strong> ğŸš€</p>
<p>æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿æ Issue ã€‚</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ceph/" rel="tag"># ceph</a>
              <a href="/tags/seastore/" rel="tag"># seastore</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/09/27/nvme-device/" rel="prev" title="crimsonä¸­çš„è®¾å¤‡ç®¡ç†ä»Nvme åˆ°Seastore">
      <i class="fa fa-chevron-left"></i> crimsonä¸­çš„è®¾å¤‡ç®¡ç†ä»Nvme åˆ°Seastore
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/10/13/Ceph-RBD%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" rel="next" title="Ceph-RBDæºç é˜…è¯»">
      Ceph-RBDæºç é˜…è¯» <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC82MDkyNS8zNzM5NQ=="></div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Ceph-BlueStore-%E5%88%86%E9%85%8D%E5%99%A8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">Ceph BlueStore åˆ†é…å™¨æ·±åº¦è§£æ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95"><span class="nav-number">1.1.</span> <span class="nav-text">ç›®å½•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%BC%95%E8%A8%80"><span class="nav-number">1.2.</span> <span class="nav-text">1. å¼•è¨€</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AC%E6%96%87%E9%80%82%E5%90%88%E8%B0%81%EF%BC%9F"><span class="nav-number">1.2.1.</span> <span class="nav-text">æœ¬æ–‡é€‚åˆè°ï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%88%86%E9%85%8D%E5%99%A8"><span class="nav-number">1.3.</span> <span class="nav-text">2. ä¸ºä»€ä¹ˆéœ€è¦åˆ†é…å™¨</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-BlueStore-%E7%9A%84%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84"><span class="nav-number">1.3.1.</span> <span class="nav-text">2.1 BlueStore çš„å­˜å‚¨æ¶æ„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%88%86%E9%85%8D%E5%99%A8%E7%9A%84%E6%A0%B8%E5%BF%83%E9%97%AE%E9%A2%98"><span class="nav-number">1.3.2.</span> <span class="nav-text">2.2 åˆ†é…å™¨çš„æ ¸å¿ƒé—®é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98-1%EF%BC%9A%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E6%9F%A5%E6%89%BE%E7%A9%BA%E9%97%B2%E7%A9%BA%E9%97%B4%EF%BC%9F"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">é—®é¢˜ 1ï¼šå¦‚ä½•é«˜æ•ˆæŸ¥æ‰¾ç©ºé—²ç©ºé—´ï¼Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98-2%EF%BC%9A%E5%A6%82%E4%BD%95%E6%8E%A7%E5%88%B6%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%EF%BC%9F"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">é—®é¢˜ 2ï¼šå¦‚ä½•æ§åˆ¶å†…å­˜å ç”¨ï¼Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98-3%EF%BC%9A%E5%A6%82%E4%BD%95%E5%87%8F%E5%B0%91%E7%A2%8E%E7%89%87%EF%BC%9F"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">é—®é¢˜ 3ï¼šå¦‚ä½•å‡å°‘ç¢ç‰‡ï¼Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98-4%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E5%B9%B6%E5%8F%91%E6%80%A7%E8%83%BD%EF%BC%9F"><span class="nav-number">1.3.2.4.</span> <span class="nav-text">é—®é¢˜ 4ï¼šå¦‚ä½•ä¿è¯å¹¶å‘æ€§èƒ½ï¼Ÿ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%88%86%E9%85%8D%E5%99%A8%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.4.</span> <span class="nav-text">3. åˆ†é…å™¨æ¶æ„è®¾è®¡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E6%A0%B8%E5%BF%83%E6%8E%A5%E5%8F%A3"><span class="nav-number">1.4.1.</span> <span class="nav-text">3.1 æ ¸å¿ƒæ¥å£</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E5%85%B3%E9%94%AE%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.4.2.</span> <span class="nav-text">3.2 å…³é”®æ•°æ®ç»“æ„</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Extent%EF%BC%88%E5%8C%BA%E6%AE%B5%EF%BC%89"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">Extentï¼ˆåŒºæ®µï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E9%85%8D%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">åˆ†é…ç¤ºä¾‹</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.4.3.</span> <span class="nav-text">3.3 å·¥ä½œæµç¨‹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E4%BA%94%E7%A7%8D%E5%88%86%E9%85%8D%E5%99%A8%E5%AE%9E%E7%8E%B0%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.5.</span> <span class="nav-text">4. äº”ç§åˆ†é…å™¨å®ç°è¯¦è§£</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-StupidAllocator%EF%BC%88%E7%AE%80%E5%8D%95%E5%88%86%E9%85%8D%E5%99%A8%EF%BC%89"><span class="nav-number">1.5.1.</span> <span class="nav-text">4.1 StupidAllocatorï¼ˆç®€å•åˆ†é…å™¨ï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">è®¾è®¡åŸç†</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5"><span class="nav-number">1.5.1.2.</span> <span class="nav-text">åˆ†é…ç­–ç•¥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-number">1.5.1.3.</span> <span class="nav-text">ä¼˜ç¼ºç‚¹</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-BitmapAllocator%EF%BC%88%E4%BD%8D%E5%9B%BE%E5%88%86%E9%85%8D%E5%99%A8%EF%BC%89"><span class="nav-number">1.5.2.</span> <span class="nav-text">4.2 BitmapAllocatorï¼ˆä½å›¾åˆ†é…å™¨ï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86-1"><span class="nav-number">1.5.2.1.</span> <span class="nav-text">è®¾è®¡åŸç†</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.5.2.2.</span> <span class="nav-text">æ•°æ®ç»“æ„</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5-1"><span class="nav-number">1.5.2.3.</span> <span class="nav-text">åˆ†é…ç­–ç•¥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-1"><span class="nav-number">1.5.2.4.</span> <span class="nav-text">ä¼˜ç¼ºç‚¹</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-AvlAllocator%EF%BC%88AVL-%E6%A0%91%E5%88%86%E9%85%8D%E5%99%A8%EF%BC%89"><span class="nav-number">1.5.3.</span> <span class="nav-text">4.3 AvlAllocatorï¼ˆAVL æ ‘åˆ†é…å™¨ï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86-2"><span class="nav-number">1.5.3.1.</span> <span class="nav-text">è®¾è®¡åŸç†</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.5.3.2.</span> <span class="nav-text">å¯è§†åŒ–ç¤ºä¾‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5"><span class="nav-number">1.5.3.3.</span> <span class="nav-text">åŠ¨æ€åˆ†é…ç­–ç•¥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-2"><span class="nav-number">1.5.3.4.</span> <span class="nav-text">ä¼˜ç¼ºç‚¹</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-BtreeAllocator%EF%BC%88B-%E6%A0%91%E5%88%86%E9%85%8D%E5%99%A8%EF%BC%89"><span class="nav-number">1.5.4.</span> <span class="nav-text">4.4 BtreeAllocatorï¼ˆB æ ‘åˆ†é…å™¨ï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86-3"><span class="nav-number">1.5.4.1.</span> <span class="nav-text">è®¾è®¡åŸç†</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-tree-vs-AVL"><span class="nav-number">1.5.4.2.</span> <span class="nav-text">B-tree vs AVL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-3"><span class="nav-number">1.5.4.3.</span> <span class="nav-text">ä¼˜ç¼ºç‚¹</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-HybridAllocator%EF%BC%88%E6%B7%B7%E5%90%88%E5%88%86%E9%85%8D%E5%99%A8%EF%BC%89%E2%AD%90-%E6%8E%A8%E8%8D%90"><span class="nav-number">1.5.5.</span> <span class="nav-text">4.5 HybridAllocatorï¼ˆæ··åˆåˆ†é…å™¨ï¼‰â­ æ¨è</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86-4"><span class="nav-number">1.5.5.1.</span> <span class="nav-text">è®¾è®¡åŸç†</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.5.5.2.</span> <span class="nav-text">å·¥ä½œæµç¨‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%8E%A7%E5%88%B6%E7%AD%96%E7%95%A5"><span class="nav-number">1.5.5.3.</span> <span class="nav-text">å†…å­˜æ§åˆ¶ç­–ç•¥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-4"><span class="nav-number">1.5.5.4.</span> <span class="nav-text">ä¼˜ç¼ºç‚¹</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E4%B8%8E%E9%80%89%E6%8B%A9"><span class="nav-number">1.6.</span> <span class="nav-text">5. æ€§èƒ½å¯¹æ¯”ä¸é€‰æ‹©</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E7%BB%BC%E5%90%88%E5%AF%B9%E6%AF%94%E8%A1%A8"><span class="nav-number">1.6.1.</span> <span class="nav-text">5.1 ç»¼åˆå¯¹æ¯”è¡¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E9%80%89%E6%8B%A9%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.6.2.</span> <span class="nav-text">5.2 é€‰æ‹©å»ºè®®</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%B3%E7%AD%96%E6%A0%91"><span class="nav-number">1.6.2.1.</span> <span class="nav-text">å†³ç­–æ ‘</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF%E6%8E%A8%E8%8D%90"><span class="nav-number">1.6.2.2.</span> <span class="nav-text">åœºæ™¯æ¨è</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-number">1.7.</span> <span class="nav-text">6. æºç è§£æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E6%A0%B8%E5%BF%83%E5%88%86%E9%85%8D%E6%B5%81%E7%A8%8B"><span class="nav-number">1.7.1.</span> <span class="nav-text">6.1 æ ¸å¿ƒåˆ†é…æµç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-AVL-%E5%88%86%E9%85%8D%E5%99%A8%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="nav-number">1.7.2.</span> <span class="nav-text">6.2 AVL åˆ†é…å™¨æ ¸å¿ƒä»£ç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-%E5%88%86%E9%85%8D%E5%99%A8%E5%88%9B%E5%BB%BA"><span class="nav-number">1.7.3.</span> <span class="nav-text">6.3 åˆ†é…å™¨åˆ›å»º</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.8.</span> <span class="nav-text">7. æœ€ä½³å®è·µ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96"><span class="nav-number">1.8.1.</span> <span class="nav-text">7.1 é…ç½®ä¼˜åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="nav-number">1.8.1.1.</span> <span class="nav-text">åŸºç¡€é…ç½®</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%AB%98%E6%80%A7%E8%83%BD-SSD-%E9%85%8D%E7%BD%AE"><span class="nav-number">1.8.1.2.</span> <span class="nav-text">é«˜æ€§èƒ½ SSD é…ç½®</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%A7%E5%AE%B9%E9%87%8F-HDD-%E9%85%8D%E7%BD%AE"><span class="nav-number">1.8.1.3.</span> <span class="nav-text">å¤§å®¹é‡ HDD é…ç½®</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87"><span class="nav-number">1.8.2.</span> <span class="nav-text">7.2 ç›‘æ§æŒ‡æ ‡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%88%86%E9%85%8D%E5%99%A8%E7%8A%B6%E6%80%81"><span class="nav-number">1.8.2.1.</span> <span class="nav-text">æŸ¥çœ‹åˆ†é…å™¨çŠ¶æ€</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E6%8C%87%E6%A0%87"><span class="nav-number">1.8.2.2.</span> <span class="nav-text">å…³é”®æŒ‡æ ‡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Prometheus-%E7%9B%91%E6%8E%A7"><span class="nav-number">1.8.2.3.</span> <span class="nav-text">Prometheus ç›‘æ§</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98"><span class="nav-number">1.8.3.</span> <span class="nav-text">7.3 æ€§èƒ½è°ƒä¼˜</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E4%BC%98%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.8.3.1.</span> <span class="nav-text">è°ƒä¼˜æ­¥éª¤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%B0%83%E4%BC%98"><span class="nav-number">1.8.3.2.</span> <span class="nav-text">å¸¸è§é—®é¢˜è°ƒä¼˜</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-%E5%8D%87%E7%BA%A7%E5%92%8C%E8%BF%81%E7%A7%BB"><span class="nav-number">1.8.4.</span> <span class="nav-text">7.4 å‡çº§å’Œè¿ç§»</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8%E7%BA%BF%E5%88%87%E6%8D%A2%E5%88%86%E9%85%8D%E5%99%A8"><span class="nav-number">1.8.4.1.</span> <span class="nav-text">åœ¨çº¿åˆ‡æ¢åˆ†é…å™¨</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E8%BF%81%E7%A7%BB"><span class="nav-number">1.8.4.2.</span> <span class="nav-text">æ‰¹é‡è¿ç§»</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5"><span class="nav-number">1.9.</span> <span class="nav-text">8. é—®é¢˜æ’æŸ¥</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-number">1.9.1.</span> <span class="nav-text">8.1 å¸¸è§é—®é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98-1%EF%BC%9A%E5%88%86%E9%85%8D%E5%A4%B1%E8%B4%A5-ENOSPC"><span class="nav-number">1.9.1.1.</span> <span class="nav-text">é—®é¢˜ 1ï¼šåˆ†é…å¤±è´¥ (ENOSPC)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98-2%EF%BC%9A%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F"><span class="nav-number">1.9.1.2.</span> <span class="nav-text">é—®é¢˜ 2ï¼šå†…å­˜æ³„æ¼</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98-3%EF%BC%9A%E6%80%A7%E8%83%BD%E6%8A%96%E5%8A%A8"><span class="nav-number">1.9.1.3.</span> <span class="nav-text">é—®é¢˜ 3ï¼šæ€§èƒ½æŠ–åŠ¨</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7"><span class="nav-number">1.9.2.</span> <span class="nav-text">8.2 è°ƒè¯•å·¥å…·</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#BlueStore-Tool"><span class="nav-number">1.9.2.1.</span> <span class="nav-text">BlueStore Tool</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="nav-number">1.9.2.2.</span> <span class="nav-text">æ€§èƒ½åˆ†æ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-%E6%80%BB%E7%BB%93"><span class="nav-number">1.10.</span> <span class="nav-text">9. æ€»ç»“</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-%E6%A0%B8%E5%BF%83%E8%A6%81%E7%82%B9"><span class="nav-number">1.10.1.</span> <span class="nav-text">9.1 æ ¸å¿ƒè¦ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-%E5%86%B3%E7%AD%96%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.10.2.</span> <span class="nav-text">9.2 å†³ç­–å»ºè®®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-%E6%9C%AA%E6%9D%A5%E5%B1%95%E6%9C%9B"><span class="nav-number">1.10.3.</span> <span class="nav-text">9.3 æœªæ¥å±•æœ›</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">1.11.</span> <span class="nav-text">å‚è€ƒèµ„æ–™</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E4%BD%9C%E8%80%85"><span class="nav-number">1.12.</span> <span class="nav-text">å…³äºä½œè€…</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="lzy"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">lzy</p>
  <div class="site-description" itemprop="description">é€‰æ‹©æœ‰æ—¶å€™æ¯”åŠªåŠ›æ›´é‡è¦</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hoshilzy1026" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;hoshilzy1026" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:18338064521@163.com" title="E-Mail â†’ mailto:18338064521@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/6888391895" title="Weibo â†’ https:&#x2F;&#x2F;weibo.com&#x2F;6888391895" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/31529112/ffhoshi" title="StackOverflow â†’ https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;31529112&#x2F;ffhoshi" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
  </div>



      </div>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=36019737&auto=1&height=66"></iframe>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021-12 â€“ 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lzy</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">42k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">2:34</span>
</div>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv">æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡</span>
<span class="post-meta-divider">|</span>
<span id="busuanzi_container_site_uv">æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äºº</span>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>

</body>
</html>
