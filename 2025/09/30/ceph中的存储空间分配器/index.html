<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-m.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-m.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hoshilzy1026.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="Ceph BlueStore 分配器深度解析目录 1. 引言 2. 为什么需要分配器 3. 分配器架构设计 4. 五种分配器实现详解 5. 性能对比与选择 6. 源码解析 7. 最佳实践 8. 问题排查 9. 总结">
<meta property="og:type" content="article">
<meta property="og:title" content="ceph中的存储空间分配器">
<meta property="og:url" content="https://hoshilzy1026.github.io/2025/09/30/ceph%E4%B8%AD%E7%9A%84%E5%AD%98%E5%82%A8%E7%A9%BA%E9%97%B4%E5%88%86%E9%85%8D%E5%99%A8/index.html">
<meta property="og:site_name" content="Hoshi">
<meta property="og:description" content="Ceph BlueStore 分配器深度解析目录 1. 引言 2. 为什么需要分配器 3. 分配器架构设计 4. 五种分配器实现详解 5. 性能对比与选择 6. 源码解析 7. 最佳实践 8. 问题排查 9. 总结">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-09-30T02:52:47.000Z">
<meta property="article:modified_time" content="2025-10-13T09:56:28.484Z">
<meta property="article:author" content="lzy">
<meta property="article:tag" content="ceph">
<meta property="article:tag" content="seastore">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://hoshilzy1026.github.io/2025/09/30/ceph%E4%B8%AD%E7%9A%84%E5%AD%98%E5%82%A8%E7%A9%BA%E9%97%B4%E5%88%86%E9%85%8D%E5%99%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>ceph中的存储空间分配器 | Hoshi</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y6XQ2TRE3Y"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-Y6XQ2TRE3Y');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hoshi</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://hoshilzy1026.github.io/2025/09/30/ceph%E4%B8%AD%E7%9A%84%E5%AD%98%E5%82%A8%E7%A9%BA%E9%97%B4%E5%88%86%E9%85%8D%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lzy">
      <meta itemprop="description" content="选择有时候比努力更重要">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hoshi">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ceph中的存储空间分配器
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-09-30 10:52:47" itemprop="dateCreated datePublished" datetime="2025-09-30T10:52:47+08:00">2025-09-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-10-13 17:56:28" itemprop="dateModified" datetime="2025-10-13T17:56:28+08:00">2025-10-13</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>15 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Ceph-BlueStore-分配器深度解析"><a href="#Ceph-BlueStore-分配器深度解析" class="headerlink" title="Ceph BlueStore 分配器深度解析"></a>Ceph BlueStore 分配器深度解析</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#1-%E5%BC%95%E8%A8%80">1. 引言</a></li>
<li><a href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%88%86%E9%85%8D%E5%99%A8">2. 为什么需要分配器</a></li>
<li><a href="#3-%E5%88%86%E9%85%8D%E5%99%A8%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1">3. 分配器架构设计</a></li>
<li><a href="#4-%E4%BA%94%E7%A7%8D%E5%88%86%E9%85%8D%E5%99%A8%E5%AE%9E%E7%8E%B0%E8%AF%A6%E8%A7%A3">4. 五种分配器实现详解</a></li>
<li><a href="#5-%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E4%B8%8E%E9%80%89%E6%8B%A9">5. 性能对比与选择</a></li>
<li><a href="#6-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90">6. 源码解析</a></li>
<li><a href="#7-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">7. 最佳实践</a></li>
<li><a href="#8-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5">8. 问题排查</a></li>
<li><a href="#9-%E6%80%BB%E7%BB%93">9. 总结</a></li>
</ul>
<hr>
<span id="more"></span>

<h2 id="1-引言"><a href="#1-引言" class="headerlink" title="1. 引言"></a>1. 引言</h2><p>在 Ceph 存储系统中，BlueStore 作为新一代对象存储引擎，直接管理裸块设备，摒弃了传统文件系统的开销。在这种架构下，<strong>分配器（Allocator）</strong> 成为了至关重要的组件——它负责管理磁盘空闲空间的分配和回收，直接影响着存储性能、碎片化程度和内存占用。</p>
<p>本文将深入剖析 Ceph 分配器的设计原理、实现细节和使用场景，帮助你全面理解这一核心组件。</p>
<h3 id="本文适合谁？"><a href="#本文适合谁？" class="headerlink" title="本文适合谁？"></a>本文适合谁？</h3><ul>
<li>Ceph 运维工程师：了解如何选择和调优分配器</li>
<li>存储开发者：理解分配器的设计思想和实现细节</li>
<li>系统架构师：评估不同分配器对系统的影响</li>
</ul>
<hr>
<h2 id="2-为什么需要分配器"><a href="#2-为什么需要分配器" class="headerlink" title="2. 为什么需要分配器"></a>2. 为什么需要分配器</h2><h3 id="2-1-BlueStore-的存储架构"><a href="#2-1-BlueStore-的存储架构" class="headerlink" title="2.1 BlueStore 的存储架构"></a>2.1 BlueStore 的存储架构</h3><p>在 BlueStore 中，数据流转路径如下：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">用户写入对象</span><br><span class="line">    ↓</span><br><span class="line"><span class="keyword">BlueStore </span>接收请求</span><br><span class="line">    ↓</span><br><span class="line">Allocator 分配磁盘空间 ← 本文重点</span><br><span class="line">    ↓</span><br><span class="line">写入裸块设备</span><br><span class="line">    ↓</span><br><span class="line">元数据存储到 RocksDB</span><br></pre></td></tr></table></figure>

<p>BlueStore 直接管理裸设备，需要自己实现：</p>
<ul>
<li><strong>空闲空间管理</strong>：哪些磁盘块是空闲的？</li>
<li><strong>空间分配</strong>：为新数据找到合适的存储位置</li>
<li><strong>空间回收</strong>：删除数据后回收磁盘块</li>
<li><strong>碎片管理</strong>：避免磁盘空间碎片化</li>
</ul>
<p>这就是分配器的职责所在。</p>
<h3 id="2-2-分配器的核心问题"><a href="#2-2-分配器的核心问题" class="headerlink" title="2.2 分配器的核心问题"></a>2.2 分配器的核心问题</h3><p>分配器需要解决以下关键问题：</p>
<h4 id="问题-1：如何高效查找空闲空间？"><a href="#问题-1：如何高效查找空闲空间？" class="headerlink" title="问题 1：如何高效查找空闲空间？"></a>问题 1：如何高效查找空闲空间？</h4><ul>
<li>对于 10TB 磁盘，有数百万个 4KB 块</li>
<li>需要快速找到满足大小要求的连续空间</li>
</ul>
<h4 id="问题-2：如何控制内存占用？"><a href="#问题-2：如何控制内存占用？" class="headerlink" title="问题 2：如何控制内存占用？"></a>问题 2：如何控制内存占用？</h4><ul>
<li>记录所有空闲区间需要内存</li>
<li>碎片越多，内存占用越大</li>
<li>需要在性能和内存间平衡</li>
</ul>
<h4 id="问题-3：如何减少碎片？"><a href="#问题-3：如何减少碎片？" class="headerlink" title="问题 3：如何减少碎片？"></a>问题 3：如何减少碎片？</h4><ul>
<li>随机分配导致碎片化</li>
<li>需要智能的分配策略</li>
</ul>
<h4 id="问题-4：如何保证并发性能？"><a href="#问题-4：如何保证并发性能？" class="headerlink" title="问题 4：如何保证并发性能？"></a>问题 4：如何保证并发性能？</h4><ul>
<li>多线程并发读写</li>
<li>锁竞争影响性能</li>
</ul>
<hr>
<h2 id="3-分配器架构设计"><a href="#3-分配器架构设计" class="headerlink" title="3. 分配器架构设计"></a>3. 分配器架构设计</h2><h3 id="3-1-核心接口"><a href="#3-1-核心接口" class="headerlink" title="3.1 核心接口"></a>3.1 核心接口</h3><p>Ceph 定义了统一的分配器接口：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Allocator</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// 分配指定大小的空间</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">int64_t</span> <span class="title">allocate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint64_t</span> want_size,      <span class="comment">// 期望分配的大小</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint64_t</span> alloc_unit,     <span class="comment">// 分配单元（通常 4KB）</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint64_t</span> max_alloc_size, <span class="comment">// 单个 extent 最大大小</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int64_t</span> hint,            <span class="comment">// 位置提示（优化局部性）</span></span></span></span><br><span class="line"><span class="params"><span class="function">    PExtentVector *extents   <span class="comment">// [输出] 分配的物理 extent 列表</span></span></span></span><br><span class="line"><span class="params"><span class="function">  )</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 释放空间</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">release</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> interval_set&lt;<span class="type">uint64_t</span>&gt;&amp; release_set</span></span></span><br><span class="line"><span class="params"><span class="function">  )</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取可用空间大小</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">uint64_t</span> <span class="title">get_free</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取碎片率</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">double</span> <span class="title">get_fragmentation</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化时添加空闲空间</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">init_add_free</span><span class="params">(<span class="type">uint64_t</span> offset, <span class="type">uint64_t</span> length)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化时移除已使用空间</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">init_rm_free</span><span class="params">(<span class="type">uint64_t</span> offset, <span class="type">uint64_t</span> length)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-关键数据结构"><a href="#3-2-关键数据结构" class="headerlink" title="3.2 关键数据结构"></a>3.2 关键数据结构</h3><h4 id="Extent（区段）"><a href="#Extent（区段）" class="headerlink" title="Extent（区段）"></a>Extent（区段）</h4><p>表示一段连续的磁盘空间：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">bluestore_pextent_t</span> &#123;</span><br><span class="line">  <span class="type">uint64_t</span> offset;  <span class="comment">// 起始偏移</span></span><br><span class="line">  <span class="type">uint64_t</span> length;  <span class="comment">// 长度</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> std::vector&lt;<span class="type">bluestore_pextent_t</span>&gt; PExtentVector;</span><br></pre></td></tr></table></figure>

<h4 id="分配示例"><a href="#分配示例" class="headerlink" title="分配示例"></a>分配示例</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">磁盘布局：<span class="selector-attr">[已用]</span><span class="selector-attr">[  空闲100MB  ]</span><span class="selector-attr">[已用]</span><span class="selector-attr">[  空闲50MB  ]</span></span><br><span class="line"></span><br><span class="line">分配 <span class="number">60</span>MB：</span><br><span class="line">  - 查找：找到 <span class="number">100</span>MB 空闲块</span><br><span class="line">  - 分配：<span class="selector-attr">[offset: 1000MB, length: 60MB]</span></span><br><span class="line">  - 更新：剩余 <span class="selector-attr">[offset: 1060MB, length: 40MB]</span> 标记为空闲</span><br></pre></td></tr></table></figure>

<h3 id="3-3-工作流程"><a href="#3-3-工作流程" class="headerlink" title="3.3 工作流程"></a>3.3 工作流程</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────┐</span><br><span class="line">│                      BlueStore                          │</span><br><span class="line">│                                                         │</span><br><span class="line">│  写入对象 ──┐                                           │</span><br><span class="line">│            │                                            │</span><br><span class="line">│            ↓                                            │</span><br><span class="line">│  ┌──────────────────┐        ┌──────────────────┐     │</span><br><span class="line">│  │   Allocator      │◄──────►│  FreelistManager │     │</span><br><span class="line">│  │                  │        │   (RocksDB)      │     │</span><br><span class="line">│  │ • 内存中管理     │        │  持久化空闲信息   │     │</span><br><span class="line">│  │ • 快速分配       │        │                  │     │</span><br><span class="line">│  └──────────────────┘        └──────────────────┘     │</span><br><span class="line">│            │                                            │</span><br><span class="line">│            ↓                                            │</span><br><span class="line">│  ┌──────────────────┐                                  │</span><br><span class="line">│  │   Block Device   │                                  │</span><br><span class="line">│  │   (裸块设备)     │                                  │</span><br><span class="line">│  └──────────────────┘                                  │</span><br><span class="line">└─────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>关键点：</strong></p>
<ul>
<li><strong>Allocator</strong>：内存中管理，性能关键路径</li>
<li><strong>FreelistManager</strong>：持久化到 RocksDB，重启时恢复</li>
</ul>
<hr>
<h2 id="4-五种分配器实现详解"><a href="#4-五种分配器实现详解" class="headerlink" title="4. 五种分配器实现详解"></a>4. 五种分配器实现详解</h2><p>Ceph 提供了 5 种分配器实现，每种都有不同的设计权衡。</p>
<h3 id="4-1-StupidAllocator（简单分配器）"><a href="#4-1-StupidAllocator（简单分配器）" class="headerlink" title="4.1 StupidAllocator（简单分配器）"></a>4.1 StupidAllocator（简单分配器）</h3><h4 id="设计原理"><a href="#设计原理" class="headerlink" title="设计原理"></a>设计原理</h4><p>StupidAllocator 使用 <strong>interval_set</strong> 结构，按大小分桶（bin）管理空闲块：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">StupidAllocator</span> : <span class="keyword">public</span> Allocator &#123;</span><br><span class="line">  <span class="comment">// 多个桶，按 2 的幂次分组</span></span><br><span class="line">  std::vector&lt;<span class="type">interval_set_t</span>&gt; free;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// [0-64KB] → bin 0</span></span><br><span class="line">  <span class="comment">// [64KB-512KB] → bin 1</span></span><br><span class="line">  <span class="comment">// [512KB-4MB] → bin 2</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="分配策略"><a href="#分配策略" class="headerlink" title="分配策略"></a>分配策略</h4><ol>
<li>根据请求大小计算 bin</li>
<li>从对应 bin 中查找</li>
<li>找不到则去更大的 bin</li>
<li>Simple first-fit 策略</li>
</ol>
<h4 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h4><p><strong>优点：</strong></p>
<ul>
<li>✅ 实现简单，易于理解</li>
<li>✅ 内存占用中等</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>❌ 性能一般</li>
<li>❌ 碎片控制差</li>
<li>❌ 不适合生产环境</li>
</ul>
<p><strong>适用场景：</strong> 测试、开发环境</p>
<hr>
<h3 id="4-2-BitmapAllocator（位图分配器）"><a href="#4-2-BitmapAllocator（位图分配器）" class="headerlink" title="4.2 BitmapAllocator（位图分配器）"></a>4.2 BitmapAllocator（位图分配器）</h3><h4 id="设计原理-1"><a href="#设计原理-1" class="headerlink" title="设计原理"></a>设计原理</h4><p>使用 <strong>位图（Bitmap）</strong> 表示每个分配单元的状态：</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">磁盘划分：每 4KB 一个分配单元</span><br><span class="line"></span><br><span class="line">位图表示：</span><br><span class="line">Bit:   <span class="number"> 0 </span><span class="number"> 1 </span><span class="number"> 2 </span><span class="number"> 3 </span><span class="number"> 4 </span><span class="number"> 5 </span><span class="number"> 6 </span><span class="number"> 7 </span><span class="number"> 8 </span><span class="number"> 9 </span><span class="number"> 10 </span>11 12</span><br><span class="line">状态:   已 空 空 空 已 已 空 空 空 空 已 空 空</span><br><span class="line">       用 闲 闲 闲 用 用 闲 闲 闲 闲 用 闲 闲</span><br><span class="line"></span><br><span class="line">分配 16KB (4个单元)：</span><br><span class="line">  - 扫描位图找到连续的<span class="number"> 4 </span>个 1</span><br><span class="line">  - 位置 6-9 可用</span><br><span class="line">  - 标记为已用：...00000111...</span><br></pre></td></tr></table></figure>

<h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BitmapAllocator</span> : <span class="keyword">public</span> Allocator,</span><br><span class="line">  <span class="keyword">public</span> AllocatorLevel02&lt;AllocatorLevel01Loose&gt; &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 两层位图结构</span></span><br><span class="line">  <span class="comment">// L1: 粗粒度位图（每 bit 代表多个 L2 块）</span></span><br><span class="line">  <span class="comment">// L2: 细粒度位图（每 bit 代表 4KB）</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="分配策略-1"><a href="#分配策略-1" class="headerlink" title="分配策略"></a>分配策略</h4><ol>
<li>在 L1 位图快速定位可能的空闲区域</li>
<li>在 L2 位图精确查找连续空闲块</li>
<li>利用位运算加速查找</li>
</ol>
<h4 id="优缺点-1"><a href="#优缺点-1" class="headerlink" title="优缺点"></a>优缺点</h4><p><strong>优点：</strong></p>
<ul>
<li>✅ <strong>内存占用可预测</strong>：O(设备大小&#x2F;分配单元)<ul>
<li>10TB 设备，4KB 单元 → 320MB 内存</li>
</ul>
</li>
<li>✅ <strong>查找快速</strong>：位运算高效</li>
<li>✅ 碎片处理好</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>❌ 大设备内存占用高</li>
<li>❌ 初始化时间长</li>
</ul>
<p><strong>适用场景：</strong></p>
<ul>
<li>✅ SSD 设备</li>
<li>✅ 小文件负载</li>
<li>✅ 内存充足场景</li>
</ul>
<hr>
<h3 id="4-3-AvlAllocator（AVL-树分配器）"><a href="#4-3-AvlAllocator（AVL-树分配器）" class="headerlink" title="4.3 AvlAllocator（AVL 树分配器）"></a>4.3 AvlAllocator（AVL 树分配器）</h3><h4 id="设计原理-2"><a href="#设计原理-2" class="headerlink" title="设计原理"></a>设计原理</h4><p>使用 <strong>两棵 AVL 树</strong> 管理空闲区间：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">range_seg_t</span> &#123;</span><br><span class="line">  <span class="type">uint64_t</span> start;  <span class="comment">// 起始位置</span></span><br><span class="line">  <span class="type">uint64_t</span> end;    <span class="comment">// 结束位置</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AvlAllocator</span> : <span class="keyword">public</span> Allocator &#123;</span><br><span class="line">  <span class="comment">// 树 1：按偏移量排序（用于位置查找）</span></span><br><span class="line">  avl_set&lt;<span class="type">range_seg_t</span>, by_offset&gt; range_tree;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 树 2：按大小排序（用于大小查找）</span></span><br><span class="line">  avl_multiset&lt;<span class="type">range_seg_t</span>, by_size&gt; range_size_tree;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="可视化示例"><a href="#可视化示例" class="headerlink" title="可视化示例"></a>可视化示例</h4><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">空闲区间：<span class="comment">[100MB-200MB]</span> <span class="comment">[500MB-600MB]</span> <span class="comment">[800MB-1000MB]</span></span><br><span class="line"></span><br><span class="line">range_tree (按偏移):</span><br><span class="line">         <span class="comment">[500-600]</span></span><br><span class="line">        /         \</span><br><span class="line">   <span class="comment">[100-200]</span>    <span class="comment">[800-1000]</span></span><br><span class="line"></span><br><span class="line">range_size_tree (按大小):</span><br><span class="line">         <span class="comment">[500-600]</span>  100MB</span><br><span class="line">        /         \</span><br><span class="line">   <span class="comment">[100-200]</span>    <span class="comment">[800-1000]</span></span><br><span class="line">    100MB         200MB</span><br></pre></td></tr></table></figure>

<h4 id="动态分配策略"><a href="#动态分配策略" class="headerlink" title="动态分配策略"></a>动态分配策略</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 空间充足时 (&gt;1% 空闲)</span></span><br><span class="line"><span class="keyword">if</span> (free_space_pct &gt; threshold) &#123;</span><br><span class="line">  <span class="comment">// First-Fit：按偏移查找</span></span><br><span class="line">  <span class="comment">// 优点：减少碎片，提高局部性</span></span><br><span class="line">  <span class="built_in">search_by_offset</span>(range_tree, cursor);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 空间紧张时</span></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// Best-Fit：按大小查找</span></span><br><span class="line">  <span class="comment">// 优点：提高空间利用率</span></span><br><span class="line">  <span class="built_in">search_by_size</span>(range_size_tree, want_size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="优缺点-2"><a href="#优缺点-2" class="headerlink" title="优缺点"></a>优缺点</h4><p><strong>优点：</strong></p>
<ul>
<li>✅ <strong>动态策略</strong>：根据空闲度自动调整</li>
<li>✅ <strong>性能均衡</strong>：O(log N) 查找时间</li>
<li>✅ <strong>碎片控制好</strong></li>
<li>✅ <strong>生产环境推荐</strong></li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>❌ <strong>内存不可控</strong>：碎片多时占用高<ul>
<li>极端情况：数百万个小空闲块 → 数 GB 内存</li>
</ul>
</li>
<li>❌ 高碎片下性能下降</li>
</ul>
<p><strong>适用场景：</strong></p>
<ul>
<li>✅ 通用场景</li>
<li>✅ 碎片可控环境</li>
<li>✅ 中等规模设备</li>
</ul>
<hr>
<h3 id="4-4-BtreeAllocator（B-树分配器）"><a href="#4-4-BtreeAllocator（B-树分配器）" class="headerlink" title="4.4 BtreeAllocator（B 树分配器）"></a>4.4 BtreeAllocator（B 树分配器）</h3><h4 id="设计原理-3"><a href="#设计原理-3" class="headerlink" title="设计原理"></a>设计原理</h4><p>与 AvlAllocator 类似，但使用 <strong>B-tree</strong> 替代 AVL 树：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BtreeAllocator</span> : <span class="keyword">public</span> Allocator &#123;</span><br><span class="line">  <span class="comment">// 使用 B-tree 结构</span></span><br><span class="line">  btree::btree_map&lt;<span class="type">uint64_t</span>, <span class="type">range_seg_t</span>&gt; range_tree;</span><br><span class="line">  btree::btree_multimap&lt;<span class="type">uint64_t</span>, <span class="type">range_seg_t</span>&gt; range_size_tree;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="B-tree-vs-AVL"><a href="#B-tree-vs-AVL" class="headerlink" title="B-tree vs AVL"></a>B-tree vs AVL</h4><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">AVL</span> <span class="selector-tag">Tree</span> (二叉树):</span><br><span class="line">       <span class="selector-attr">[50]</span></span><br><span class="line">      /    \</span><br><span class="line">   <span class="selector-attr">[30]</span>    <span class="selector-attr">[70]</span></span><br><span class="line">   /  \    /  \</span><br><span class="line"><span class="selector-attr">[20]</span><span class="selector-attr">[40]</span><span class="selector-attr">[60]</span><span class="selector-attr">[80]</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">B</span><span class="selector-tag">-tree</span> (多叉树):</span><br><span class="line">    <span class="selector-attr">[30 | 60]</span></span><br><span class="line">    /    |    \</span><br><span class="line"><span class="selector-attr">[10,20]</span><span class="selector-attr">[40,50]</span><span class="selector-attr">[70,80,90]</span></span><br></pre></td></tr></table></figure>

<h4 id="优缺点-3"><a href="#优缺点-3" class="headerlink" title="优缺点"></a>优缺点</h4><p><strong>优点：</strong></p>
<ul>
<li>✅ <strong>更好的缓存局部性</strong>：节点存储多个元素</li>
<li>✅ 树高度更低：减少指针跳转</li>
<li>✅ 大规模数据性能好</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>❌ 实现复杂</li>
<li>❌ 小规模数据开销大</li>
</ul>
<p><strong>适用场景：</strong></p>
<ul>
<li>✅ 大型设备（&gt;10TB）</li>
<li>✅ 高碎片场景</li>
</ul>
<hr>
<h3 id="4-5-HybridAllocator（混合分配器）⭐-推荐"><a href="#4-5-HybridAllocator（混合分配器）⭐-推荐" class="headerlink" title="4.5 HybridAllocator（混合分配器）⭐ 推荐"></a>4.5 HybridAllocator（混合分配器）⭐ 推荐</h3><h4 id="设计原理-4"><a href="#设计原理-4" class="headerlink" title="设计原理"></a>设计原理</h4><p><strong>结合 AVL 和 Bitmap 的优势</strong>，控制内存占用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HybridAllocator</span> : <span class="keyword">public</span> AvlAllocator &#123;</span><br><span class="line">  <span class="type">uint64_t</span> max_mem;        <span class="comment">// 内存上限</span></span><br><span class="line">  BitmapAllocator* bitmap; <span class="comment">// 溢出存储</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">virtual</span> <span class="type">void</span> _spillover_range(<span class="type">uint64_t</span> start, <span class="type">uint64_t</span> end) <span class="keyword">override</span> &#123;</span><br><span class="line">    <span class="comment">// 当 AVL 树超过内存限制时</span></span><br><span class="line">    <span class="comment">// 将最小的空闲块溢出到 Bitmap</span></span><br><span class="line">    bitmap-&gt;<span class="built_in">init_add_free</span>(start, end);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h4><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────┐</span><br><span class="line">│           HybridAllocator                   │</span><br><span class="line">│                                             │</span><br><span class="line">│  ┌─────────────────────────┐               │</span><br><span class="line">│  │   AVL Tree (in-memory)  │               │</span><br><span class="line">│  │   存储大空闲块           │  内存 &lt; <span class="number">256</span>MB │</span><br><span class="line">│  │   <span class="selector-attr">[1GB-2GB]</span>             │               │</span><br><span class="line">│  │   <span class="selector-attr">[5GB-6GB]</span>             │               │</span><br><span class="line">│  │   ...                   │               │</span><br><span class="line">│  └─────────────────────────┘               │</span><br><span class="line">│              ↓ 溢出                         │</span><br><span class="line">│  ┌─────────────────────────┐               │</span><br><span class="line">│  │   Bitmap (spillover)    │               │</span><br><span class="line">│  │   存储小碎片块           │               │</span><br><span class="line">│  │   <span class="selector-attr">[4KB]</span> <span class="selector-attr">[8KB]</span> <span class="selector-attr">[12KB]</span>... │               │</span><br><span class="line">│  └─────────────────────────┘               │</span><br><span class="line">└─────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">分配逻辑：</span><br><span class="line"><span class="number">1</span>. 优先从 AVL 树分配（快速）</span><br><span class="line"><span class="number">2</span>. 找不到则查询 Bitmap</span><br><span class="line"><span class="number">3</span>. 定期整理：Bitmap 中大块合并回 AVL</span><br></pre></td></tr></table></figure>

<h4 id="内存控制策略"><a href="#内存控制策略" class="headerlink" title="内存控制策略"></a>内存控制策略</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置：最大 256MB</span></span><br><span class="line">bluestore_hybrid_alloc_mem_cap = <span class="number">268435456</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 当 AVL 树达到容量限制</span></span><br><span class="line"><span class="keyword">if</span> (range_tree.<span class="built_in">size</span>() &gt;= max_ranges) &#123;</span><br><span class="line">  <span class="comment">// 移除最小的空闲块到 Bitmap</span></span><br><span class="line">  <span class="keyword">auto</span> smallest = range_size_tree.<span class="built_in">begin</span>();</span><br><span class="line">  <span class="built_in">spillover_to_bitmap</span>(smallest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="优缺点-4"><a href="#优缺点-4" class="headerlink" title="优缺点"></a>优缺点</h4><p><strong>优点：</strong></p>
<ul>
<li>✅ <strong>内存可控</strong>：设置上限，可预测</li>
<li>✅ <strong>性能优秀</strong>：大块分配快速（AVL）</li>
<li>✅ <strong>碎片处理好</strong>：小碎片交给 Bitmap</li>
<li>✅ <strong>生产环境首选</strong> ⭐⭐⭐</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>❌ 实现最复杂</li>
<li>❌ 需要调优参数</li>
</ul>
<p><strong>适用场景：</strong></p>
<ul>
<li>✅ <strong>所有生产环境</strong> 🏆</li>
<li>✅ 大规模部署</li>
<li>✅ 混合负载</li>
</ul>
<hr>
<h2 id="5-性能对比与选择"><a href="#5-性能对比与选择" class="headerlink" title="5. 性能对比与选择"></a>5. 性能对比与选择</h2><h3 id="5-1-综合对比表"><a href="#5-1-综合对比表" class="headerlink" title="5.1 综合对比表"></a>5.1 综合对比表</h3><table>
<thead>
<tr>
<th>分配器</th>
<th>内存占用</th>
<th>分配速度</th>
<th>碎片处理</th>
<th>复杂度</th>
<th>生产推荐</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Stupid</strong></td>
<td>中等</td>
<td>⭐⭐</td>
<td>⭐⭐</td>
<td>简单</td>
<td>❌ 仅测试</td>
</tr>
<tr>
<td><strong>Bitmap</strong></td>
<td>固定（高）</td>
<td>⭐⭐⭐⭐</td>
<td>⭐⭐⭐⭐</td>
<td>中等</td>
<td>✅ SSD</td>
</tr>
<tr>
<td><strong>AVL</strong></td>
<td>动态</td>
<td>⭐⭐⭐</td>
<td>⭐⭐⭐⭐</td>
<td>中等</td>
<td>✅ 通用</td>
</tr>
<tr>
<td><strong>Btree</strong></td>
<td>动态</td>
<td>⭐⭐⭐</td>
<td>⭐⭐⭐⭐</td>
<td>高</td>
<td>✅ 大设备</td>
</tr>
<tr>
<td><strong>Hybrid</strong></td>
<td>可控</td>
<td>⭐⭐⭐⭐⭐</td>
<td>⭐⭐⭐⭐⭐</td>
<td>高</td>
<td>✅✅ 首选</td>
</tr>
</tbody></table>
<h3 id="5-2-选择建议"><a href="#5-2-选择建议" class="headerlink" title="5.2 选择建议"></a>5.2 选择建议</h3><h4 id="决策树"><a href="#决策树" class="headerlink" title="决策树"></a>决策树</h4><figure class="highlight tp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">开始</span><br><span class="line"> │</span><br><span class="line"> ├─ 测试/开发环境？</span><br><span class="line"> │   └─ 是 → StupidAllocator</span><br><span class="line"> │</span><br><span class="line"> ├─ 内存严格受限？</span><br><span class="line"> │   └─ 是 → HybridAllocator (设置 mem_cap)</span><br><span class="line"> │</span><br><span class="line"> ├─ 设备类型？</span><br><span class="line"> │   ├─ SSD + 小文件负载 → BitmapAllocator</span><br><span class="line"> │   ├─ 大设备 (&gt;<span class="number">20</span><span class="keyword">TB</span>) → BtreeAllocator</span><br><span class="line"> │   └─ 其他 → HybridAllocator ⭐</span><br><span class="line"> │</span><br><span class="line"> └─ 不确定？→ HybridAllocator (默认推荐)</span><br></pre></td></tr></table></figure>

<h4 id="场景推荐"><a href="#场景推荐" class="headerlink" title="场景推荐"></a>场景推荐</h4><p><strong>场景 1：高性能 SSD 集群</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bluestore_allocator = hybrid</span><br><span class="line">bluestore_hybrid_alloc_mem_cap = 536870912  <span class="comment"># 512MB</span></span><br></pre></td></tr></table></figure>

<p><strong>场景 2：HDD 大容量存储</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bluestore_allocator = btree</span><br></pre></td></tr></table></figure>

<p><strong>场景 3：内存受限环境</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bluestore_allocator = hybrid</span><br><span class="line">bluestore_hybrid_alloc_mem_cap = 134217728  <span class="comment"># 128MB</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-源码解析"><a href="#6-源码解析" class="headerlink" title="6. 源码解析"></a>6. 源码解析</h2><h3 id="6-1-核心分配流程"><a href="#6-1-核心分配流程" class="headerlink" title="6.1 核心分配流程"></a>6.1 核心分配流程</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/os/bluestore/BlueStore.cc</span></span><br><span class="line"><span class="type">int</span> BlueStore::_do_alloc_write(</span><br><span class="line">    TransContext *txc,</span><br><span class="line">    CollectionRef&amp; c,</span><br><span class="line">    OnodeRef o,</span><br><span class="line">    BlueStore::WriteContext *wctx)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint64_t</span> need = wctx-&gt;logical_length;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 1. 调用分配器分配空间</span></span><br><span class="line">  PExtentVector extents;</span><br><span class="line">  <span class="type">int64_t</span> got = alloc-&gt;<span class="built_in">allocate</span>(</span><br><span class="line">    need,                    <span class="comment">// 需要的大小</span></span><br><span class="line">    min_alloc_size,          <span class="comment">// 最小分配单元 (4KB)</span></span><br><span class="line">    need,                    <span class="comment">// 最大分配大小</span></span><br><span class="line">    <span class="number">0</span>,                       <span class="comment">// hint (位置提示)</span></span><br><span class="line">    &amp;extents                 <span class="comment">// 输出：分配的 extent 列表</span></span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (got &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 分配失败</span></span><br><span class="line">    <span class="keyword">return</span> got;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 2. 写入数据到分配的物理位置</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; p : extents) &#123;</span><br><span class="line">    r = bdev-&gt;<span class="built_in">aio_write</span>(</span><br><span class="line">      p.offset,              <span class="comment">// 物理偏移</span></span><br><span class="line">      bl,                    <span class="comment">// 数据</span></span><br><span class="line">      &amp;txc-&gt;ioc,            <span class="comment">// IO 上下文</span></span><br><span class="line">      <span class="literal">false</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 3. 更新元数据</span></span><br><span class="line">  o-&gt;extent_map.<span class="built_in">punch_hole</span>(offset, length);</span><br><span class="line">  o-&gt;extent_map.<span class="built_in">add_extent</span>(offset, extents);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-AVL-分配器核心代码"><a href="#6-2-AVL-分配器核心代码" class="headerlink" title="6.2 AVL 分配器核心代码"></a>6.2 AVL 分配器核心代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/os/bluestore/AvlAllocator.cc</span></span><br><span class="line"><span class="type">int64_t</span> AvlAllocator::_allocate(</span><br><span class="line">    <span class="type">uint64_t</span> want,</span><br><span class="line">    <span class="type">uint64_t</span> unit,</span><br><span class="line">    <span class="type">uint64_t</span> max_alloc_size,</span><br><span class="line">    <span class="type">int64_t</span>  hint,</span><br><span class="line">    PExtentVector *extents)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">l</span><span class="params">(lock)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="type">uint64_t</span> allocated = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> (allocated &lt; want) &#123;</span><br><span class="line">    <span class="type">uint64_t</span> offset, length;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 选择分配策略</span></span><br><span class="line">    <span class="keyword">if</span> (_use_first_fit()) &#123;</span><br><span class="line">      <span class="comment">// First-fit: 按偏移查找（减少碎片）</span></span><br><span class="line">      offset = _pick_block_after(&amp;cursor, want - allocated, unit);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Best-fit: 按大小查找（提高利用率）</span></span><br><span class="line">      offset = _pick_block_fits(want - allocated, unit);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (offset == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">break</span>;  <span class="comment">// 找不到合适的块</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 从树中移除分配的区间</span></span><br><span class="line">    _remove_from_tree(offset, length);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 记录分配结果</span></span><br><span class="line">    extents-&gt;<span class="built_in">emplace_back</span>(offset, length);</span><br><span class="line">    allocated += length;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> allocated;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 按大小查找</span></span><br><span class="line"><span class="type">uint64_t</span> AvlAllocator::_pick_block_fits(<span class="type">uint64_t</span> size, <span class="type">uint64_t</span> align)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 在 range_size_tree 中查找 &gt;= size 的最小块</span></span><br><span class="line">  <span class="function"><span class="type">range_seg_t</span> <span class="title">search_node</span><span class="params">(<span class="number">0</span>, size)</span></span>;</span><br><span class="line">  <span class="keyword">auto</span> rs_it = range_size_tree.<span class="built_in">lower_bound</span>(search_node);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (rs_it == range_size_tree.<span class="built_in">end</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// 没有足够大的块</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="type">uint64_t</span> offset = <span class="built_in">p2roundup</span>(rs_it-&gt;start, align);</span><br><span class="line">  <span class="keyword">return</span> offset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-分配器创建"><a href="#6-3-分配器创建" class="headerlink" title="6.3 分配器创建"></a>6.3 分配器创建</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/os/bluestore/Allocator.cc</span></span><br><span class="line"><span class="function">Allocator *<span class="title">Allocator::create</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    CephContext* cct,</span></span></span><br><span class="line"><span class="params"><span class="function">    std::string_view type,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int64_t</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int64_t</span> block_size,</span></span></span><br><span class="line"><span class="params"><span class="function">    std::string_view name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Allocator* alloc = <span class="literal">nullptr</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (type == <span class="string">&quot;stupid&quot;</span>) &#123;</span><br><span class="line">    alloc = <span class="keyword">new</span> <span class="built_in">StupidAllocator</span>(cct, size, block_size, name);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="string">&quot;bitmap&quot;</span>) &#123;</span><br><span class="line">    alloc = <span class="keyword">new</span> <span class="built_in">BitmapAllocator</span>(cct, size, block_size, name);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="string">&quot;avl&quot;</span>) &#123;</span><br><span class="line">    alloc = <span class="keyword">new</span> <span class="built_in">AvlAllocator</span>(cct, size, block_size, name);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="string">&quot;btree&quot;</span>) &#123;</span><br><span class="line">    alloc = <span class="keyword">new</span> <span class="built_in">BtreeAllocator</span>(cct, size, block_size, name);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="string">&quot;hybrid&quot;</span>) &#123;</span><br><span class="line">    <span class="type">uint64_t</span> mem_cap = cct-&gt;_conf.<span class="built_in">get_val</span>&lt;<span class="type">uint64_t</span>&gt;(</span><br><span class="line">      <span class="string">&quot;bluestore_hybrid_alloc_mem_cap&quot;</span></span><br><span class="line">    );</span><br><span class="line">    alloc = <span class="keyword">new</span> <span class="built_in">HybridAllocator</span>(cct, size, block_size, mem_cap, name);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> alloc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-最佳实践"><a href="#7-最佳实践" class="headerlink" title="7. 最佳实践"></a>7. 最佳实践</h2><h3 id="7-1-配置优化"><a href="#7-1-配置优化" class="headerlink" title="7.1 配置优化"></a>7.1 配置优化</h3><h4 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ceph.conf</span></span><br><span class="line"></span><br><span class="line"><span class="section">[osd]</span></span><br><span class="line"><span class="comment"># 选择分配器类型</span></span><br><span class="line"><span class="attr">bluestore_allocator</span> = hybrid</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hybrid 分配器内存上限 (256MB)</span></span><br><span class="line"><span class="attr">bluestore_hybrid_alloc_mem_cap</span> = <span class="number">268435456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 最小分配单元 (HDD: 64KB, SSD: 4KB)</span></span><br><span class="line"><span class="attr">bluestore_min_alloc_size_hdd</span> = <span class="number">65536</span></span><br><span class="line"><span class="attr">bluestore_min_alloc_size_ssd</span> = <span class="number">4096</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># AVL 分配器参数</span></span><br><span class="line"><span class="attr">bluestore_avl_alloc_ff_max_search_count</span> = <span class="number">100</span></span><br><span class="line"><span class="attr">bluestore_avl_alloc_ff_max_search_bytes</span> = <span class="number">1048576</span></span><br></pre></td></tr></table></figure>

<h4 id="高性能-SSD-配置"><a href="#高性能-SSD-配置" class="headerlink" title="高性能 SSD 配置"></a>高性能 SSD 配置</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[osd]</span></span><br><span class="line"><span class="attr">bluestore_allocator</span> = hybrid</span><br><span class="line"><span class="attr">bluestore_hybrid_alloc_mem_cap</span> = <span class="number">536870912</span>  <span class="comment"># 512MB</span></span><br><span class="line"><span class="attr">bluestore_min_alloc_size_ssd</span> = <span class="number">4096</span></span><br></pre></td></tr></table></figure>

<h4 id="大容量-HDD-配置"><a href="#大容量-HDD-配置" class="headerlink" title="大容量 HDD 配置"></a>大容量 HDD 配置</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[osd]</span></span><br><span class="line"><span class="attr">bluestore_allocator</span> = btree</span><br><span class="line"><span class="attr">bluestore_min_alloc_size_hdd</span> = <span class="number">65536</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-监控指标"><a href="#7-2-监控指标" class="headerlink" title="7.2 监控指标"></a>7.2 监控指标</h3><h4 id="查看分配器状态"><a href="#查看分配器状态" class="headerlink" title="查看分配器状态"></a>查看分配器状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 OSD 分配器信息</span></span><br><span class="line">ceph daemon osd.0 bluestore allocator dump</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出示例</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;allocator_type&quot;</span>: <span class="string">&quot;hybrid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;capacity&quot;</span>: 10737418240,</span><br><span class="line">    <span class="string">&quot;alloc_unit&quot;</span>: 4096,</span><br><span class="line">    <span class="string">&quot;alloc_size_min&quot;</span>: 4096,</span><br><span class="line">    <span class="string">&quot;free&quot;</span>: 8589934592,</span><br><span class="line">    <span class="string">&quot;fragmentation&quot;</span>: 0.15,</span><br><span class="line">    <span class="string">&quot;num_free_ranges&quot;</span>: 12450</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关键指标"><a href="#关键指标" class="headerlink" title="关键指标"></a>关键指标</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 碎片率</span></span><br><span class="line">fragmentation_score = num_free_ranges / (free_blocks - 1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 空间利用率</span></span><br><span class="line">utilization = (capacity - free) / capacity</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分配成功率</span></span><br><span class="line">alloc_success_rate = allocated / requested</span><br></pre></td></tr></table></figure>

<h4 id="Prometheus-监控"><a href="#Prometheus-监控" class="headerlink" title="Prometheus 监控"></a>Prometheus 监控</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加监控告警</span></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ceph_allocator</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># 碎片率过高</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighFragmentation</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">ceph_bluestore_fragmentation</span> <span class="string">&gt;</span> <span class="number">0.3</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">10m</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;OSD <span class="template-variable">&#123;&#123; $labels.osd &#125;&#125;</span> fragmentation high&quot;</span></span><br><span class="line">      </span><br><span class="line">  <span class="comment"># 可用空间不足</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">LowFreeSpace</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">ceph_bluestore_free_bytes</span> <span class="string">/</span> <span class="string">ceph_bluestore_capacity_bytes</span> <span class="string">&lt;</span> <span class="number">0.1</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br></pre></td></tr></table></figure>

<h3 id="7-3-性能调优"><a href="#7-3-性能调优" class="headerlink" title="7.3 性能调优"></a>7.3 性能调优</h3><h4 id="调优步骤"><a href="#调优步骤" class="headerlink" title="调优步骤"></a>调优步骤</h4><p><strong>1. 基线测试</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 fio 测试基线性能</span></span><br><span class="line">fio --name=<span class="built_in">test</span> --ioengine=libaio --direct=1 \</span><br><span class="line">    --bs=4k --rw=randwrite --numjobs=4 \</span><br><span class="line">    --size=10G --runtime=300</span><br></pre></td></tr></table></figure>

<p><strong>2. 调整分配器</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改配置</span></span><br><span class="line">ceph config <span class="built_in">set</span> osd.* bluestore_allocator hybrid</span><br><span class="line">ceph config <span class="built_in">set</span> osd.* bluestore_hybrid_alloc_mem_cap 536870912</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启 OSD</span></span><br><span class="line">systemctl restart ceph-osd@0</span><br></pre></td></tr></table></figure>

<p><strong>3. 压力测试</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RBD 测试</span></span><br><span class="line">rbd bench --io-type write --io-size 4K --io-pattern rand test-pool/test-image</span><br><span class="line"></span><br><span class="line"><span class="comment"># RADOS 测试</span></span><br><span class="line">rados bench -p test-pool 300 write -t 32</span><br></pre></td></tr></table></figure>

<p><strong>4. 对比结果</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看性能指标</span></span><br><span class="line">ceph osd perf</span><br><span class="line">ceph daemon osd.0 perf dump</span><br></pre></td></tr></table></figure>

<h4 id="常见问题调优"><a href="#常见问题调优" class="headerlink" title="常见问题调优"></a>常见问题调优</h4><p><strong>问题 1：分配延迟高</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 症状：apply_latency 和 commit_latency 高</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方案 1：增加内存上限</span></span><br><span class="line">ceph config <span class="built_in">set</span> osd.* bluestore_hybrid_alloc_mem_cap 1073741824  <span class="comment"># 1GB</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方案 2：切换到 bitmap (SSD)</span></span><br><span class="line">ceph config <span class="built_in">set</span> osd.* bluestore_allocator bitmap</span><br></pre></td></tr></table></figure>

<p><strong>问题 2：内存占用过高</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 症状：OSD 内存使用持续增长</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方案 1：限制 hybrid 内存</span></span><br><span class="line">ceph config <span class="built_in">set</span> osd.* bluestore_hybrid_alloc_mem_cap 134217728  <span class="comment"># 128MB</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方案 2：触发碎片整理</span></span><br><span class="line">ceph osd compact &lt;osd-id&gt;</span><br></pre></td></tr></table></figure>

<p><strong>问题 3：碎片率过高</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 症状：fragmentation &gt; 0.3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方案 1：离线碎片整理</span></span><br><span class="line">systemctl stop ceph-osd@0</span><br><span class="line">ceph-bluestore-tool --path /var/lib/ceph/osd/ceph-0 \</span><br><span class="line">                    fsck --deep</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方案 2：数据重平衡</span></span><br><span class="line">ceph osd out osd.0</span><br><span class="line"><span class="comment"># 等待数据迁移</span></span><br><span class="line">ceph osd <span class="keyword">in</span> osd.0</span><br></pre></td></tr></table></figure>

<h3 id="7-4-升级和迁移"><a href="#7-4-升级和迁移" class="headerlink" title="7.4 升级和迁移"></a>7.4 升级和迁移</h3><h4 id="在线切换分配器"><a href="#在线切换分配器" class="headerlink" title="在线切换分配器"></a>在线切换分配器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 设置新分配器 (下次重启生效)</span></span><br><span class="line">ceph config <span class="built_in">set</span> osd.0 bluestore_allocator hybrid</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 安全重启 OSD</span></span><br><span class="line">ceph osd <span class="built_in">set</span> noout</span><br><span class="line">ceph osd <span class="built_in">set</span> norebalance</span><br><span class="line">systemctl restart ceph-osd@0</span><br><span class="line">ceph osd <span class="built_in">unset</span> noout</span><br><span class="line">ceph osd <span class="built_in">unset</span> norebalance</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 验证</span></span><br><span class="line">ceph daemon osd.0 config get bluestore_allocator</span><br></pre></td></tr></table></figure>

<h4 id="批量迁移"><a href="#批量迁移" class="headerlink" title="批量迁移"></a>批量迁移</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 批量切换所有 OSD 到 hybrid 分配器</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> osd <span class="keyword">in</span> $(ceph osd <span class="built_in">ls</span>); <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Processing OSD.<span class="variable">$osd</span>&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 设置配置</span></span><br><span class="line">  ceph config <span class="built_in">set</span> osd.<span class="variable">$osd</span> bluestore_allocator hybrid</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 重启</span></span><br><span class="line">  ceph osd <span class="built_in">set</span> noout</span><br><span class="line">  systemctl restart ceph-osd@<span class="variable">$osd</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 等待 OSD 恢复</span></span><br><span class="line">  <span class="keyword">while</span> ! ceph osd <span class="built_in">stat</span> | grep -q <span class="string">&quot;up <span class="subst">$((osd+1)</span>)&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">sleep</span> 5</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  </span><br><span class="line">  ceph osd <span class="built_in">unset</span> noout</span><br><span class="line">  <span class="built_in">sleep</span> 30  <span class="comment"># 间隔 30 秒</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-问题排查"><a href="#8-问题排查" class="headerlink" title="8. 问题排查"></a>8. 问题排查</h2><h3 id="8-1-常见问题"><a href="#8-1-常见问题" class="headerlink" title="8.1 常见问题"></a>8.1 常见问题</h3><h4 id="问题-1：分配失败-ENOSPC"><a href="#问题-1：分配失败-ENOSPC" class="headerlink" title="问题 1：分配失败 (ENOSPC)"></a>问题 1：分配失败 (ENOSPC)</h4><p><strong>现象：</strong></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">客户端写入失败: No <span class="literal">space</span> left <span class="keyword">on</span> device</span><br><span class="line">但 ceph df 显示还有空间</span><br></pre></td></tr></table></figure>

<p><strong>原因：</strong></p>
<ul>
<li>碎片化严重，找不到连续空间</li>
<li>分配器内部数据结构不一致</li>
</ul>
<p><strong>排查步骤：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 检查碎片率</span></span><br><span class="line">ceph daemon osd.0 bluestore allocator dump | grep fragmentation</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查空闲空间分布</span></span><br><span class="line">ceph daemon osd.0 bluestore allocator dump | grep num_free_ranges</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 查看 OSD 日志</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/ceph/ceph-osd.0.<span class="built_in">log</span> | grep -i <span class="string">&quot;alloc\|enospc&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>解决方案：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方案 1：整理碎片 (离线)</span></span><br><span class="line">ceph osd out 0</span><br><span class="line">systemctl stop ceph-osd@0</span><br><span class="line">ceph-objectstore-tool --data-path /var/lib/ceph/osd/ceph-0 \</span><br><span class="line">                       --op compact</span><br><span class="line">systemctl start ceph-osd@0</span><br><span class="line">ceph osd <span class="keyword">in</span> 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方案 2：增大分配单元 (重建 OSD)</span></span><br><span class="line">bluestore_min_alloc_size_hdd = 131072  <span class="comment"># 128KB</span></span><br></pre></td></tr></table></figure>

<h4 id="问题-2：内存泄漏"><a href="#问题-2：内存泄漏" class="headerlink" title="问题 2：内存泄漏"></a>问题 2：内存泄漏</h4><p><strong>现象：</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">OSD</span> 内存持续增长</span><br><span class="line">最终触发 OOM killer</span><br></pre></td></tr></table></figure>

<p><strong>排查步骤：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 检查分配器内存</span></span><br><span class="line">ceph daemon osd.0 dump_mempools | grep bluestore_alloc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查空闲区间数量</span></span><br><span class="line">ceph daemon osd.0 bluestore allocator dump | grep num_free_ranges</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 如果 num_free_ranges 异常大 (&gt;100万)，说明碎片严重</span></span><br></pre></td></tr></table></figure>

<p><strong>解决方案：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时：重启 OSD</span></span><br><span class="line">systemctl restart ceph-osd@0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 长期：切换到内存可控的分配器</span></span><br><span class="line">ceph config <span class="built_in">set</span> osd.0 bluestore_allocator hybrid</span><br><span class="line">ceph config <span class="built_in">set</span> osd.0 bluestore_hybrid_alloc_mem_cap 268435456</span><br></pre></td></tr></table></figure>

<h4 id="问题-3：性能抖动"><a href="#问题-3：性能抖动" class="headerlink" title="问题 3：性能抖动"></a>问题 3：性能抖动</h4><p><strong>现象：</strong></p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">写入延迟周期性升高</span><br><span class="line"><span class="keyword">iostat</span> 显示设备利用率不高</span><br></pre></td></tr></table></figure>

<p><strong>排查步骤：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 查看分配耗时</span></span><br><span class="line">ceph daemon osd.0 perf dump | grep -A 5 bluestore_alloc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 查看碎片情况</span></span><br><span class="line">ceph daemon osd.0 bluestore allocator dump</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 启用详细日志</span></span><br><span class="line">ceph daemon osd.0 config <span class="built_in">set</span> debug_bluestore 10</span><br></pre></td></tr></table></figure>

<p><strong>解决方案：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增加分配器搜索限制，避免过度搜索</span></span><br><span class="line">ceph config <span class="built_in">set</span> osd.* bluestore_avl_alloc_ff_max_search_count 50</span><br><span class="line">ceph config <span class="built_in">set</span> osd.* bluestore_avl_alloc_ff_max_search_bytes 524288</span><br></pre></td></tr></table></figure>

<h3 id="8-2-调试工具"><a href="#8-2-调试工具" class="headerlink" title="8.2 调试工具"></a>8.2 调试工具</h3><h4 id="BlueStore-Tool"><a href="#BlueStore-Tool" class="headerlink" title="BlueStore Tool"></a>BlueStore Tool</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查 allocator 状态</span></span><br><span class="line">ceph-bluestore-tool --path /var/lib/ceph/osd/ceph-0 \</span><br><span class="line">                    show-label</span><br><span class="line"></span><br><span class="line"><span class="comment"># 深度检查</span></span><br><span class="line">ceph-bluestore-tool --path /var/lib/ceph/osd/ceph-0 \</span><br><span class="line">                    fsck --deep</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看空闲空间</span></span><br><span class="line">ceph-bluestore-tool --path /var/lib/ceph/osd/ceph-0 \</span><br><span class="line">                    free-dump</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修复不一致</span></span><br><span class="line">ceph-bluestore-tool --path /var/lib/ceph/osd/ceph-0 \</span><br><span class="line">                    repair</span><br></pre></td></tr></table></figure>

<h4 id="性能分析"><a href="#性能分析" class="headerlink" title="性能分析"></a>性能分析</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 perf 分析分配器热点</span></span><br><span class="line">perf record -g -p $(pidof ceph-osd) -- <span class="built_in">sleep</span> 30</span><br><span class="line">perf report --stdio | grep -A 10 Allocator</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 gdb 调试</span></span><br><span class="line">gdb -p $(pidof ceph-osd)</span><br><span class="line">(gdb) thread apply all bt</span><br><span class="line">(gdb) <span class="built_in">print</span> allocator-&gt;get_free()</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="9-总结"><a href="#9-总结" class="headerlink" title="9. 总结"></a>9. 总结</h2><h3 id="9-1-核心要点"><a href="#9-1-核心要点" class="headerlink" title="9.1 核心要点"></a>9.1 核心要点</h3><ol>
<li><p><strong>分配器是 BlueStore 的核心</strong></p>
<ul>
<li>直接影响性能、内存、碎片</li>
</ul>
</li>
<li><p><strong>五种实现，各有千秋</strong></p>
<ul>
<li>Stupid: 测试用</li>
<li>Bitmap: SSD 优化，内存固定</li>
<li>AVL: 通用，动态平衡</li>
<li>Btree: 大设备优化</li>
<li><strong>Hybrid: 生产首选</strong> ⭐</li>
</ul>
</li>
<li><p><strong>关键权衡</strong></p>
<ul>
<li>性能 vs 内存</li>
<li>碎片控制 vs 分配速度</li>
<li>简单 vs 功能</li>
</ul>
</li>
<li><p><strong>实践建议</strong></p>
<ul>
<li>默认使用 Hybrid</li>
<li>监控碎片率和内存</li>
<li>定期整理碎片</li>
<li>根据负载调优</li>
</ul>
</li>
</ol>
<h3 id="9-2-决策建议"><a href="#9-2-决策建议" class="headerlink" title="9.2 决策建议"></a>9.2 决策建议</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">你应该使用哪个分配器？</span><br><span class="line"></span><br><span class="line">┌─────────────────────────────────────┐</span><br><span class="line">│  生产环境？                          │</span><br><span class="line">│  ├─ 是 → Hybrid Allocator ⭐⭐⭐    │</span><br><span class="line">│  └─ 否 → Stupid (测试) <span class="symbol">/</span> AVL        │</span><br><span class="line">└─────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">特殊场景：</span><br><span class="line">• 高性能 SSD <span class="operator">+</span> 内存充足 → Bitmap</span><br><span class="line">• 超大设备 (<span class="operator">&gt;</span><span class="number">20</span>TB) → Btree</span><br><span class="line">• 内存严格受限 → Hybrid (设置 mem_cap)</span><br></pre></td></tr></table></figure>

<h3 id="9-3-未来展望"><a href="#9-3-未来展望" class="headerlink" title="9.3 未来展望"></a>9.3 未来展望</h3><p>Ceph 社区正在持续优化分配器：</p>
<ol>
<li><p><strong>更智能的策略</strong></p>
<ul>
<li>基于 workload 的自适应分配</li>
<li>机器学习优化位置选择</li>
</ul>
</li>
<li><p><strong>更低的开销</strong></p>
<ul>
<li>无锁数据结构</li>
<li>并行分配</li>
</ul>
</li>
<li><p><strong>更好的碎片控制</strong></p>
<ul>
<li>在线碎片整理</li>
<li>预测性空间管理</li>
</ul>
</li>
<li><p><strong>持久化内存支持</strong></p>
<ul>
<li>PMem 加速元数据</li>
<li>降低重启恢复时间</li>
</ul>
</li>
</ol>
<hr>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><p><strong>源码</strong></p>
<ul>
<li><code>src/os/bluestore/Allocator.h</code> - 分配器接口</li>
<li><code>src/os/bluestore/*Allocator.cc</code> - 各实现</li>
</ul>
</li>
<li><p><strong>文档</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/rados/configuration/bluestore-config-ref/">BlueStore Configuration Reference</a></li>
<li><a target="_blank" rel="noopener" href="https://ceph.io/en/news/blog/2016/bluestore-allocator-performance/">BlueStore Allocator Analysis</a></li>
</ul>
</li>
<li><p><strong>论文</strong></p>
<ul>
<li>“BlueStore: A New, Faster Storage Backend for Ceph”</li>
</ul>
</li>
<li><p><strong>社区</strong></p>
<ul>
<li>Ceph Dev Mailing List</li>
<li>#ceph-devel IRC</li>
</ul>
</li>
</ol>
<hr>
<h2 id="关于作者"><a href="#关于作者" class="headerlink" title="关于作者"></a>关于作者</h2><p>by hoshi<br>本文基于 Ceph 最新代码（Pacific&#x2F;Quincy 版本）分析编写，涵盖了分配器的设计原理、实现细节和最佳实践。</p>
<hr>
<p><strong>如果觉得本文有帮助，欢迎分享！</strong> 🚀</p>
<p>有任何问题或建议，欢迎提 Issue 。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ceph/" rel="tag"># ceph</a>
              <a href="/tags/seastore/" rel="tag"># seastore</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/09/27/nvme-device/" rel="prev" title="crimson中的设备管理从Nvme 到Seastore">
      <i class="fa fa-chevron-left"></i> crimson中的设备管理从Nvme 到Seastore
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/10/13/Ceph-RBD%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" rel="next" title="Ceph-RBD源码阅读">
      Ceph-RBD源码阅读 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC82MDkyNS8zNzM5NQ=="></div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Ceph-BlueStore-%E5%88%86%E9%85%8D%E5%99%A8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">Ceph BlueStore 分配器深度解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95"><span class="nav-number">1.1.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%BC%95%E8%A8%80"><span class="nav-number">1.2.</span> <span class="nav-text">1. 引言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AC%E6%96%87%E9%80%82%E5%90%88%E8%B0%81%EF%BC%9F"><span class="nav-number">1.2.1.</span> <span class="nav-text">本文适合谁？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%88%86%E9%85%8D%E5%99%A8"><span class="nav-number">1.3.</span> <span class="nav-text">2. 为什么需要分配器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-BlueStore-%E7%9A%84%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84"><span class="nav-number">1.3.1.</span> <span class="nav-text">2.1 BlueStore 的存储架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%88%86%E9%85%8D%E5%99%A8%E7%9A%84%E6%A0%B8%E5%BF%83%E9%97%AE%E9%A2%98"><span class="nav-number">1.3.2.</span> <span class="nav-text">2.2 分配器的核心问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98-1%EF%BC%9A%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E6%9F%A5%E6%89%BE%E7%A9%BA%E9%97%B2%E7%A9%BA%E9%97%B4%EF%BC%9F"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">问题 1：如何高效查找空闲空间？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98-2%EF%BC%9A%E5%A6%82%E4%BD%95%E6%8E%A7%E5%88%B6%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%EF%BC%9F"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">问题 2：如何控制内存占用？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98-3%EF%BC%9A%E5%A6%82%E4%BD%95%E5%87%8F%E5%B0%91%E7%A2%8E%E7%89%87%EF%BC%9F"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">问题 3：如何减少碎片？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98-4%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E5%B9%B6%E5%8F%91%E6%80%A7%E8%83%BD%EF%BC%9F"><span class="nav-number">1.3.2.4.</span> <span class="nav-text">问题 4：如何保证并发性能？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%88%86%E9%85%8D%E5%99%A8%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.4.</span> <span class="nav-text">3. 分配器架构设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E6%A0%B8%E5%BF%83%E6%8E%A5%E5%8F%A3"><span class="nav-number">1.4.1.</span> <span class="nav-text">3.1 核心接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E5%85%B3%E9%94%AE%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.4.2.</span> <span class="nav-text">3.2 关键数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Extent%EF%BC%88%E5%8C%BA%E6%AE%B5%EF%BC%89"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">Extent（区段）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E9%85%8D%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">分配示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.4.3.</span> <span class="nav-text">3.3 工作流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E4%BA%94%E7%A7%8D%E5%88%86%E9%85%8D%E5%99%A8%E5%AE%9E%E7%8E%B0%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.5.</span> <span class="nav-text">4. 五种分配器实现详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-StupidAllocator%EF%BC%88%E7%AE%80%E5%8D%95%E5%88%86%E9%85%8D%E5%99%A8%EF%BC%89"><span class="nav-number">1.5.1.</span> <span class="nav-text">4.1 StupidAllocator（简单分配器）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">设计原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5"><span class="nav-number">1.5.1.2.</span> <span class="nav-text">分配策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-number">1.5.1.3.</span> <span class="nav-text">优缺点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-BitmapAllocator%EF%BC%88%E4%BD%8D%E5%9B%BE%E5%88%86%E9%85%8D%E5%99%A8%EF%BC%89"><span class="nav-number">1.5.2.</span> <span class="nav-text">4.2 BitmapAllocator（位图分配器）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86-1"><span class="nav-number">1.5.2.1.</span> <span class="nav-text">设计原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.5.2.2.</span> <span class="nav-text">数据结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5-1"><span class="nav-number">1.5.2.3.</span> <span class="nav-text">分配策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-1"><span class="nav-number">1.5.2.4.</span> <span class="nav-text">优缺点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-AvlAllocator%EF%BC%88AVL-%E6%A0%91%E5%88%86%E9%85%8D%E5%99%A8%EF%BC%89"><span class="nav-number">1.5.3.</span> <span class="nav-text">4.3 AvlAllocator（AVL 树分配器）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86-2"><span class="nav-number">1.5.3.1.</span> <span class="nav-text">设计原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.5.3.2.</span> <span class="nav-text">可视化示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5"><span class="nav-number">1.5.3.3.</span> <span class="nav-text">动态分配策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-2"><span class="nav-number">1.5.3.4.</span> <span class="nav-text">优缺点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-BtreeAllocator%EF%BC%88B-%E6%A0%91%E5%88%86%E9%85%8D%E5%99%A8%EF%BC%89"><span class="nav-number">1.5.4.</span> <span class="nav-text">4.4 BtreeAllocator（B 树分配器）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86-3"><span class="nav-number">1.5.4.1.</span> <span class="nav-text">设计原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#B-tree-vs-AVL"><span class="nav-number">1.5.4.2.</span> <span class="nav-text">B-tree vs AVL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-3"><span class="nav-number">1.5.4.3.</span> <span class="nav-text">优缺点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-HybridAllocator%EF%BC%88%E6%B7%B7%E5%90%88%E5%88%86%E9%85%8D%E5%99%A8%EF%BC%89%E2%AD%90-%E6%8E%A8%E8%8D%90"><span class="nav-number">1.5.5.</span> <span class="nav-text">4.5 HybridAllocator（混合分配器）⭐ 推荐</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86-4"><span class="nav-number">1.5.5.1.</span> <span class="nav-text">设计原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.5.5.2.</span> <span class="nav-text">工作流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%8E%A7%E5%88%B6%E7%AD%96%E7%95%A5"><span class="nav-number">1.5.5.3.</span> <span class="nav-text">内存控制策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-4"><span class="nav-number">1.5.5.4.</span> <span class="nav-text">优缺点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E4%B8%8E%E9%80%89%E6%8B%A9"><span class="nav-number">1.6.</span> <span class="nav-text">5. 性能对比与选择</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E7%BB%BC%E5%90%88%E5%AF%B9%E6%AF%94%E8%A1%A8"><span class="nav-number">1.6.1.</span> <span class="nav-text">5.1 综合对比表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E9%80%89%E6%8B%A9%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.6.2.</span> <span class="nav-text">5.2 选择建议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%B3%E7%AD%96%E6%A0%91"><span class="nav-number">1.6.2.1.</span> <span class="nav-text">决策树</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF%E6%8E%A8%E8%8D%90"><span class="nav-number">1.6.2.2.</span> <span class="nav-text">场景推荐</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-number">1.7.</span> <span class="nav-text">6. 源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E6%A0%B8%E5%BF%83%E5%88%86%E9%85%8D%E6%B5%81%E7%A8%8B"><span class="nav-number">1.7.1.</span> <span class="nav-text">6.1 核心分配流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-AVL-%E5%88%86%E9%85%8D%E5%99%A8%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="nav-number">1.7.2.</span> <span class="nav-text">6.2 AVL 分配器核心代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-%E5%88%86%E9%85%8D%E5%99%A8%E5%88%9B%E5%BB%BA"><span class="nav-number">1.7.3.</span> <span class="nav-text">6.3 分配器创建</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.8.</span> <span class="nav-text">7. 最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96"><span class="nav-number">1.8.1.</span> <span class="nav-text">7.1 配置优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="nav-number">1.8.1.1.</span> <span class="nav-text">基础配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%AB%98%E6%80%A7%E8%83%BD-SSD-%E9%85%8D%E7%BD%AE"><span class="nav-number">1.8.1.2.</span> <span class="nav-text">高性能 SSD 配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%A7%E5%AE%B9%E9%87%8F-HDD-%E9%85%8D%E7%BD%AE"><span class="nav-number">1.8.1.3.</span> <span class="nav-text">大容量 HDD 配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87"><span class="nav-number">1.8.2.</span> <span class="nav-text">7.2 监控指标</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%88%86%E9%85%8D%E5%99%A8%E7%8A%B6%E6%80%81"><span class="nav-number">1.8.2.1.</span> <span class="nav-text">查看分配器状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E6%8C%87%E6%A0%87"><span class="nav-number">1.8.2.2.</span> <span class="nav-text">关键指标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Prometheus-%E7%9B%91%E6%8E%A7"><span class="nav-number">1.8.2.3.</span> <span class="nav-text">Prometheus 监控</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98"><span class="nav-number">1.8.3.</span> <span class="nav-text">7.3 性能调优</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E4%BC%98%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.8.3.1.</span> <span class="nav-text">调优步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%B0%83%E4%BC%98"><span class="nav-number">1.8.3.2.</span> <span class="nav-text">常见问题调优</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-%E5%8D%87%E7%BA%A7%E5%92%8C%E8%BF%81%E7%A7%BB"><span class="nav-number">1.8.4.</span> <span class="nav-text">7.4 升级和迁移</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8%E7%BA%BF%E5%88%87%E6%8D%A2%E5%88%86%E9%85%8D%E5%99%A8"><span class="nav-number">1.8.4.1.</span> <span class="nav-text">在线切换分配器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E8%BF%81%E7%A7%BB"><span class="nav-number">1.8.4.2.</span> <span class="nav-text">批量迁移</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5"><span class="nav-number">1.9.</span> <span class="nav-text">8. 问题排查</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-number">1.9.1.</span> <span class="nav-text">8.1 常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98-1%EF%BC%9A%E5%88%86%E9%85%8D%E5%A4%B1%E8%B4%A5-ENOSPC"><span class="nav-number">1.9.1.1.</span> <span class="nav-text">问题 1：分配失败 (ENOSPC)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98-2%EF%BC%9A%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F"><span class="nav-number">1.9.1.2.</span> <span class="nav-text">问题 2：内存泄漏</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98-3%EF%BC%9A%E6%80%A7%E8%83%BD%E6%8A%96%E5%8A%A8"><span class="nav-number">1.9.1.3.</span> <span class="nav-text">问题 3：性能抖动</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7"><span class="nav-number">1.9.2.</span> <span class="nav-text">8.2 调试工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#BlueStore-Tool"><span class="nav-number">1.9.2.1.</span> <span class="nav-text">BlueStore Tool</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="nav-number">1.9.2.2.</span> <span class="nav-text">性能分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-%E6%80%BB%E7%BB%93"><span class="nav-number">1.10.</span> <span class="nav-text">9. 总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-%E6%A0%B8%E5%BF%83%E8%A6%81%E7%82%B9"><span class="nav-number">1.10.1.</span> <span class="nav-text">9.1 核心要点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-%E5%86%B3%E7%AD%96%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.10.2.</span> <span class="nav-text">9.2 决策建议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-%E6%9C%AA%E6%9D%A5%E5%B1%95%E6%9C%9B"><span class="nav-number">1.10.3.</span> <span class="nav-text">9.3 未来展望</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">1.11.</span> <span class="nav-text">参考资料</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E4%BD%9C%E8%80%85"><span class="nav-number">1.12.</span> <span class="nav-text">关于作者</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="lzy"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">lzy</p>
  <div class="site-description" itemprop="description">选择有时候比努力更重要</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hoshilzy1026" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hoshilzy1026" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:18338064521@163.com" title="E-Mail → mailto:18338064521@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/6888391895" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;6888391895" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/31529112/ffhoshi" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;31529112&#x2F;ffhoshi" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
  </div>



      </div>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=36019737&auto=1&height=66"></iframe>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021-12 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lzy</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">42k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">2:34</span>
</div>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
<span class="post-meta-divider">|</span>
<span id="busuanzi_container_site_uv">本站访客数<span id="busuanzi_value_site_uv"></span>人</span>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>

</body>
</html>
