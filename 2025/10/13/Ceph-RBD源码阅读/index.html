<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-m.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-m.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hoshilzy1026.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="RBD 是 Ceph 分布式存储系统中提供的块存储服务 该篇主要针对 RBD 中的整体架构以及 IO 流程进行介绍 针对 librbd 中提供的接口进行简单介绍，后续将在此基础上进行实战">
<meta property="og:type" content="article">
<meta property="og:title" content="Ceph-RBD源码阅读">
<meta property="og:url" content="https://hoshilzy1026.github.io/2025/10/13/Ceph-RBD%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/index.html">
<meta property="og:site_name" content="Hoshi">
<meta property="og:description" content="RBD 是 Ceph 分布式存储系统中提供的块存储服务 该篇主要针对 RBD 中的整体架构以及 IO 流程进行介绍 针对 librbd 中提供的接口进行简单介绍，后续将在此基础上进行实战">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200914101756.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zjs1224522500/files-and-images/master/blog/pic/RBD-Arch.png">
<meta property="og:image" content="https://github.com/zjs1224522500/files-and-images/blob/master/blog/pic/RBD-IO-Frame.png?raw=true">
<meta property="og:image" content="https://github.com/zjs1224522500/files-and-images/blob/master/blog/pic/RBD-IO.png?raw=true">
<meta property="og:image" content="https://github.com/zjs1224522500/files-and-images/blob/master/blog/pic/librbd-io.png?raw=true">
<meta property="og:image" content="https://zhoubofsy.github.io/images/ceph/librbd_frame.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200914102334.png">
<meta property="og:image" content="https://github.com/zjs1224522500/files-and-images/blob/master/blog/pic/rbd-io-time-sequence.png?raw=true">
<meta property="og:image" content="https://zhoubofsy.github.io/images/ceph/librbd.png">
<meta property="og:image" content="https://github.com/zjs1224522500/files-and-images/blob/0d8833c01f0f0d26954bbe6dfcfddce1b60eb9a9/blog/pic/librbd-io-method-stack.png?raw=true">
<meta property="article:published_time" content="2025-10-13T10:03:00.000Z">
<meta property="article:modified_time" content="2025-10-13T11:44:30.843Z">
<meta property="article:author" content="lzy">
<meta property="article:tag" content="存储">
<meta property="article:tag" content="分布式">
<meta property="article:tag" content="ceph">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200914101756.png">

<link rel="canonical" href="https://hoshilzy1026.github.io/2025/10/13/Ceph-RBD%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Ceph-RBD源码阅读 | Hoshi</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y6XQ2TRE3Y"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-Y6XQ2TRE3Y');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hoshi</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://hoshilzy1026.github.io/2025/10/13/Ceph-RBD%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lzy">
      <meta itemprop="description" content="选择有时候比努力更重要">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hoshi">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Ceph-RBD源码阅读
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-10-13 18:03:00 / 修改时间：19:44:30" itemprop="dateCreated datePublished" datetime="2025-10-13T18:03:00+08:00">2025-10-13</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>29 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <ul>
<li>RBD 是 Ceph 分布式存储系统中提供的块存储服务</li>
<li>该篇主要针对 RBD 中的整体架构以及 IO 流程进行介绍</li>
<li>针对 librbd 中提供的接口进行简单介绍，后续将在此基础上进行实战<span id="more"></span></li>
</ul>
<h2 id="Ceph-RBD"><a href="#Ceph-RBD" class="headerlink" title="Ceph RBD"></a>Ceph RBD</h2><ul>
<li><p><strong>RBD：RADOS Block Devices</strong>. Ceph block devices are thin-provisioned, resizable and store data striped over multiple OSDs in a Ceph cluster.</p>
<p><img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200914101756.png" alt="image-20251013180551137"></p>
</li>
</ul>
<h2 id="整体介绍"><a href="#整体介绍" class="headerlink" title="整体介绍"></a>整体介绍</h2><ul>
<li><p>Ceph RBD 模块主要提供了两种对外接口：</p>
<ul>
<li>一种是基于 librados 的用户态接口库 librbd，支持 C&#x2F;C++ 接口以及 Python 等高级语言的绑定；</li>
<li>另外一种是通过 kernel Module 的方式（一个叫 krbd 的内核模块），通过用户态的 rbd 命令行工具，将 RBD 块设备映射为本地的一个块设备文件。</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/zjs1224522500/files-and-images/master/blog/pic/RBD-Arch.png" alt="image-20251013180624588"></p>
<ul>
<li>RDB 的块设备由于元数据信息少而且访问不频繁，故 RBD 在 Ceph 集群中不需要单独的守护进程讲元数据加载到内存进行元数据访问加速，所有的元数据和数据操作直接与集群中的 Monitor 服务和 OSD 服务进行交互。</li>
</ul>
<p>RBD IO 流</p>
<ul>
<li>RBD 模块 IO 流图</li>
</ul>
<p><img src="https://github.com/zjs1224522500/files-and-images/blob/master/blog/pic/RBD-IO-Frame.png?raw=true" alt="image-20251013180709817"></p>
<h3 id="几个重要的存储组织"><a href="#几个重要的存储组织" class="headerlink" title="几个重要的存储组织"></a>几个重要的存储组织</h3><ul>
<li>Pool：存储资源池。IO 之前，需要先创建一个存储池，存储池统一地对逻辑存储单元进行管理，并对其进行初始化。同时指定一个 Pool 中的 PG 数量。是 Ceph 存储数据时的逻辑分区，类似于 HDFS 中的 namespace</li>
</ul>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool <span class="keyword">create</span> rbd <span class="number">32</span></span><br><span class="line">rbd <span class="keyword">pool</span> init rbd</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>RBD：块设备镜像。在创建好 Pool 的基础之上，对应的创建块设备镜像并和存储池进行映射绑定</p>
</li>
<li><p>Object：按照数据切片的大小，将所有数据切片为一个个对象，进行相应的对象存储操作。其中 Key 需要根据序号进行生成从而进行区分。</p>
</li>
</ul>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rbd create --<span class="built_in">size</span> &#123;megabytes&#125; &#123;pool-<span class="built_in">name</span>&#125;/&#123;<span class="built_in">image</span>-<span class="built_in">name</span>&#125;</span><br><span class="line">rbd create --<span class="built_in">size</span> <span class="number">1024</span> swimmingpool/bar</span><br></pre></td></tr></table></figure>

<ul>
<li>PG：Placement Group，用于放置标准大小的 Object 的载体。其数量的计算公式：<code>Total PGs = (Total_number_of_OSD * 100) / max_replication_count</code> 再对结果向上取 2 的 N 次方作为最终的数量。PG 同时作为数据均衡和迁移的最小单位，PG 也有相应的主从之分。</li>
<li>OSD：OSD 是负责物理存储的进程，也可以理解为最终的对象存储节点。一般情况下，一块磁盘启动一个 OSD 进程，一组 PG （多副本）分布在不同的 OSD 上。</li>
</ul>
<h3 id="IO流程"><a href="#IO流程" class="headerlink" title="IO流程"></a>IO流程</h3><ol>
<li>客户端创建对应的存储池 Pool，指定相应的 PG 个数以及 PGP 个数（用于 PG 中的数据均衡）</li>
<li>创建 pool&#x2F;image rbd设备进行挂载</li>
<li>用户写入的数据进行切块，每个块有默认大小，并且每个块都有一个 Key，Key 就是 object+序号</li>
<li>将每个 object 通过 pg 进行副本位置的分配</li>
<li>PG 根据 cursh 算法会寻找指定个数的 osd（主从个数），把这个 object 分别保存在这些 osd 上</li>
<li>osd 上实际是把底层的 disk 进行了格式化操作，一般部署工具会将它格式化为 xfs 文件系统</li>
<li>object 的存储就变成了存储一个文件 rbd0.object1.file</li>
</ol>
<h4 id="RBD-IO-框架"><a href="#RBD-IO-框架" class="headerlink" title="RBD IO 框架"></a>RBD IO 框架</h4><p><img src="https://github.com/zjs1224522500/files-and-images/blob/master/blog/pic/RBD-IO.png?raw=true" alt="image-20251013180845441"></p>
<h5 id="客户端写数据osd过程："><a href="#客户端写数据osd过程：" class="headerlink" title="客户端写数据osd过程："></a>客户端写数据osd过程：</h5><ol>
<li>采用的是 librbd 的形式，使用 librbd 创建一个块设备，向这个块设备中写入数据</li>
<li>在客户端本地同过调用 librados 接口，然后经过 pool，rbd，object，pg 进行层层映射（CRUSH 算法）,在 PG 这一层中，可以知道数据保存在哪几个 OSD 上，这几个 OSD 分为主从的关系</li>
<li>客户端与 primary OSD 建立 SOCKET 通信，将要写入的数据传给 primary OSD，由 primary OSD 再将数据发送给其他 replica OSD 数据节点。</li>
</ol>
<h3 id="librbd"><a href="#librbd" class="headerlink" title="librbd"></a>librbd</h3><ul>
<li>librbd 到 OSD 的数据流向如下：</li>
</ul>
<p><img src="https://github.com/zjs1224522500/files-and-images/blob/master/blog/pic/librbd-io.png?raw=true" alt="image-20251013180929259"></p>
<h4 id="模块介绍"><a href="#模块介绍" class="headerlink" title="模块介绍"></a>模块介绍</h4><ul>
<li><strong>librbd</strong>：Librbd 是Ceph提供的块存储接口的抽象，它提供C&#x2F;C++、Python等多种接口。对于C++，最主要的两个类就是RBD 和 Image。 RBD 主要负责创建、删除、克隆映像等操作，而Image 类负责映像的读写等操作。</li>
<li><strong>cls_rbd</strong>：cls_rbd是Cls的一个扩展模块，Cls允许用户自定义对象的操作接口和实现方法，为用户提供了一种比较直接的接口扩展方式。通过动态链接的形式加入 osd 中，在 osd 上直接执行。</li>
<li><strong>librados</strong>：librados 提供客户端访问 Ceph 集群的原生态统一接口。其它接口或者命令行工具都基于该动态库实现。在 librados 中实现了 Crush 算法和网络通信等公共功能，数据请求操作在 librados 计算完成后可以直接与对应的 OSD 交互进行数据传输。</li>
<li><strong>OSDC</strong>：该模块是客户端模块比较底层的模块，用于封装操作数据，计算对象的地址、发送请求和处理超时。</li>
<li><strong>OSD</strong>：部署在每一个硬盘上的 OSD 进程，主要功能是存储数据、复制数据、平衡数据、恢复数据等，与其它OSD间进行心跳检查等，并将一些变化情况上报给Ceph Monitor</li>
<li><strong>OS</strong>：操作系统，在此处则主要是 OSD 的 IO 请求下发到对应的硬盘上的文件系统，由文件系统来完成后续的 IO 操作。</li>
</ul>
<h4 id="librbd-详细介绍"><a href="#librbd-详细介绍" class="headerlink" title="librbd 详细介绍"></a>librbd 详细介绍</h4><h5 id="功能模块"><a href="#功能模块" class="headerlink" title="功能模块"></a>功能模块</h5><p><img src="https://zhoubofsy.github.io/images/ceph/librbd_frame.png" alt="image-20251013181006183"></p>
<h5 id="核心机制"><a href="#核心机制" class="headerlink" title="核心机制"></a>核心机制</h5><ul>
<li>librbd 是一个将 block io （[off, len]）转换成 rados object io （[oid, off, len]）的中间层。为了支持高性能 io 处理，其内部维护了一个 io 队列，一个异步回调队列，以及对这两个队列中的请求进行处理的线程池，如下图所示。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/zjs1224522500/PicGoImages/master//img/blog/20200914102334.png" alt="image-20251013181046546"></p>
<ul>
<li>IO 时序图</li>
</ul>
<p><img src="https://github.com/zjs1224522500/files-and-images/blob/master/blog/pic/rbd-io-time-sequence.png?raw=true" alt="image-20251013181116443"></p>
<ul>
<li><p>librbd 提供了针对 image 的数据读写和管理操作两种访问接口，其中数据读写请求入 <code>io_work_queue</code>，然后由线程池中的线程将 io 请求以 object 粒度切分并分别调用 rados 层的 aio 接口（IoCtxImpl）下发，当所有的 object 请求完成时，调用 librbd io 回调（librbd::io::AioCompletion）完成用户层的数据 io。而对 image 的管理操作通常需要涉及单个或多个对象的多次访问以及对内部状态的多次更新，其第一次访问将从用户线程调用至 rados 层 aio 接口或更新状态后入 <code>op_work_queue</code> 队列进行异步调用，当 rados aio 层回调或 Context 完成时再根据实现逻辑调用新的 rados aio 或构造 Context 回调，如此反复，最后调用应用层的回调完成管理操作请求。</p>
</li>
<li><p>此外为了支持多客户端共享访问 image，librbd 提供了构建于 rados watch&#x2F;notify 之上的通知、远程执行以及 exclusive lock 分布式锁机制。每个 librbd 客户端在打开 image 时（以非只读方式打开）都会 watch image 的 header 对象，从远程发往本地客户端的通知消息或者内部的 watch 错误消息会通过 RadosClient 的 Finisher 线程入 op_work_queue 队列进行异步处理。</p>
</li>
</ul>
<h5 id="组成元素"><a href="#组成元素" class="headerlink" title="组成元素"></a>组成元素</h5><ul>
<li>image 主要由 <code>rbd_header</code> 元数据 rados 对象及 <code>rbd_data</code> 数据 rados 对象组成，随着特性的增加会增加其它一些元数据对象，但 librbd 内部的运行机制并不会有大的变化，一切都以异步 io、事件（请求）驱动为基础。</li>
</ul>
<h5 id="相关接口声明"><a href="#相关接口声明" class="headerlink" title="相关接口声明"></a>相关接口声明</h5><ul>
<li>此处以 librbd 的 C++ 库 <a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/blob/master/src/include/rbd/librbd.hpp">librbd.hpp</a> 为例对 librbd 提供的相关功能 API 进行介绍（除此以外还提供了 C 语言的相关库 <a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/blob/master/src/include/rbd/librbd.h">librbd.h</a>）</li>
<li>librbd 提供的接口导图如下：</li>
</ul>
<p><img src="https://zhoubofsy.github.io/images/ceph/librbd.png" alt="image-20251013181207380"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> librbd &#123; <span class="comment">// 库在librbd名字空间中</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">using</span> librados::IoCtx; <span class="comment">// librados 库对外提供的接口</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Image</span>;</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">ImageOptions</span>;</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">PoolStats</span>;</span><br><span class="line">  <span class="keyword">typedef</span> <span class="type">void</span> *<span class="type">image_ctx_t</span>;</span><br><span class="line">  <span class="keyword">typedef</span> <span class="type">void</span> *<span class="type">completion_t</span>;</span><br><span class="line">  <span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*<span class="type">callback_t</span>)</span><span class="params">(<span class="type">completion_t</span> cb, <span class="type">void</span> *arg)</span></span>; <span class="comment">// 异步操作回调接口</span></span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CEPH_RBD_API</span> RBD</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">RBD</span>();</span><br><span class="line">  ~<span class="built_in">RBD</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This must be dynamically allocated with new, and</span></span><br><span class="line">  <span class="comment">// must be released with release().</span></span><br><span class="line">  <span class="comment">// Do not use delete.</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">AioCompletion</span> &#123;</span><br><span class="line">    <span class="type">void</span> *pc;</span><br><span class="line">    <span class="built_in">AioCompletion</span>(<span class="type">void</span> *cb_arg, <span class="type">callback_t</span> complete_cb);</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">is_complete</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">wait_for_complete</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">ssize_t</span> <span class="title">get_return_value</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">release</span><span class="params">()</span></span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 接下来一些API: open/create/clone/remove/rename/list/migration 等</span></span><br><span class="line">  <span class="comment">// RBD groups support functions  create/remove/list/rename</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">/* We don&#x27;t allow assignment or copying */</span></span><br><span class="line">  <span class="built_in">RBD</span>(<span class="type">const</span> RBD&amp; rhs);</span><br><span class="line">  <span class="type">const</span> RBD&amp; <span class="keyword">operator</span>=(<span class="type">const</span> RBD&amp; rhs);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Image 参数设置</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CEPH_RBD_API</span> ImageOptions &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">ImageOptions</span>();</span><br><span class="line">  <span class="built_in">ImageOptions</span>(<span class="type">rbd_image_options_t</span> opts);</span><br><span class="line">  <span class="built_in">ImageOptions</span>(<span class="type">const</span> ImageOptions &amp;imgopts);</span><br><span class="line">  ~<span class="built_in">ImageOptions</span>();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">set</span><span class="params">(<span class="type">int</span> optname, <span class="type">const</span> std::string&amp; optval)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">set</span><span class="params">(<span class="type">int</span> optname, <span class="type">uint64_t</span> optval)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">get</span><span class="params">(<span class="type">int</span> optname, std::string* optval)</span> <span class="type">const</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">get</span><span class="params">(<span class="type">int</span> optname, <span class="type">uint64_t</span>* optval)</span> <span class="type">const</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">is_set</span><span class="params">(<span class="type">int</span> optname, <span class="type">bool</span>* is_set)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">unset</span><span class="params">(<span class="type">int</span> optname)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">RBD</span>;</span><br><span class="line">  <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">Image</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">rbd_image_options_t</span> opts;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 存储池 Pool 状态</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CEPH_RBD_API</span> PoolStats &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">PoolStats</span>();</span><br><span class="line">  ~<span class="built_in">PoolStats</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">PoolStats</span>(<span class="type">const</span> PoolStats&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">  PoolStats&amp; <span class="keyword">operator</span>=(<span class="type">const</span> PoolStats&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">add</span><span class="params">(<span class="type">rbd_pool_stat_option_t</span> option, <span class="type">uint64_t</span>* opt_val)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">RBD</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">rbd_pool_stats_t</span> pool_stats;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CEPH_RBD_API</span> UpdateWatchCtx &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">UpdateWatchCtx</span>() &#123;&#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Callback activated when we receive a notify event.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">handle_notify</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CEPH_RBD_API</span> Image</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Image</span>();</span><br><span class="line">  ~<span class="built_in">Image</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 镜像的读写，flatten，trim等操作</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">RBD</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Image</span>(<span class="type">const</span> Image&amp; rhs);</span><br><span class="line">  <span class="type">const</span> Image&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Image&amp; rhs);</span><br><span class="line"></span><br><span class="line">  <span class="type">image_ctx_t</span> ctx; <span class="comment">// viod*, 实际指向具体实现的类</span></span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="class-CEPH-RBD-API-RBD"><a href="#class-CEPH-RBD-API-RBD" class="headerlink" title="class CEPH_RBD_API RBD"></a>class CEPH_RBD_API RBD</h5><ul>
<li>RBD 主要负责 Image 的创建、删除、重命名、克隆映像等操作，包括对存储池的元数据的管理</li>
<li>针对部分操作提供异步接口</li>
</ul>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">CEPH_RBD_API</span> <span class="type">RBD</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="class">public:</span></span><br><span class="line"><span class="class">  <span class="type">RBD</span>();</span></span><br><span class="line"><span class="class">  ~<span class="type">RBD</span>();</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  // <span class="type">This</span> must be dynamically allocated with new, and</span></span><br><span class="line"><span class="class">  // must be released with release().</span></span><br><span class="line"><span class="class">  // <span class="type">Do</span> not use delete.</span></span><br><span class="line"><span class="class">  struct <span class="type">AioCompletion</span> &#123;</span></span><br><span class="line"><span class="class">    void *pc;</span></span><br><span class="line"><span class="class">    <span class="type">AioCompletion</span>(<span class="title">void</span> *<span class="title">cb_arg</span>, <span class="title">callback_t</span> <span class="title">complete_cb</span>);</span></span><br><span class="line"><span class="class">    bool is_complete();</span></span><br><span class="line"><span class="class">    int wait_for_complete();</span></span><br><span class="line"><span class="class">    ssize_t get_return_value();</span></span><br><span class="line"><span class="class">    void *get_arg();</span></span><br><span class="line"><span class="class">    void release();</span></span><br><span class="line"><span class="class">  &#125;;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  void version(<span class="title">int</span> *<span class="title">major</span>, <span class="title">int</span> *<span class="title">minor</span>, <span class="title">int</span> *<span class="title">extra</span>);</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  int open(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="type">Image</span>&amp; <span class="title">image</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>);</span></span><br><span class="line"><span class="class">  int open(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="type">Image</span>&amp; <span class="title">image</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">snapname</span>);</span></span><br><span class="line"><span class="class">  int open_by_id(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="type">Image</span>&amp; <span class="title">image</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">id</span>);</span></span><br><span class="line"><span class="class">  int open_by_id(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="type">Image</span>&amp; <span class="title">image</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">id</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">snapname</span>);</span></span><br><span class="line"><span class="class">  int aio_open(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="type">Image</span>&amp; <span class="title">image</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>,</span></span><br><span class="line"><span class="class">	       <span class="title">const</span> <span class="title">char</span> *<span class="title">snapname</span>, <span class="type">RBD</span>::<span class="type">AioCompletion</span> *<span class="title">c</span>);</span></span><br><span class="line"><span class="class">  int aio_open_by_id(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="type">Image</span>&amp; <span class="title">image</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">id</span>,</span></span><br><span class="line"><span class="class">	             <span class="title">const</span> <span class="title">char</span> *<span class="title">snapname</span>, <span class="type">RBD</span>::<span class="type">AioCompletion</span> *<span class="title">c</span>);</span></span><br><span class="line"><span class="class">  // see librbd.h</span></span><br><span class="line"><span class="class">  int open_read_only(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="type">Image</span>&amp; <span class="title">image</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>,</span></span><br><span class="line"><span class="class">		     <span class="title">const</span> <span class="title">char</span> *<span class="title">snapname</span>);</span></span><br><span class="line"><span class="class">  int open_by_id_read_only(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="type">Image</span>&amp; <span class="title">image</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">id</span>,</span></span><br><span class="line"><span class="class">                           <span class="title">const</span> <span class="title">char</span> *<span class="title">snapname</span>);</span></span><br><span class="line"><span class="class">  int aio_open_read_only(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="type">Image</span>&amp; <span class="title">image</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>,</span></span><br><span class="line"><span class="class">			 <span class="title">const</span> <span class="title">char</span> *<span class="title">snapname</span>, <span class="type">RBD</span>::<span class="type">AioCompletion</span> *<span class="title">c</span>);</span></span><br><span class="line"><span class="class">  int aio_open_by_id_read_only(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="type">Image</span>&amp; <span class="title">image</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">id</span>,</span></span><br><span class="line"><span class="class">                               <span class="title">const</span> <span class="title">char</span> *<span class="title">snapname</span>, <span class="type">RBD</span>::<span class="type">AioCompletion</span> *<span class="title">c</span>);</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  int list(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">std</span>::<span class="title">vector</span>&lt;<span class="title">std</span>::<span class="title">string</span>&gt;&amp; <span class="title">names</span>)</span></span><br><span class="line"><span class="class">    __attribute__((<span class="title">deprecated</span>));</span></span><br><span class="line"><span class="class">  int list2(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">std</span>::<span class="title">vector</span>&lt;<span class="title">image_spec_t</span>&gt;* <span class="title">images</span>);</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  int create(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>, <span class="title">uint64_t</span> <span class="title">size</span>, <span class="title">int</span> *<span class="title">order</span>);</span></span><br><span class="line"><span class="class">  int create2(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>, <span class="title">uint64_t</span> <span class="title">size</span>,</span></span><br><span class="line"><span class="class">	      <span class="title">uint64_t</span> <span class="title">features</span>, <span class="title">int</span> *<span class="title">order</span>);</span></span><br><span class="line"><span class="class">  int create3(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>, <span class="title">uint64_t</span> <span class="title">size</span>,</span></span><br><span class="line"><span class="class">	      <span class="title">uint64_t</span> <span class="title">features</span>, <span class="title">int</span> *<span class="title">order</span>,</span></span><br><span class="line"><span class="class">	      <span class="title">uint64_t</span> <span class="title">stripe_unit</span>, <span class="title">uint64_t</span> <span class="title">stripe_count</span>);</span></span><br><span class="line"><span class="class">  int create4(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>, <span class="title">uint64_t</span> <span class="title">size</span>,</span></span><br><span class="line"><span class="class">	      <span class="type">ImageOptions</span>&amp; <span class="title">opts</span>);</span></span><br><span class="line"><span class="class">  int clone(<span class="type">IoCtx</span>&amp; <span class="title">p_ioctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">p_name</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">p_snapname</span>,</span></span><br><span class="line"><span class="class">	       <span class="type">IoCtx</span>&amp; <span class="title">c_ioctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">c_name</span>, <span class="title">uint64_t</span> <span class="title">features</span>,</span></span><br><span class="line"><span class="class">	       <span class="title">int</span> *<span class="title">c_order</span>);</span></span><br><span class="line"><span class="class">  int clone2(<span class="type">IoCtx</span>&amp; <span class="title">p_ioctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">p_name</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">p_snapname</span>,</span></span><br><span class="line"><span class="class">	     <span class="type">IoCtx</span>&amp; <span class="title">c_ioctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">c_name</span>, <span class="title">uint64_t</span> <span class="title">features</span>,</span></span><br><span class="line"><span class="class">	     <span class="title">int</span> *<span class="title">c_order</span>, <span class="title">uint64_t</span> <span class="title">stripe_unit</span>, <span class="title">int</span> <span class="title">stripe_count</span>);</span></span><br><span class="line"><span class="class">  int clone3(<span class="type">IoCtx</span>&amp; <span class="title">p_ioctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">p_name</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">p_snapname</span>,</span></span><br><span class="line"><span class="class">	     <span class="type">IoCtx</span>&amp; <span class="title">c_ioctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">c_name</span>, <span class="type">ImageOptions</span>&amp; <span class="title">opts</span>);</span></span><br><span class="line"><span class="class">  int remove(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>);</span></span><br><span class="line"><span class="class">  int remove_with_progress(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>, <span class="type">ProgressContext</span>&amp; <span class="title">pctx</span>);</span></span><br><span class="line"><span class="class">  int rename(<span class="type">IoCtx</span>&amp; <span class="title">src_io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">srcname</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">destname</span>);</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  int trash_move(<span class="type">IoCtx</span> &amp;<span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>, <span class="title">uint64_t</span> <span class="title">delay</span>);</span></span><br><span class="line"><span class="class">  int trash_get(<span class="type">IoCtx</span> &amp;<span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">id</span>, <span class="title">trash_image_info_t</span> *<span class="title">info</span>);</span></span><br><span class="line"><span class="class">  int trash_list(<span class="type">IoCtx</span> &amp;<span class="title">io_ctx</span>, <span class="title">std</span>::<span class="title">vector</span>&lt;<span class="title">trash_image_info_t</span>&gt; &amp;<span class="title">entries</span>);</span></span><br><span class="line"><span class="class">  int trash_purge(<span class="type">IoCtx</span> &amp;<span class="title">io_ctx</span>, <span class="title">time_t</span> <span class="title">expire_ts</span>, <span class="title">float</span> <span class="title">threshold</span>);</span></span><br><span class="line"><span class="class">  int trash_purge_with_progress(<span class="type">IoCtx</span> &amp;<span class="title">io_ctx</span>, <span class="title">time_t</span> <span class="title">expire_ts</span>, <span class="title">float</span> <span class="title">threshold</span>,</span></span><br><span class="line"><span class="class">                                <span class="type">ProgressContext</span> &amp;<span class="title">pctx</span>);</span></span><br><span class="line"><span class="class">  int trash_remove(<span class="type">IoCtx</span> &amp;<span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">image_id</span>, <span class="title">bool</span> <span class="title">force</span>);</span></span><br><span class="line"><span class="class">  int trash_remove_with_progress(<span class="type">IoCtx</span> &amp;<span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">image_id</span>,</span></span><br><span class="line"><span class="class">                                 <span class="title">bool</span> <span class="title">force</span>, <span class="type">ProgressContext</span> &amp;<span class="title">pctx</span>);</span></span><br><span class="line"><span class="class">  int trash_restore(<span class="type">IoCtx</span> &amp;<span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">id</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>);</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  // <span class="type">Migration</span></span></span><br><span class="line"><span class="class">  int migration_prepare(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">image_name</span>,</span></span><br><span class="line"><span class="class">                        <span class="type">IoCtx</span>&amp; <span class="title">dest_io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">dest_image_name</span>,</span></span><br><span class="line"><span class="class">                        <span class="type">ImageOptions</span>&amp; <span class="title">opts</span>);</span></span><br><span class="line"><span class="class">  int migration_execute(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">image_name</span>);</span></span><br><span class="line"><span class="class">  int migration_execute_with_progress(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">image_name</span>,</span></span><br><span class="line"><span class="class">                                      <span class="type">ProgressContext</span> &amp;<span class="title">prog_ctx</span>);</span></span><br><span class="line"><span class="class">  int migration_abort(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">image_name</span>);</span></span><br><span class="line"><span class="class">  int migration_abort_with_progress(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">image_name</span>,</span></span><br><span class="line"><span class="class">                                    <span class="type">ProgressContext</span> &amp;<span class="title">prog_ctx</span>);</span></span><br><span class="line"><span class="class">  int migration_commit(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">image_name</span>);</span></span><br><span class="line"><span class="class">  int migration_commit_with_progress(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">image_name</span>,</span></span><br><span class="line"><span class="class">                                     <span class="type">ProgressContext</span> &amp;<span class="title">prog_ctx</span>);</span></span><br><span class="line"><span class="class">  int migration_status(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">image_name</span>,</span></span><br><span class="line"><span class="class">                       <span class="title">image_migration_status_t</span> *<span class="title">status</span>, <span class="title">size_t</span> <span class="title">status_size</span>);</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  // <span class="type">RBD</span> pool mirroring support functions</span></span><br><span class="line"><span class="class">  int mirror_mode_get(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">rbd_mirror_mode_t</span> *<span class="title">mirror_mode</span>);</span></span><br><span class="line"><span class="class">  int mirror_mode_set(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">rbd_mirror_mode_t</span> <span class="title">mirror_mode</span>);</span></span><br><span class="line"><span class="class">  int mirror_peer_add(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">std</span>::<span class="title">string</span> *<span class="title">uuid</span>,</span></span><br><span class="line"><span class="class">                      <span class="title">const</span> <span class="title">std</span>::<span class="title">string</span> &amp;<span class="title">cluster_name</span>,</span></span><br><span class="line"><span class="class">                      <span class="title">const</span> <span class="title">std</span>::<span class="title">string</span> &amp;<span class="title">client_name</span>);</span></span><br><span class="line"><span class="class">  int mirror_peer_remove(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">std</span>::<span class="title">string</span> &amp;<span class="title">uuid</span>);</span></span><br><span class="line"><span class="class">  int mirror_peer_list(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">std</span>::<span class="title">vector</span>&lt;<span class="title">mirror_peer_t</span>&gt; *<span class="title">peers</span>);</span></span><br><span class="line"><span class="class">  int mirror_peer_set_client(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">std</span>::<span class="title">string</span> &amp;<span class="title">uuid</span>,</span></span><br><span class="line"><span class="class">                             <span class="title">const</span> <span class="title">std</span>::<span class="title">string</span> &amp;<span class="title">client_name</span>);</span></span><br><span class="line"><span class="class">  int mirror_peer_set_cluster(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">std</span>::<span class="title">string</span> &amp;<span class="title">uuid</span>,</span></span><br><span class="line"><span class="class">                              <span class="title">const</span> <span class="title">std</span>::<span class="title">string</span> &amp;<span class="title">cluster_name</span>);</span></span><br><span class="line"><span class="class">  int mirror_peer_get_attributes(</span></span><br><span class="line"><span class="class">      <span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">std</span>::<span class="title">string</span> &amp;<span class="title">uuid</span>,</span></span><br><span class="line"><span class="class">      <span class="title">std</span>::<span class="title">map</span>&lt;<span class="title">std</span>::<span class="title">string</span>, <span class="title">std</span>::<span class="title">string</span>&gt; *<span class="title">key_vals</span>);</span></span><br><span class="line"><span class="class">  int mirror_peer_set_attributes(</span></span><br><span class="line"><span class="class">      <span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">std</span>::<span class="title">string</span> &amp;<span class="title">uuid</span>,</span></span><br><span class="line"><span class="class">      <span class="title">const</span> <span class="title">std</span>::<span class="title">map</span>&lt;<span class="title">std</span>::<span class="title">string</span>, <span class="title">std</span>::<span class="title">string</span>&gt;&amp; <span class="title">key_vals</span>);</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  int mirror_image_status_list(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">std</span>::<span class="title">string</span> &amp;<span class="title">start_id</span>,</span></span><br><span class="line"><span class="class">      <span class="title">size_t</span> <span class="title">max</span>, <span class="title">std</span>::<span class="title">map</span>&lt;<span class="title">std</span>::<span class="title">string</span>, <span class="title">mirror_image_status_t</span>&gt; *<span class="title">images</span>);</span></span><br><span class="line"><span class="class">  int mirror_image_status_summary(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>,</span></span><br><span class="line"><span class="class">      <span class="title">std</span>::<span class="title">map</span>&lt;<span class="title">mirror_image_status_state_t</span>, <span class="title">int</span>&gt; *<span class="title">states</span>);</span></span><br><span class="line"><span class="class">  int mirror_image_instance_id_list(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">std</span>::<span class="title">string</span> &amp;<span class="title">start_id</span>,</span></span><br><span class="line"><span class="class">      <span class="title">size_t</span> <span class="title">max</span>, <span class="title">std</span>::<span class="title">map</span>&lt;<span class="title">std</span>::<span class="title">string</span>, <span class="title">std</span>::<span class="title">string</span>&gt; *<span class="title">sevice_ids</span>);</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  // <span class="type">RBD</span> groups support functions</span></span><br><span class="line"><span class="class">  int group_create(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">group_name</span>);</span></span><br><span class="line"><span class="class">  int group_remove(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">group_name</span>);</span></span><br><span class="line"><span class="class">  int group_list(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">std</span>::<span class="title">vector</span>&lt;<span class="title">std</span>::<span class="title">string</span>&gt; *<span class="title">names</span>);</span></span><br><span class="line"><span class="class">  int group_rename(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">src_group_name</span>,</span></span><br><span class="line"><span class="class">                   <span class="title">const</span> <span class="title">char</span> *<span class="title">dest_group_name</span>);</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  int group_image_add(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">group_name</span>,</span></span><br><span class="line"><span class="class">		      <span class="type">IoCtx</span>&amp; <span class="title">image_io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">image_name</span>);</span></span><br><span class="line"><span class="class">  int group_image_remove(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">group_name</span>,</span></span><br><span class="line"><span class="class">			 <span class="type">IoCtx</span>&amp; <span class="title">image_io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">image_name</span>);</span></span><br><span class="line"><span class="class">  int group_image_remove_by_id(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">group_name</span>,</span></span><br><span class="line"><span class="class">                               <span class="type">IoCtx</span>&amp; <span class="title">image_io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">image_id</span>);</span></span><br><span class="line"><span class="class">  int group_image_list(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">group_name</span>,</span></span><br><span class="line"><span class="class">                       <span class="title">std</span>::<span class="title">vector</span>&lt;<span class="title">group_image_info_t</span>&gt; *<span class="title">images</span>,</span></span><br><span class="line"><span class="class">                       <span class="title">size_t</span> <span class="title">group_image_info_size</span>);</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  int group_snap_create(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">group_name</span>,</span></span><br><span class="line"><span class="class">			<span class="title">const</span> <span class="title">char</span> *<span class="title">snap_name</span>);</span></span><br><span class="line"><span class="class">  int group_snap_remove(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">group_name</span>,</span></span><br><span class="line"><span class="class">			<span class="title">const</span> <span class="title">char</span> *<span class="title">snap_name</span>);</span></span><br><span class="line"><span class="class">  int group_snap_rename(<span class="type">IoCtx</span>&amp; <span class="title">group_ioctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">group_name</span>,</span></span><br><span class="line"><span class="class">                        <span class="title">const</span> <span class="title">char</span> *<span class="title">old_snap_name</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">new_snap_name</span>);</span></span><br><span class="line"><span class="class">  int group_snap_list(<span class="type">IoCtx</span>&amp; <span class="title">group_ioctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">group_name</span>,</span></span><br><span class="line"><span class="class">                      <span class="title">std</span>::<span class="title">vector</span>&lt;<span class="title">group_snap_info_t</span>&gt; *<span class="title">snaps</span>,</span></span><br><span class="line"><span class="class">                      <span class="title">size_t</span> <span class="title">group_snap_info_size</span>);</span></span><br><span class="line"><span class="class">  int group_snap_rollback(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">group_name</span>,</span></span><br><span class="line"><span class="class">                          <span class="title">const</span> <span class="title">char</span> *<span class="title">snap_name</span>);</span></span><br><span class="line"><span class="class">  int group_snap_rollback_with_progress(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">group_name</span>,</span></span><br><span class="line"><span class="class">                                        <span class="title">const</span> <span class="title">char</span> *<span class="title">snap_name</span>,</span></span><br><span class="line"><span class="class">                                        <span class="type">ProgressContext</span>&amp; <span class="title">pctx</span>);</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  int namespace_create(<span class="type">IoCtx</span>&amp; <span class="title">ioctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">namespace_name</span>);</span></span><br><span class="line"><span class="class">  int namespace_remove(<span class="type">IoCtx</span>&amp; <span class="title">ioctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">namespace_name</span>);</span></span><br><span class="line"><span class="class">  int namespace_list(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">std</span>::<span class="title">vector</span>&lt;<span class="title">std</span>::<span class="title">string</span>&gt;* <span class="title">namespace_names</span>);</span></span><br><span class="line"><span class="class">  int namespace_exists(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">namespace_name</span>, <span class="title">bool</span> *<span class="title">exists</span>);</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  int pool_init(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">bool</span> <span class="title">force</span>);</span></span><br><span class="line"><span class="class">  int pool_stats_get(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="type">PoolStats</span> *<span class="title">pool_stats</span>);</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  int pool_metadata_get(<span class="type">IoCtx</span> &amp;<span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">std</span>::<span class="title">string</span> &amp;<span class="title">key</span>,</span></span><br><span class="line"><span class="class">                        <span class="title">std</span>::<span class="title">string</span> *<span class="title">value</span>);</span></span><br><span class="line"><span class="class">  int pool_metadata_set(<span class="type">IoCtx</span> &amp;<span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">std</span>::<span class="title">string</span> &amp;<span class="title">key</span>,</span></span><br><span class="line"><span class="class">                        <span class="title">const</span> <span class="title">std</span>::<span class="title">string</span> &amp;<span class="title">value</span>);</span></span><br><span class="line"><span class="class">  int pool_metadata_remove(<span class="type">IoCtx</span> &amp;<span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">std</span>::<span class="title">string</span> &amp;<span class="title">key</span>);</span></span><br><span class="line"><span class="class">  int pool_metadata_list(<span class="type">IoCtx</span> &amp;<span class="title">io_ctx</span>, <span class="title">const</span> <span class="title">std</span>::<span class="title">string</span> &amp;<span class="title">start</span>, <span class="title">uint64_t</span> <span class="title">max</span>,</span></span><br><span class="line"><span class="class">                         <span class="title">std</span>::<span class="title">map</span>&lt;<span class="title">std</span>::<span class="title">string</span>, <span class="title">ceph</span>::<span class="title">bufferlist</span>&gt; *<span class="title">pairs</span>);</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  int config_list(<span class="type">IoCtx</span>&amp; <span class="title">io_ctx</span>, <span class="title">std</span>::<span class="title">vector</span>&lt;<span class="title">config_option_t</span>&gt; *<span class="title">options</span>);</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">private:</span></span><br><span class="line"><span class="class">  /* <span class="type">We</span> don&#x27;t allow assignment or copying */</span></span><br><span class="line"><span class="class">  <span class="type">RBD</span>(<span class="title">const</span> <span class="type">RBD</span>&amp; <span class="title">rhs</span>);</span></span><br><span class="line"><span class="class">  const <span class="type">RBD</span>&amp; operator=(<span class="title">const</span> <span class="type">RBD</span>&amp; <span class="title">rhs</span>);</span></span><br><span class="line"><span class="class">&#125;;</span></span><br><span class="line"><span class="class"></span></span><br></pre></td></tr></table></figure>

<h5 id="class-CEPH-RBD-API-Image"><a href="#class-CEPH-RBD-API-Image" class="headerlink" title="class CEPH_RBD_API Image"></a>class CEPH_RBD_API Image</h5><ul>
<li>Image 类负责镜像的读写(read&#x2F;write)，以及快照相关的操作等等。</li>
<li>同时提供了相关异步操作的接口。</li>
</ul>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CEPH_RBD_API</span> Image</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Image</span>();</span><br><span class="line">  ~<span class="built_in">Image</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 镜像的读写，resize, flush, flatten，trim等操作</span></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">aio_close</span><span class="params">(RBD::AioCompletion *c)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">resize</span><span class="params">(<span class="type">uint64_t</span> size)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">resize2</span><span class="params">(<span class="type">uint64_t</span> size, <span class="type">bool</span> allow_shrink, ProgressContext&amp; pctx)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">resize_with_progress</span><span class="params">(<span class="type">uint64_t</span> size, ProgressContext&amp; pctx)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">stat</span><span class="params">(<span class="type">image_info_t</span> &amp;info, <span class="type">size_t</span> infosize)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">get_name</span><span class="params">(std::string *name)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">get_id</span><span class="params">(std::string *id)</span></span>;</span><br><span class="line">  <span class="function">std::string <span class="title">get_block_name_prefix</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int64_t</span> <span class="title">get_data_pool_id</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">parent_info</span><span class="params">(std::string *parent_poolname, std::string *parent_name,</span></span></span><br><span class="line"><span class="params"><span class="function">		  std::string *parent_snapname)</span></span></span><br><span class="line"><span class="function">      __<span class="title">attribute__</span><span class="params">((deprecated))</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">parent_info2</span><span class="params">(std::string *parent_poolname, std::string *parent_name,</span></span></span><br><span class="line"><span class="params"><span class="function">                   std::string *parent_id, std::string *parent_snapname)</span></span></span><br><span class="line"><span class="function">      __<span class="title">attribute__</span><span class="params">((deprecated))</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">get_parent</span><span class="params">(<span class="type">linked_image_spec_t</span> *parent_image, <span class="type">snap_spec_t</span> *parent_snap)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">old_format</span><span class="params">(<span class="type">uint8_t</span> *old)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">size</span><span class="params">(<span class="type">uint64_t</span> *size)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">get_group</span><span class="params">(<span class="type">group_info_t</span> *group_info, <span class="type">size_t</span> group_info_size)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">features</span><span class="params">(<span class="type">uint64_t</span> *features)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">update_features</span><span class="params">(<span class="type">uint64_t</span> features, <span class="type">bool</span> enabled)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">get_op_features</span><span class="params">(<span class="type">uint64_t</span> *op_features)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">overlap</span><span class="params">(<span class="type">uint64_t</span> *overlap)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">get_flags</span><span class="params">(<span class="type">uint64_t</span> *flags)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">set_image_notification</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> type)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* exclusive lock feature */</span></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">is_exclusive_lock_owner</span><span class="params">(<span class="type">bool</span> *is_owner)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">lock_acquire</span><span class="params">(<span class="type">rbd_lock_mode_t</span> lock_mode)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">lock_release</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">lock_get_owners</span><span class="params">(<span class="type">rbd_lock_mode_t</span> *lock_mode,</span></span></span><br><span class="line"><span class="params"><span class="function">                      std::list&lt;std::string&gt; *lock_owners)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">lock_break</span><span class="params">(<span class="type">rbd_lock_mode_t</span> lock_mode, <span class="type">const</span> std::string &amp;lock_owner)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* object map feature */</span></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">rebuild_object_map</span><span class="params">(ProgressContext &amp;prog_ctx)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">check_object_map</span><span class="params">(ProgressContext &amp;prog_ctx)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">copy</span><span class="params">(IoCtx&amp; dest_io_ctx, <span class="type">const</span> <span class="type">char</span> *destname)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">copy2</span><span class="params">(Image&amp; dest)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">copy3</span><span class="params">(IoCtx&amp; dest_io_ctx, <span class="type">const</span> <span class="type">char</span> *destname, ImageOptions&amp; opts)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">copy4</span><span class="params">(IoCtx&amp; dest_io_ctx, <span class="type">const</span> <span class="type">char</span> *destname, ImageOptions&amp; opts,</span></span></span><br><span class="line"><span class="params"><span class="function">	    <span class="type">size_t</span> sparse_size)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">copy_with_progress</span><span class="params">(IoCtx&amp; dest_io_ctx, <span class="type">const</span> <span class="type">char</span> *destname,</span></span></span><br><span class="line"><span class="params"><span class="function">			 ProgressContext &amp;prog_ctx)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">copy_with_progress2</span><span class="params">(Image&amp; dest, ProgressContext &amp;prog_ctx)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">copy_with_progress3</span><span class="params">(IoCtx&amp; dest_io_ctx, <span class="type">const</span> <span class="type">char</span> *destname,</span></span></span><br><span class="line"><span class="params"><span class="function">			  ImageOptions&amp; opts, ProgressContext &amp;prog_ctx)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">copy_with_progress4</span><span class="params">(IoCtx&amp; dest_io_ctx, <span class="type">const</span> <span class="type">char</span> *destname,</span></span></span><br><span class="line"><span class="params"><span class="function">			  ImageOptions&amp; opts, ProgressContext &amp;prog_ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">			  <span class="type">size_t</span> sparse_size)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* deep copy */</span></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">deep_copy</span><span class="params">(IoCtx&amp; dest_io_ctx, <span class="type">const</span> <span class="type">char</span> *destname, ImageOptions&amp; opts)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">deep_copy_with_progress</span><span class="params">(IoCtx&amp; dest_io_ctx, <span class="type">const</span> <span class="type">char</span> *destname,</span></span></span><br><span class="line"><span class="params"><span class="function">                              ImageOptions&amp; opts, ProgressContext &amp;prog_ctx)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* striping */</span></span><br><span class="line">  <span class="function"><span class="type">uint64_t</span> <span class="title">get_stripe_unit</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">  <span class="function"><span class="type">uint64_t</span> <span class="title">get_stripe_count</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">get_create_timestamp</span><span class="params">(<span class="keyword">struct</span> timespec *timestamp)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">get_access_timestamp</span><span class="params">(<span class="keyword">struct</span> timespec *timestamp)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">get_modify_timestamp</span><span class="params">(<span class="keyword">struct</span> timespec *timestamp)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">flatten</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">flatten_with_progress</span><span class="params">(ProgressContext &amp;prog_ctx)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">sparsify</span><span class="params">(<span class="type">size_t</span> sparse_size)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">sparsify_with_progress</span><span class="params">(<span class="type">size_t</span> sparse_size, ProgressContext &amp;prog_ctx)</span></span>;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns a pair of poolname, imagename for each clone</span></span><br><span class="line"><span class="comment">   * of this image at the currently set snapshot.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">list_children</span><span class="params">(std::set&lt;std::pair&lt;std::string, std::string&gt; &gt; *children)</span></span></span><br><span class="line"><span class="function">      __<span class="title">attribute__</span><span class="params">((deprecated))</span></span>;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Returns a structure of poolname, imagename, imageid and trash flag</span></span><br><span class="line"><span class="comment">  * for each clone of this image at the currently set snapshot.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">list_children2</span><span class="params">(std::vector&lt;librbd::<span class="type">child_info_t</span>&gt; *children)</span></span></span><br><span class="line"><span class="function">      __<span class="title">attribute__</span><span class="params">((deprecated))</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">list_children3</span><span class="params">(std::vector&lt;<span class="type">linked_image_spec_t</span>&gt; *images)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">list_descendants</span><span class="params">(std::vector&lt;<span class="type">linked_image_spec_t</span>&gt; *images)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* advisory locking (see librbd.h for details) */</span></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">list_lockers</span><span class="params">(std::list&lt;<span class="type">locker_t</span>&gt; *lockers,</span></span></span><br><span class="line"><span class="params"><span class="function">		   <span class="type">bool</span> *exclusive, std::string *tag)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">lock_exclusive</span><span class="params">(<span class="type">const</span> std::string&amp; cookie)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">lock_shared</span><span class="params">(<span class="type">const</span> std::string&amp; cookie, <span class="type">const</span> std::string&amp; tag)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">unlock</span><span class="params">(<span class="type">const</span> std::string&amp; cookie)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">break_lock</span><span class="params">(<span class="type">const</span> std::string&amp; client, <span class="type">const</span> std::string&amp; cookie)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* snapshots */</span></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_list</span><span class="params">(std::vector&lt;<span class="type">snap_info_t</span>&gt;&amp; snaps)</span></span>;</span><br><span class="line">  <span class="comment">/* DEPRECATED; use snap_exists2 */</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">snap_exists</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *snapname)</span> __<span class="title">attribute__</span> <span class="params">((deprecated))</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_exists2</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *snapname, <span class="type">bool</span> *exists)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_create</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *snapname)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_remove</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *snapname)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_remove2</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *snapname, <span class="type">uint32_t</span> flags, ProgressContext&amp; pctx)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_remove_by_id</span><span class="params">(<span class="type">uint64_t</span> snap_id)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_rollback</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *snap_name)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_rollback_with_progress</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *snap_name, ProgressContext&amp; pctx)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_protect</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *snap_name)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_unprotect</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *snap_name)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_is_protected</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *snap_name, <span class="type">bool</span> *is_protected)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_set</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *snap_name)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_set_by_id</span><span class="params">(<span class="type">uint64_t</span> snap_id)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_rename</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *srcname, <span class="type">const</span> <span class="type">char</span> *dstname)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_get_limit</span><span class="params">(<span class="type">uint64_t</span> *limit)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_set_limit</span><span class="params">(<span class="type">uint64_t</span> limit)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_get_timestamp</span><span class="params">(<span class="type">uint64_t</span> snap_id, <span class="keyword">struct</span> timespec *timestamp)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_get_namespace_type</span><span class="params">(<span class="type">uint64_t</span> snap_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">snap_namespace_type_t</span> *namespace_type)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_get_group_namespace</span><span class="params">(<span class="type">uint64_t</span> snap_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                               <span class="type">snap_group_namespace_t</span> *group_namespace,</span></span></span><br><span class="line"><span class="params"><span class="function">                               <span class="type">size_t</span> snap_group_namespace_size)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">snap_get_trash_namespace</span><span class="params">(<span class="type">uint64_t</span> snap_id, std::string* original_name)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* I/O */</span></span><br><span class="line">  <span class="function"><span class="type">ssize_t</span> <span class="title">read</span><span class="params">(<span class="type">uint64_t</span> ofs, <span class="type">size_t</span> len, ceph::bufferlist&amp; bl)</span></span>;</span><br><span class="line">  <span class="comment">/* @param op_flags see librados.h constants beginning with LIBRADOS_OP_FLAG */</span></span><br><span class="line">  <span class="function"><span class="type">ssize_t</span> <span class="title">read2</span><span class="params">(<span class="type">uint64_t</span> ofs, <span class="type">size_t</span> len, ceph::bufferlist&amp; bl, <span class="type">int</span> op_flags)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int64_t</span> <span class="title">read_iterate</span><span class="params">(<span class="type">uint64_t</span> ofs, <span class="type">size_t</span> len,</span></span></span><br><span class="line"><span class="params"><span class="function">		       <span class="type">int</span> (*cb)(<span class="type">uint64_t</span>, <span class="type">size_t</span>, <span class="type">const</span> <span class="type">char</span> *, <span class="type">void</span> *), <span class="type">void</span> *arg)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">read_iterate2</span><span class="params">(<span class="type">uint64_t</span> ofs, <span class="type">uint64_t</span> len,</span></span></span><br><span class="line"><span class="params"><span class="function">		    <span class="type">int</span> (*cb)(<span class="type">uint64_t</span>, <span class="type">size_t</span>, <span class="type">const</span> <span class="type">char</span> *, <span class="type">void</span> *), <span class="type">void</span> *arg)</span></span>;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * get difference between two versions of an image</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * This will return the differences between two versions of an image</span></span><br><span class="line"><span class="comment">   * via a callback, which gets the offset and length and a flag</span></span><br><span class="line"><span class="comment">   * indicating whether the extent exists (1), or is known/defined to</span></span><br><span class="line"><span class="comment">   * be zeros (a hole, 0).  If the source snapshot name is NULL, we</span></span><br><span class="line"><span class="comment">   * interpret that as the beginning of time and return all allocated</span></span><br><span class="line"><span class="comment">   * regions of the image.  The end version is whatever is currently</span></span><br><span class="line"><span class="comment">   * selected for the image handle (either a snapshot or the writeable</span></span><br><span class="line"><span class="comment">   * head).</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @param fromsnapname start snapshot name, or NULL</span></span><br><span class="line"><span class="comment">   * @param ofs start offset</span></span><br><span class="line"><span class="comment">   * @param len len in bytes of region to report on</span></span><br><span class="line"><span class="comment">   * @param include_parent true if full history diff should include parent</span></span><br><span class="line"><span class="comment">   * @param whole_object 1 if diff extents should cover whole object</span></span><br><span class="line"><span class="comment">   * @param cb callback to call for each allocated region</span></span><br><span class="line"><span class="comment">   * @param arg argument to pass to the callback</span></span><br><span class="line"><span class="comment">   * @returns 0 on success, or negative error code on error</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">diff_iterate</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *fromsnapname,</span></span></span><br><span class="line"><span class="params"><span class="function">		   <span class="type">uint64_t</span> ofs, <span class="type">uint64_t</span> len,</span></span></span><br><span class="line"><span class="params"><span class="function">		   <span class="type">int</span> (*cb)(<span class="type">uint64_t</span>, <span class="type">size_t</span>, <span class="type">int</span>, <span class="type">void</span> *), <span class="type">void</span> *arg)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">diff_iterate2</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *fromsnapname,</span></span></span><br><span class="line"><span class="params"><span class="function">		    <span class="type">uint64_t</span> ofs, <span class="type">uint64_t</span> len,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="type">bool</span> include_parent, <span class="type">bool</span> whole_object,</span></span></span><br><span class="line"><span class="params"><span class="function">		    <span class="type">int</span> (*cb)(<span class="type">uint64_t</span>, <span class="type">size_t</span>, <span class="type">int</span>, <span class="type">void</span> *), <span class="type">void</span> *arg)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">ssize_t</span> <span class="title">write</span><span class="params">(<span class="type">uint64_t</span> ofs, <span class="type">size_t</span> len, ceph::bufferlist&amp; bl)</span></span>;</span><br><span class="line">  <span class="comment">/* @param op_flags see librados.h constants beginning with LIBRADOS_OP_FLAG */</span></span><br><span class="line">  <span class="function"><span class="type">ssize_t</span> <span class="title">write2</span><span class="params">(<span class="type">uint64_t</span> ofs, <span class="type">size_t</span> len, ceph::bufferlist&amp; bl, <span class="type">int</span> op_flags)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">discard</span><span class="params">(<span class="type">uint64_t</span> ofs, <span class="type">uint64_t</span> len)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">ssize_t</span> <span class="title">writesame</span><span class="params">(<span class="type">uint64_t</span> ofs, <span class="type">size_t</span> len, ceph::bufferlist &amp;bl, <span class="type">int</span> op_flags)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">ssize_t</span> <span class="title">compare_and_write</span><span class="params">(<span class="type">uint64_t</span> ofs, <span class="type">size_t</span> len, ceph::bufferlist &amp;cmp_bl,</span></span></span><br><span class="line"><span class="params"><span class="function">                            ceph::bufferlist&amp; bl, <span class="type">uint64_t</span> *mismatch_off, <span class="type">int</span> op_flags)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">aio_write</span><span class="params">(<span class="type">uint64_t</span> off, <span class="type">size_t</span> len, ceph::bufferlist&amp; bl, RBD::AioCompletion *c)</span></span>;</span><br><span class="line">  <span class="comment">/* @param op_flags see librados.h constants beginning with LIBRADOS_OP_FLAG */</span></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">aio_write2</span><span class="params">(<span class="type">uint64_t</span> off, <span class="type">size_t</span> len, ceph::bufferlist&amp; bl,</span></span></span><br><span class="line"><span class="params"><span class="function">		  RBD::AioCompletion *c, <span class="type">int</span> op_flags)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">aio_writesame</span><span class="params">(<span class="type">uint64_t</span> off, <span class="type">size_t</span> len, ceph::bufferlist&amp; bl,</span></span></span><br><span class="line"><span class="params"><span class="function">                    RBD::AioCompletion *c, <span class="type">int</span> op_flags)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">aio_compare_and_write</span><span class="params">(<span class="type">uint64_t</span> off, <span class="type">size_t</span> len, ceph::bufferlist&amp; cmp_bl,</span></span></span><br><span class="line"><span class="params"><span class="function">                            ceph::bufferlist&amp; bl, RBD::AioCompletion *c,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">uint64_t</span> *mismatch_off, <span class="type">int</span> op_flags)</span></span>;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * read async from image</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * The target bufferlist is populated with references to buffers</span></span><br><span class="line"><span class="comment">   * that contain the data for the given extent of the image.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">NOTE:</span> If caching is enabled, the bufferlist will directly</span></span><br><span class="line"><span class="comment">   * reference buffers in the cache to avoid an unnecessary data copy.</span></span><br><span class="line"><span class="comment">   * As a result, if the user intends to modify the buffer contents</span></span><br><span class="line"><span class="comment">   * directly, they should make a copy first (unconditionally, or when</span></span><br><span class="line"><span class="comment">   * the reference count on ther underlying buffer is more than 1).</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @param off offset in image</span></span><br><span class="line"><span class="comment">   * @param len length of read</span></span><br><span class="line"><span class="comment">   * @param bl bufferlist to read into</span></span><br><span class="line"><span class="comment">   * @param c aio completion to notify when read is complete</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">aio_read</span><span class="params">(<span class="type">uint64_t</span> off, <span class="type">size_t</span> len, ceph::bufferlist&amp; bl, RBD::AioCompletion *c)</span></span>;</span><br><span class="line">  <span class="comment">/* @param op_flags see librados.h constants beginning with LIBRADOS_OP_FLAG */</span></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">aio_read2</span><span class="params">(<span class="type">uint64_t</span> off, <span class="type">size_t</span> len, ceph::bufferlist&amp; bl,</span></span></span><br><span class="line"><span class="params"><span class="function">		  RBD::AioCompletion *c, <span class="type">int</span> op_flags)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">aio_discard</span><span class="params">(<span class="type">uint64_t</span> off, <span class="type">uint64_t</span> len, RBD::AioCompletion *c)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">flush</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Start a flush if caching is enabled. Get a callback when</span></span><br><span class="line"><span class="comment">   * the currently pending writes are on disk.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @param image the image to flush writes to</span></span><br><span class="line"><span class="comment">   * @param c what to call when flushing is complete</span></span><br><span class="line"><span class="comment">   * @returns 0 on success, negative error code on failure</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">aio_flush</span><span class="params">(RBD::AioCompletion *c)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Drop any cached data for this image</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @returns 0 on success, negative error code on failure</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">invalidate_cache</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">poll_io_events</span><span class="params">(RBD::AioCompletion **comps, <span class="type">int</span> numcomp)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">metadata_get</span><span class="params">(<span class="type">const</span> std::string &amp;key, std::string *value)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">metadata_set</span><span class="params">(<span class="type">const</span> std::string &amp;key, <span class="type">const</span> std::string &amp;value)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">metadata_remove</span><span class="params">(<span class="type">const</span> std::string &amp;key)</span></span>;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns a pair of key/value for this image</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">metadata_list</span><span class="params">(<span class="type">const</span> std::string &amp;start, <span class="type">uint64_t</span> max, std::map&lt;std::string, ceph::bufferlist&gt; *pairs)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// RBD image mirroring support functions</span></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">mirror_image_enable</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">mirror_image_disable</span><span class="params">(<span class="type">bool</span> force)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">mirror_image_promote</span><span class="params">(<span class="type">bool</span> force)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">mirror_image_demote</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">mirror_image_resync</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">mirror_image_get_info</span><span class="params">(<span class="type">mirror_image_info_t</span> *mirror_image_info,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">size_t</span> info_size)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">mirror_image_get_status</span><span class="params">(<span class="type">mirror_image_status_t</span> *mirror_image_status,</span></span></span><br><span class="line"><span class="params"><span class="function">			      <span class="type">size_t</span> status_size)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">mirror_image_get_instance_id</span><span class="params">(std::string *instance_id)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">aio_mirror_image_promote</span><span class="params">(<span class="type">bool</span> force, RBD::AioCompletion *c)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">aio_mirror_image_demote</span><span class="params">(RBD::AioCompletion *c)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">aio_mirror_image_get_info</span><span class="params">(<span class="type">mirror_image_info_t</span> *mirror_image_info,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">size_t</span> info_size, RBD::AioCompletion *c)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">aio_mirror_image_get_status</span><span class="params">(<span class="type">mirror_image_status_t</span> *mirror_image_status,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">size_t</span> status_size, RBD::AioCompletion *c)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">update_watch</span><span class="params">(UpdateWatchCtx *ctx, <span class="type">uint64_t</span> *handle)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">update_unwatch</span><span class="params">(<span class="type">uint64_t</span> handle)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">list_watchers</span><span class="params">(std::list&lt;<span class="type">image_watcher_t</span>&gt; &amp;watchers)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">config_list</span><span class="params">(std::vector&lt;<span class="type">config_option_t</span>&gt; *options)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">RBD</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Image</span>(<span class="type">const</span> Image&amp; rhs);</span><br><span class="line">  <span class="type">const</span> Image&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Image&amp; rhs);</span><br><span class="line"></span><br><span class="line">  <span class="type">image_ctx_t</span> ctx; <span class="comment">// void*, 实际指向具体实现的类</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h5><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/blob/master/src/librbd/librbd.cc">librbd.cc</a> 主要实现了 I&#x2F;O 相关接口 read&#x2F;write。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/blob/master/src/librbd/internal.cc">internal.cc</a> 主要实现了定义在头文件中的相关函数接口</li>
</ul>
<h4 id="Cls"><a href="#Cls" class="headerlink" title="Cls"></a>Cls</h4><ul>
<li>cls_rbd是Cls的一个扩展模块，Cls允许用户自定义对象的操作接口和实现方法，为用户提供了一种比较直接的接口扩展方式。通过动态链接的形式加入 osd 中，在 osd 上直接执行。</li>
</ul>
<h5 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h5><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/blob/master/src/cls/rbd/cls_rbd_client.cc">cls_rbd_client.h&#x2F;cc</a> 该文件中主要定义了客户端上运行的接口，将函数参数封装后发送给服务端 OSD ，然后做后续处理.</li>
<li><code>cls_rbd_client.h/cc</code> 定义了通过客户端访问osd注册的cls函数的方法。以 <code>snapshot_add</code> 函数和 <code>create_image</code> 函数为例，这个函数将参数封装进 bufferlist ，通过 ioctx-&gt;exec 方法，把操作发送给osd处理。</li>
</ul>
<figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">void snapshot_add(librados::ObjectWriteOperation *op, snapid_t snap_id,</span><br><span class="line">              <span class="keyword">const</span> std::string &amp;snap_name, <span class="keyword">const</span> cls::rbd::SnapshotNamespace &amp;snap_namespace)</span><br><span class="line">&#123;</span><br><span class="line">  bufferlist bl;</span><br><span class="line">  ::encode(snap_name, bl);</span><br><span class="line">  ::encode(snap_id, bl);</span><br><span class="line">  ::encode(cls::rbd::SnapshotNamespaceOnDisk(snap_namespace), bl);</span><br><span class="line">  op-&gt;exec(<span class="string">&quot;rbd&quot;</span>, <span class="string">&quot;snapshot_add&quot;</span>, bl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void create_image(librados::ObjectWriteOperation *op, uint64_t size,</span><br><span class="line">                  uint8_t order, uint64_t features,</span><br><span class="line">                  <span class="keyword">const</span> std::string &amp;object_prefix, int64_t data_pool_id)</span><br><span class="line">&#123;</span><br><span class="line">  bufferlist bl;</span><br><span class="line">  ::encode(size, bl);</span><br><span class="line">  ::encode(order, bl);</span><br><span class="line">  ::encode(features, bl);</span><br><span class="line">  ::encode(object_prefix, bl);</span><br><span class="line">  ::encode(data_pool_id, bl);</span><br><span class="line"></span><br><span class="line">  op-&gt;exec(<span class="string">&quot;rbd&quot;</span>, <span class="string">&quot;create&quot;</span>, bl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> create_image(librados::IoCtx *ioctx, <span class="keyword">const</span> std::string &amp;oid,</span><br><span class="line">                 uint64_t size, uint8_t order, uint64_t features,</span><br><span class="line">                 <span class="keyword">const</span> std::string &amp;object_prefix, int64_t data_pool_id)</span><br><span class="line">&#123;</span><br><span class="line">  librados::ObjectWriteOperation op;</span><br><span class="line">  create_image(&amp;op, size, order, features, object_prefix, data_pool_id);</span><br><span class="line">  <span class="keyword">return</span> ioctx-&gt;operate(oid, &amp;op);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h5><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/blob/master/src/cls/rbd/cls_rbd.cc">cls_rbd.h&#x2F;cc</a> 该类中主要定义了服务端上（OSD）执行的函数，响应客户端的请求。在 <code>cls_rbd.cc</code> 函数中，对函数进行定义和注册。</li>
<li>例如，下面的代码注册了rbd模块，以及 <code>snapshot_add</code> 和 <code>create</code> 函数。</li>
</ul>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cls_register<span class="punctuation">(</span><span class="string">&quot;rbd&quot;</span><span class="punctuation">,</span> <span class="meta">&amp;h_class);</span></span><br><span class="line">cls_register_cxx_method<span class="punctuation">(</span>h_class<span class="punctuation">,</span> <span class="string">&quot;snapshot_add&quot;</span><span class="punctuation">,</span></span><br><span class="line">            CLS_METHOD_RD <span class="string">| CLS_METHOD_WR,</span></span><br><span class="line">            snapshot_add<span class="punctuation">,</span> <span class="meta">&amp;h_snapshot_add);</span></span><br><span class="line">            </span><br><span class="line">cls_register_cxx_method<span class="punctuation">(</span>h_class<span class="punctuation">,</span> <span class="string">&quot;create&quot;</span><span class="punctuation">,</span></span><br><span class="line">	  CLS_METHOD_RD <span class="string">| CLS_METHOD_WR,</span></span><br><span class="line">	  create<span class="punctuation">,</span> <span class="meta">&amp;h_create);</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>cls_rbd.cc定义了方法在服务端的实现，其一般流程是：从bufferlist将客户端传入的参数解析出来，调用对应的方法实现，然后将结果返回客户端。</li>
</ul>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Adds a snapshot to an rbd header. Ensures the id and name are unique.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">snapshot_add</span><span class="params">(<span class="type">cls_method_context_t</span> hctx, bufferlist *in, bufferlist *out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  bufferlist snap_namebl, snap_idbl;</span><br><span class="line">  cls_rbd_snap snap_meta;</span><br><span class="line">  <span class="type">uint64_t</span> snap_limit;</span><br><span class="line">  <span class="comment">// 从bl中解析参数</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    bufferlist::iterator iter = in-&gt;<span class="built_in">begin</span>();</span><br><span class="line">    ::<span class="built_in">decode</span>(snap_meta.name, iter);</span><br><span class="line">    ::<span class="built_in">decode</span>(snap_meta.id, iter);</span><br><span class="line">    <span class="keyword">if</span> (!iter.<span class="built_in">end</span>()) &#123;</span><br><span class="line">      ::<span class="built_in">decode</span>(snap_meta.snapshot_namespace, iter);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">const</span> buffer::error &amp;err) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 判断参数合法性，略</span></span><br><span class="line">  ......</span><br><span class="line">  <span class="comment">// 完成操作，在rbd_header对象中增加新的snapshot元数据，并更新sanp_seq。</span></span><br><span class="line">  map&lt;string, bufferlist&gt; vals;</span><br><span class="line">  vals[<span class="string">&quot;snap_seq&quot;</span>] = snap_seqbl;</span><br><span class="line">  vals[snapshot_key] = snap_metabl;</span><br><span class="line">  r = <span class="built_in">cls_cxx_map_set_vals</span>(hctx, &amp;vals);</span><br><span class="line">  <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">CLS_ERR</span>(<span class="string">&quot;error writing snapshot metadata: %s&quot;</span>, <span class="built_in">cpp_strerror</span>(r).<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initialize the header with basic metadata.</span></span><br><span class="line"><span class="comment"> * Extra features may initialize more fields in the future.</span></span><br><span class="line"><span class="comment"> * Everything is stored as key/value pairs as omaps in the header object.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If features the OSD does not understand are requested, -ENOSYS is</span></span><br><span class="line"><span class="comment"> * returned.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Input:</span></span><br><span class="line"><span class="comment"> * @param size number of bytes in the image (uint64_t)</span></span><br><span class="line"><span class="comment"> * @param order bits to shift to determine the size of data objects (uint8_t)</span></span><br><span class="line"><span class="comment"> * @param features what optional things this image will use (uint64_t)</span></span><br><span class="line"><span class="comment"> * @param object_prefix a prefix for all the data objects</span></span><br><span class="line"><span class="comment"> * @param data_pool_id pool id where data objects is stored (int64_t)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Output:</span></span><br><span class="line"><span class="comment"> * @return 0 on success, negative error code on failure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">create</span><span class="params">(<span class="type">cls_method_context_t</span> hctx, bufferlist *in, bufferlist *out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  string object_prefix;</span><br><span class="line">  <span class="type">uint64_t</span> features, size;</span><br><span class="line">  <span class="type">uint8_t</span> order;</span><br><span class="line">  <span class="type">int64_t</span> data_pool_id = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 从 buffer 里解析参数</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">auto</span> iter = in-&gt;<span class="built_in">cbegin</span>();</span><br><span class="line">    <span class="built_in">decode</span>(size, iter);</span><br><span class="line">    <span class="built_in">decode</span>(order, iter);</span><br><span class="line">    <span class="built_in">decode</span>(features, iter);</span><br><span class="line">    <span class="built_in">decode</span>(object_prefix, iter);</span><br><span class="line">    <span class="keyword">if</span> (!iter.<span class="built_in">end</span>()) &#123;</span><br><span class="line">      <span class="built_in">decode</span>(data_pool_id, iter);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="built_in">catch</span> (<span class="type">const</span> buffer::error &amp;err) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">CLS_LOG</span>(<span class="number">20</span>, <span class="string">&quot;create object_prefix=%s size=%llu order=%u features=%llu&quot;</span>,</span><br><span class="line">	  object_prefix.<span class="built_in">c_str</span>(), (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)size, order,</span><br><span class="line">	  (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)features);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (features &amp; ~RBD_FEATURES_ALL) &#123;</span><br><span class="line">    <span class="keyword">return</span> -ENOSYS;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!object_prefix.<span class="built_in">size</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  bufferlist stored_prefixbl;</span><br><span class="line">    <span class="comment">// 从 cls context 里获取 object_prefix</span></span><br><span class="line">  <span class="type">int</span> r = <span class="built_in">cls_cxx_map_get_val</span>(hctx, <span class="string">&quot;object_prefix&quot;</span>, &amp;stored_prefixbl);</span><br><span class="line">  <span class="keyword">if</span> (r != -ENOENT) &#123;</span><br><span class="line">    <span class="built_in">CLS_ERR</span>(<span class="string">&quot;reading object_prefix returned %d&quot;</span>, r);</span><br><span class="line">    <span class="keyword">return</span> -EEXIST;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  bufferlist sizebl;</span><br><span class="line">  bufferlist orderbl;</span><br><span class="line">  bufferlist featuresbl;</span><br><span class="line">  bufferlist object_prefixbl;</span><br><span class="line">  bufferlist snap_seqbl;</span><br><span class="line">  bufferlist timestampbl;</span><br><span class="line">  <span class="type">uint64_t</span> snap_seq = <span class="number">0</span>;</span><br><span class="line">  <span class="type">utime_t</span> timestamp = <span class="built_in">ceph_clock_now</span>();</span><br><span class="line">  <span class="built_in">encode</span>(size, sizebl);</span><br><span class="line">  <span class="built_in">encode</span>(order, orderbl);</span><br><span class="line">  <span class="built_in">encode</span>(features, featuresbl);</span><br><span class="line">  <span class="built_in">encode</span>(object_prefix, object_prefixbl);</span><br><span class="line">  <span class="built_in">encode</span>(snap_seq, snap_seqbl);</span><br><span class="line">  <span class="built_in">encode</span>(timestamp, timestampbl);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新 rbd_header omap </span></span><br><span class="line">  map&lt;string, bufferlist&gt; omap_vals;</span><br><span class="line">  omap_vals[<span class="string">&quot;size&quot;</span>] = sizebl;</span><br><span class="line">  omap_vals[<span class="string">&quot;order&quot;</span>] = orderbl;</span><br><span class="line">  omap_vals[<span class="string">&quot;features&quot;</span>] = featuresbl;</span><br><span class="line">  omap_vals[<span class="string">&quot;object_prefix&quot;</span>] = object_prefixbl;</span><br><span class="line">  omap_vals[<span class="string">&quot;snap_seq&quot;</span>] = snap_seqbl;</span><br><span class="line">  omap_vals[<span class="string">&quot;create_timestamp&quot;</span>] = timestampbl;</span><br><span class="line">  omap_vals[<span class="string">&quot;access_timestamp&quot;</span>] = timestampbl;</span><br><span class="line">  omap_vals[<span class="string">&quot;modify_timestamp&quot;</span>] = timestampbl;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((features &amp; RBD_FEATURE_OPERATIONS) != <span class="number">0ULL</span>) &#123;</span><br><span class="line">    <span class="built_in">CLS_ERR</span>(<span class="string">&quot;Attempting to set internal feature: operations&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (features &amp; RBD_FEATURE_DATA_POOL) &#123;</span><br><span class="line">    <span class="keyword">if</span> (data_pool_id == <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="built_in">CLS_ERR</span>(<span class="string">&quot;data pool not provided with feature enabled&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bufferlist data_pool_id_bl;</span><br><span class="line">    <span class="built_in">encode</span>(data_pool_id, data_pool_id_bl);</span><br><span class="line">    omap_vals[<span class="string">&quot;data_pool_id&quot;</span>] = data_pool_id_bl;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data_pool_id != <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">CLS_ERR</span>(<span class="string">&quot;data pool provided with feature disabled&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新 OMAP</span></span><br><span class="line">  r = <span class="built_in">cls_cxx_map_set_vals</span>(hctx, &amp;omap_vals);</span><br><span class="line">  <span class="keyword">if</span> (r &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h4><p><img src="https://github.com/zjs1224522500/files-and-images/blob/0d8833c01f0f0d26954bbe6dfcfddce1b60eb9a9/blog/pic/librbd-io-method-stack.png?raw=true" alt="image-20251013181348139"></p>
<h4 id="分片-Striper"><a href="#分片-Striper" class="headerlink" title="分片 Striper"></a>分片 Striper</h4><ul>
<li>Ceph RBD 默认分片到了许多对象上，这些对象最终会存储在 RADOS 中，对 RBD Image 的读写请求会分布在集群中的很多个节点上，从而避免当 RBD Image 特别大或者繁忙的时候，单个节点不会成为瓶颈。</li>
<li>Ceph RBD 的分片由三个参数控制<ul>
<li>object-size，代码中常常简写为 os，通常为 2 的幂指数，默认的对象大小是4 MB，最小的是4K，最大的是32M</li>
<li>stripe_unit，代码中常常简写为 su，一个对象中存储了连续该大小的分片。默认和对象大小相等。</li>
<li>stripe_count，代码中常常简写为 sc，在向 [stripe_count] 对象写入 [stripe_unit] 字节后，循环到初始对象并写入另一个条带，直到对象达到其最大大小。此时，将继续处理下一个 [stripe_count] 对象。</li>
</ul>
</li>
<li>分片的组织形式类似于 RAID0，看一个来自官网的 <a target="_blank" rel="noopener" href="https://ceph.readthedocs.io/en/latest/dev/file-striping/">例子</a>。此处只举例一个 Object Set，对象大小在如下图示中即为纵向的一个对象大小，由整数个分片单元组成，而一个分片是指指定 stripe_count 个 stripe_unit，图示中的 stripe_count 即为 5，假设 stripe_unit 为 64KB，那么对应的分片大小即为 320KB，对象大小如果设置为 64GB，那么一个对象对应的就会有 64GB&#x2F;64KB &#x3D; 1048576 个 stripe_unit.</li>
</ul>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">   _________   _________   _________   _________   _________</span><br><span class="line">  /object  0\ /object  1\ /object  2\ /object  3\ /object  4\</span><br><span class="line">  +=========+ +=========+ +=========+ +=========+ +=========+</span><br><span class="line">  |<span class="string">  stripe </span>|<span class="string"> </span>|<span class="string">  stripe </span>|<span class="string"> </span>|<span class="string">  stripe </span>|<span class="string"> </span>|<span class="string">  stripe </span>|<span class="string"> </span>|<span class="string">  stripe </span>|</span><br><span class="line">o |<span class="string">   unit  </span>|<span class="string"> </span>|<span class="string">   unit  </span>|<span class="string"> </span>|<span class="string">   unit  </span>|<span class="string"> </span>|<span class="string">   unit  </span>|<span class="string"> </span>|<span class="string">   unit  </span>|<span class="string"> stripe 0</span></span><br><span class="line"><span class="string">b </span>|<span class="string">     0   </span>|<span class="string"> </span>|<span class="string">     1   </span>|<span class="string"> </span>|<span class="string">     2   </span>|<span class="string"> </span>|<span class="string">     3   </span>|<span class="string"> </span>|<span class="string">     4   </span>|</span><br><span class="line">j |<span class="string">---------</span>|<span class="string"> </span>|<span class="string">---------</span>|<span class="string"> </span>|<span class="string">---------</span>|<span class="string"> </span>|<span class="string">---------</span>|<span class="string"> </span>|<span class="string">---------</span>|</span><br><span class="line">e |<span class="string">  stripe </span>|<span class="string"> </span>|<span class="string">  stripe </span>|<span class="string"> </span>|<span class="string">  stripe </span>|<span class="string"> </span>|<span class="string">  stripe </span>|<span class="string"> </span>|<span class="string">  stripe </span>|</span><br><span class="line">c |<span class="string">   unit  </span>|<span class="string"> </span>|<span class="string">   unit  </span>|<span class="string"> </span>|<span class="string">   unit  </span>|<span class="string"> </span>|<span class="string">   unit  </span>|<span class="string"> </span>|<span class="string">   unit  </span>|<span class="string"> stripe 1</span></span><br><span class="line"><span class="string">t </span>|<span class="string">     5   </span>|<span class="string"> </span>|<span class="string">     6   </span>|<span class="string"> </span>|<span class="string">     7   </span>|<span class="string"> </span>|<span class="string">     8   </span>|<span class="string"> </span>|<span class="string">     9   </span>|</span><br><span class="line">  |<span class="string">---------</span>|<span class="string"> </span>|<span class="string">---------</span>|<span class="string"> </span>|<span class="string">---------</span>|<span class="string"> </span>|<span class="string">---------</span>|<span class="string"> </span>|<span class="string">---------</span>|</span><br><span class="line">s |<span class="string">     .   </span>|<span class="string"> </span>|<span class="string">     .   </span>|<span class="string"> </span>|<span class="string">     .   </span>|<span class="string"> </span>|<span class="string">     .   </span>|<span class="string"> </span>|<span class="string">     .   </span>|</span><br><span class="line">e       .           .           .           .           .</span><br><span class="line">t |<span class="string">     .   </span>|<span class="string"> </span>|<span class="string">     .   </span>|<span class="string"> </span>|<span class="string">     .   </span>|<span class="string"> </span>|<span class="string">     .   </span>|<span class="string"> </span>|<span class="string">     .   </span>|</span><br><span class="line">  |<span class="string">---------</span>|<span class="string"> </span>|<span class="string">---------</span>|<span class="string"> </span>|<span class="string">---------</span>|<span class="string"> </span>|<span class="string">---------</span>|<span class="string"> </span>|<span class="string">---------</span>|</span><br><span class="line">0 |<span class="string">  stripe </span>|<span class="string"> </span>|<span class="string">  stripe </span>|<span class="string"> </span>|<span class="string">  stripe </span>|<span class="string"> </span>|<span class="string">  stripe </span>|<span class="string"> </span>|<span class="string">  stripe </span>|<span class="string"> stripe</span></span><br><span class="line"><span class="string">  </span>|<span class="string">   unit  </span>|<span class="string"> </span>|<span class="string">   unit  </span>|<span class="string"> </span>|<span class="string">   unit  </span>|<span class="string"> </span>|<span class="string">   unit  </span>|<span class="string"> </span>|<span class="string">   unit  </span>|<span class="string"> 1048575</span></span><br><span class="line"><span class="string">  </span>|<span class="string"> 5242875 </span>|<span class="string"> </span>|<span class="string"> 5242876 </span>|<span class="string"> </span>|<span class="string"> 5242877 </span>|<span class="string"> </span>|<span class="string"> 5242878 </span>|<span class="string"> </span>|<span class="string"> 5242879 </span>|</span><br><span class="line">  \=========/ \=========/ \=========/ \=========/ \=========/</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/blob/master/src/osdc/Striper.h">ceph&#x2F;src&#x2F;osdc&#x2F;Striper.h</a></li>
</ul>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">class</span> <span class="title class_">Striper</span> &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">file_to_extents</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        CephContext *cct, <span class="type">const</span> <span class="type">file_layout_t</span> *layout, <span class="type">uint64_t</span> offset,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">uint64_t</span> len, <span class="type">uint64_t</span> trunc_size, <span class="type">uint64_t</span> buffer_offset,</span></span></span><br><span class="line"><span class="params"><span class="function">        striper::LightweightObjectExtents* object_extents)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * std::map (ino, layout, offset, len) to a (list of) ObjectExtents (byte</span></span><br><span class="line"><span class="comment">     * ranges in objects on (primary) osds)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">file_to_extents</span><span class="params">(CephContext *cct, <span class="type">const</span> <span class="type">char</span> *object_format,</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="type">const</span> <span class="type">file_layout_t</span> *layout,</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="type">uint64_t</span> offset, <span class="type">uint64_t</span> len,</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="type">uint64_t</span> trunc_size,</span></span></span><br><span class="line"><span class="params"><span class="function">				std::map&lt;<span class="type">object_t</span>, std::vector&lt;ObjectExtent&gt; &gt;&amp; extents,</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="type">uint64_t</span> buffer_offset=<span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>分片大小对应的数据结构：</li>
</ul>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">file_layout_t</span> &#123;</span><br><span class="line">  <span class="comment">// file -&gt; object mapping</span></span><br><span class="line">  <span class="type">uint32_t</span> stripe_unit;   <span class="comment">///&lt; stripe unit, in bytes,</span></span><br><span class="line">  <span class="type">uint32_t</span> stripe_count;  <span class="comment">///&lt; over this many objects</span></span><br><span class="line">  <span class="type">uint32_t</span> object_size;   <span class="comment">///&lt; until objects are this big</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int64_t</span> pool_id;        <span class="comment">///&lt; rados pool id</span></span><br><span class="line">  std::string pool_ns;         <span class="comment">///&lt; rados pool namespace</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">file_layout_t</span>(<span class="type">uint32_t</span> su=<span class="number">0</span>, <span class="type">uint32_t</span> sc=<span class="number">0</span>, <span class="type">uint32_t</span> os=<span class="number">0</span>)</span><br><span class="line">    : <span class="built_in">stripe_unit</span>(su),</span><br><span class="line">      <span class="built_in">stripe_count</span>(sc),</span><br><span class="line">      <span class="built_in">object_size</span>(os),</span><br><span class="line">      <span class="built_in">pool_id</span>(<span class="number">-1</span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 默认分片大小 4MB</span></span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="type">file_layout_t</span> <span class="title">get_default</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">file_layout_t</span>(<span class="number">1</span>&lt;&lt;<span class="number">22</span>, <span class="number">1</span>, <span class="number">1</span>&lt;&lt;<span class="number">22</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">uint64_t</span> <span class="title">get_period</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;<span class="type">uint64_t</span>&gt;(stripe_count) * object_size;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">from_legacy</span><span class="params">(<span class="type">const</span> ceph_file_layout&amp; fl)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">to_legacy</span><span class="params">(ceph_file_layout *fl)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">is_valid</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">encode</span><span class="params">(ceph::buffer::list&amp; bl, <span class="type">uint64_t</span> features)</span> <span class="type">const</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">decode</span><span class="params">(ceph::buffer::list::const_iterator&amp; p)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">dump</span><span class="params">(ceph::Formatter *f)</span> <span class="type">const</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">decode_json</span><span class="params">(JSONObj *obj)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">generate_test_instances</span><span class="params">(std::list&lt;<span class="type">file_layout_t</span>*&gt;&amp; o)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>查看分片类对应的实现：<a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/blob/master/src/osdc/Striper.cc">ceph&#x2F;src&#x2F;osdc&#x2F;Striper.cc</a></li>
</ul>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Striper::file_to_extents</span><span class="params">(CephContext *cct, <span class="type">const</span> <span class="type">char</span> *object_format,</span></span></span><br><span class="line"><span class="params"><span class="function">			      <span class="type">const</span> <span class="type">file_layout_t</span> *layout,</span></span></span><br><span class="line"><span class="params"><span class="function">			      <span class="type">uint64_t</span> offset, <span class="type">uint64_t</span> len,</span></span></span><br><span class="line"><span class="params"><span class="function">			      <span class="type">uint64_t</span> trunc_size,</span></span></span><br><span class="line"><span class="params"><span class="function">			      std::vector&lt;ObjectExtent&gt;&amp; extents,</span></span></span><br><span class="line"><span class="params"><span class="function">			      <span class="type">uint64_t</span> buffer_offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  striper::LightweightObjectExtents lightweight_object_extents;</span><br><span class="line">  <span class="built_in">file_to_extents</span>(cct, layout, offset, len, trunc_size, buffer_offset,</span><br><span class="line">                  &amp;lightweight_object_extents);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// convert lightweight object extents to heavyweight version</span></span><br><span class="line">  extents.<span class="built_in">reserve</span>(lightweight_object_extents.<span class="built_in">size</span>());</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; lightweight_object_extent : lightweight_object_extents) &#123;</span><br><span class="line">    <span class="keyword">auto</span>&amp; object_extent = extents.<span class="built_in">emplace_back</span>(</span><br><span class="line">      <span class="built_in">object_t</span>(format_oid(object_format, lightweight_object_extent.object_no)),</span><br><span class="line">      lightweight_object_extent.object_no,</span><br><span class="line">      lightweight_object_extent.offset, lightweight_object_extent.length,</span><br><span class="line">      lightweight_object_extent.truncate_size);</span><br><span class="line"></span><br><span class="line">    object_extent.oloc = OSDMap::<span class="built_in">file_to_object_locator</span>(*layout);</span><br><span class="line">    object_extent.buffer_extents.<span class="built_in">reserve</span>(</span><br><span class="line">      lightweight_object_extent.buffer_extents.<span class="built_in">size</span>());</span><br><span class="line">    object_extent.buffer_extents.<span class="built_in">insert</span>(</span><br><span class="line">      object_extent.buffer_extents.<span class="built_in">end</span>(),</span><br><span class="line">      lightweight_object_extent.buffer_extents.<span class="built_in">begin</span>(),</span><br><span class="line">      lightweight_object_extent.buffer_extents.<span class="built_in">end</span>());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Striper::file_to_extents</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    CephContext *cct, <span class="type">const</span> <span class="type">file_layout_t</span> *layout, <span class="type">uint64_t</span> offset,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint64_t</span> len, <span class="type">uint64_t</span> trunc_size, <span class="type">uint64_t</span> buffer_offset,</span></span></span><br><span class="line"><span class="params"><span class="function">    striper::LightweightObjectExtents* object_extents)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">ldout</span>(cct, <span class="number">10</span>) &lt;&lt; <span class="string">&quot;file_to_extents &quot;</span> &lt;&lt; offset &lt;&lt; <span class="string">&quot;~&quot;</span> &lt;&lt; len &lt;&lt; dendl;</span><br><span class="line">  <span class="built_in">ceph_assert</span>(len &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * we want only one extent per object!  this means that each extent</span></span><br><span class="line"><span class="comment">   * we read may map into different bits of the final read</span></span><br><span class="line"><span class="comment">   * buffer.. hence buffer_extents</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  __u32 object_size = layout-&gt;object_size;</span><br><span class="line">  __u32 su = layout-&gt;stripe_unit;</span><br><span class="line">  __u32 stripe_count = layout-&gt;stripe_count;</span><br><span class="line">  <span class="built_in">ceph_assert</span>(object_size &gt;= su);</span><br><span class="line">  <span class="keyword">if</span> (stripe_count == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">ldout</span>(cct, <span class="number">20</span>) &lt;&lt; <span class="string">&quot; sc is one, reset su to os&quot;</span> &lt;&lt; dendl;</span><br><span class="line">    su = object_size;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">uint64_t</span> stripes_per_object = object_size / su;</span><br><span class="line">  <span class="built_in">ldout</span>(cct, <span class="number">20</span>) &lt;&lt; <span class="string">&quot; su &quot;</span> &lt;&lt; su &lt;&lt; <span class="string">&quot; sc &quot;</span> &lt;&lt; stripe_count &lt;&lt; <span class="string">&quot; os &quot;</span></span><br><span class="line">		 &lt;&lt; object_size &lt;&lt; <span class="string">&quot; stripes_per_object &quot;</span> &lt;&lt; stripes_per_object</span><br><span class="line">		 &lt;&lt; dendl;</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> cur = offset;</span><br><span class="line">  <span class="type">uint64_t</span> left = len;</span><br><span class="line">  <span class="keyword">while</span> (left &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// layout into objects</span></span><br><span class="line">    <span class="type">uint64_t</span> blockno = cur / su; <span class="comment">// which block</span></span><br><span class="line">    <span class="comment">// which horizontal stripe (Y)</span></span><br><span class="line">    <span class="type">uint64_t</span> stripeno = blockno / stripe_count;</span><br><span class="line">    <span class="comment">// which object in the object set (X)</span></span><br><span class="line">    <span class="type">uint64_t</span> stripepos = blockno % stripe_count;</span><br><span class="line">    <span class="comment">// which object set</span></span><br><span class="line">    <span class="type">uint64_t</span> objectsetno = stripeno / stripes_per_object;</span><br><span class="line">    <span class="comment">// object id</span></span><br><span class="line">    <span class="type">uint64_t</span> objectno = objectsetno * stripe_count + stripepos;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// map range into object</span></span><br><span class="line">    <span class="type">uint64_t</span> block_start = (stripeno % stripes_per_object) * su;</span><br><span class="line">    <span class="type">uint64_t</span> block_off = cur % su;</span><br><span class="line">    <span class="type">uint64_t</span> max = su - block_off;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> x_offset = block_start + block_off;</span><br><span class="line">    <span class="type">uint64_t</span> x_len;</span><br><span class="line">    <span class="keyword">if</span> (left &gt; max)</span><br><span class="line">      x_len = max;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      x_len = left;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ldout</span>(cct, <span class="number">20</span>) &lt;&lt; <span class="string">&quot; off &quot;</span> &lt;&lt; cur &lt;&lt; <span class="string">&quot; blockno &quot;</span> &lt;&lt; blockno &lt;&lt; <span class="string">&quot; stripeno &quot;</span></span><br><span class="line">		   &lt;&lt; stripeno &lt;&lt; <span class="string">&quot; stripepos &quot;</span> &lt;&lt; stripepos &lt;&lt; <span class="string">&quot; objectsetno &quot;</span></span><br><span class="line">		   &lt;&lt; objectsetno &lt;&lt; <span class="string">&quot; objectno &quot;</span> &lt;&lt; objectno</span><br><span class="line">		   &lt;&lt; <span class="string">&quot; block_start &quot;</span> &lt;&lt; block_start &lt;&lt; <span class="string">&quot; block_off &quot;</span></span><br><span class="line">		   &lt;&lt; block_off &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; x_offset &lt;&lt; <span class="string">&quot;~&quot;</span> &lt;&lt; x_len</span><br><span class="line">		   &lt;&lt; dendl;</span><br><span class="line"></span><br><span class="line">    striper::LightweightObjectExtent* ex = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">auto</span> it = std::<span class="built_in">upper_bound</span>(object_extents-&gt;<span class="built_in">begin</span>(), object_extents-&gt;<span class="built_in">end</span>(),</span><br><span class="line">                               objectno, <span class="built_in">OrderByObject</span>());</span><br><span class="line">    striper::<span class="function">LightweightObjectExtents::reverse_iterator <span class="title">rev_it</span><span class="params">(it)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (rev_it == object_extents-&gt;<span class="built_in">rend</span>() ||</span><br><span class="line">        rev_it-&gt;object_no != objectno ||</span><br><span class="line">        rev_it-&gt;offset + rev_it-&gt;length != x_offset) &#123;</span><br><span class="line">      <span class="comment">// expect up to &quot;stripe-width - 1&quot; vector shifts in the worst-case</span></span><br><span class="line">      ex = &amp;(*object_extents-&gt;<span class="built_in">emplace</span>(</span><br><span class="line">        it, objectno, x_offset, x_len,</span><br><span class="line">        <span class="built_in">object_truncate_size</span>(cct, layout, objectno, trunc_size)));</span><br><span class="line">        <span class="built_in">ldout</span>(cct, <span class="number">20</span>) &lt;&lt; <span class="string">&quot; added new &quot;</span> &lt;&lt; *ex &lt;&lt; dendl;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ex = &amp;(*rev_it);</span><br><span class="line">      <span class="built_in">ceph_assert</span>(ex-&gt;offset + ex-&gt;length == x_offset);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">ldout</span>(cct, <span class="number">20</span>) &lt;&lt; <span class="string">&quot; adding in to &quot;</span> &lt;&lt; *ex &lt;&lt; dendl;</span><br><span class="line">      ex-&gt;length += x_len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ex-&gt;buffer_extents.<span class="built_in">emplace_back</span>(cur - offset + buffer_offset, x_len);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ldout</span>(cct, <span class="number">15</span>) &lt;&lt; <span class="string">&quot;file_to_extents  &quot;</span> &lt;&lt; *ex &lt;&lt; dendl;</span><br><span class="line">    <span class="comment">// ldout(cct, 0) &lt;&lt; &quot;map: ino &quot; &lt;&lt; ino &lt;&lt; &quot; oid &quot; &lt;&lt; ex.oid &lt;&lt; &quot; osd &quot;</span></span><br><span class="line">    <span class="comment">//		  &lt;&lt; ex.osd &lt;&lt; &quot; offset &quot; &lt;&lt; ex.offset &lt;&lt; &quot; len &quot; &lt;&lt; ex.len</span></span><br><span class="line">    <span class="comment">//		  &lt;&lt; &quot; ... left &quot; &lt;&lt; left &lt;&lt; dendl;</span></span><br><span class="line"></span><br><span class="line">    left -= x_len;</span><br><span class="line">    cur += x_len;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="数据-IO"><a href="#数据-IO" class="headerlink" title="数据 IO"></a>数据 IO</h4><ul>
<li>主要对应于 <code>ImageCtx::io_work_queue</code> 成员变量。<code>librbd::io::ImageRequestWQ</code> 派生自 <code>ThreadPool::PointerWQ（&lt;= Luminous） / ThreadPool::PointerWQ（&gt;= Mimic）</code>。</li>
<li>librbd 支持两种类型的 aio，一种是普通的 aio，一种是非阻塞 aio。前者的行为相对简单，直接在用户线程的上下文进行 io 处理，而后者将用户的 io 直接入 <code>io_work_queue</code> 队列，然后 io 由队列的工作线程出队并在工作线程上下文进行后续的处理。这两种 aio 的行为由配置参数 <code>rbd_non_blocking_aio</code> 决定，默认为 true，因此默认为非阻塞 aio，但需要注意的是，即使默认不是非阻塞 aio，在某些场景下 aio 仍然会需要入 <code>io_work_queue</code> 队列，总结如下:</li>
</ul>
<h5 id="read"><a href="#read" class="headerlink" title="read"></a>read</h5><ul>
<li><code>ImageRequestWQ::writes_blocked()</code> 为 true，即已调用 <code>ImageRequestWQ::block_writes</code>，当前已禁止 write io 下发至 rados 层；</li>
<li><code>ImageRequestWQ::writes_empty()</code> 为 false，即前面已经有 write io 入了 <code>io_work_queue</code> 队列；</li>
<li><code>ImageRequestWQ::require_lock_on_read()</code> 为 true，这里的 lock 是指 exclusive lock，表示当前还未拿到，在启用 exclusive lock 特性的前提下，一旦开启克隆 COR (copy on read) 或者启用 journaling 特性，处理 read io 也要求拿锁；</li>
</ul>
<h5 id="write"><a href="#write" class="headerlink" title="write"></a>write</h5><ul>
<li><code>ImageRequestWQ::writes_blocked()</code> 为 true，即已调用 <code>ImageRequestWQ::block_writes</code>，当前已禁止 write io 下发至 rados 层；</li>
<li>对于 write 而言，并没有类似 <code>ImageRequestWQ::require_lock_on_write</code> 的接口，这是因为一旦启用 exclusive lock 特性，在初始化 exclusive lock 时会调用 <code>ImageRequestWQ::block_writes</code>（参考 ExclusiveLock::init），直至拿到锁（参考 <code>ExclusiveLock::handle_post_acquired_lock</code>），因此增加 <code>ImageRequestWQ::require_lock_on_write</code> 接口并没有必要。</li>
<li>需要注意的是，ImageRequestWQ::block_writes 并不只是简单的设置禁止标志，还需要 flush 已下发的 rados io，即等待所有已下发的 rados io 结束才返回。</li>
<li>从上面对 read、write 的分析，似乎 <code>ImageRequestWQ::writes_blocked</code> 改成 <code>ImageRequestWQ::io_blocked</code> 似乎更合理，但实际上这里并没有真的禁止 read io 下发至 rados 层，只是让 read io 先入 <code>io_work_queue</code> 队列。</li>
</ul>
<h4 id="TCMU-RBD"><a href="#TCMU-RBD" class="headerlink" title="TCMU-RBD"></a>TCMU-RBD</h4><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br></pre></td><td class="code"><pre><span class="line">static void tcmu_rbd_image_close(struct tcmu_device *dev)</span><br><span class="line">&#123;</span><br><span class="line">	struct tcmu_rbd_state *state = tcmur_dev_get_private(dev);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">rbd_close</span>(state-&gt;</span>image);</span><br><span class="line">	<span class="function"><span class="title">rados_ioctx_destroy</span>(state-&gt;</span>io_ctx);</span><br><span class="line">	<span class="function"><span class="title">rados_shutdown</span>(state-&gt;</span>cluster);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">state</span>-&gt;</span>cluster = NULL;</span><br><span class="line">	<span class="function"><span class="title">state</span>-&gt;</span>io_ctx = NULL;</span><br><span class="line">	<span class="function"><span class="title">state</span>-&gt;</span>image = NULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int tcmu_rbd_image_open(struct tcmu_device *dev)</span><br><span class="line">&#123;</span><br><span class="line">	struct tcmu_rbd_state *state = tcmur_dev_get_private(dev);</span><br><span class="line">	int ret;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">ret</span> = rados_create(&amp;state-&gt;</span><span class="function"><span class="title">cluster</span>, state-&gt;</span>id);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		tcmu_dev_err(dev, <span class="string">&quot;Could not create cluster. (Err %d)\n&quot;</span>, ret);</span><br><span class="line">		return ret;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Try default location when conf_path=NULL, but ignore failure */</span></span><br><span class="line">	<span class="function"><span class="title">ret</span> = rados_conf_read_file(state-&gt;</span><span class="function"><span class="title">cluster</span>, state-&gt;</span>conf_path);</span><br><span class="line">	<span class="function"><span class="title">if</span> (state-&gt;</span>conf_path &amp;&amp; ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		tcmu_dev_err(dev, <span class="string">&quot;Could not read config %s (Err %d)&quot;</span>,</span><br><span class="line">			     <span class="function"><span class="title">state</span>-&gt;</span>conf_path, ret);</span><br><span class="line">		goto rados_shutdown;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">rados_conf_set</span>(state-&gt;</span>cluster, <span class="string">&quot;rbd_cache&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line"></span><br><span class="line">	ret = timer_check_and_set_def(dev);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		tcmu_dev_warn(dev,</span><br><span class="line">			      <span class="string">&quot;Could not set rados osd op timeout to %s (Err %d. Failover may be delayed.)\n&quot;</span>,</span><br><span class="line">			      <span class="function"><span class="title">state</span>-&gt;</span>osd_op_timeout, ret);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">ret</span> = rados_connect(state-&gt;</span>cluster);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		tcmu_dev_err(dev, <span class="string">&quot;Could not connect to cluster. (Err %d)\n&quot;</span>,</span><br><span class="line">			     ret);</span><br><span class="line">		goto rados_shutdown;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tcmu_rbd_detect_device_class(dev);</span><br><span class="line">	<span class="function"><span class="title">ret</span> = rados_ioctx_create(state-&gt;</span><span class="function"><span class="title">cluster</span>, state-&gt;</span>pool_name,</span><br><span class="line">				 &amp;<span class="function"><span class="title">state</span>-&gt;</span>io_ctx);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		tcmu_dev_err(dev, <span class="string">&quot;Could not create ioctx for pool %s. (Err %d)\n&quot;</span>,</span><br><span class="line">			     <span class="function"><span class="title">state</span>-&gt;</span>pool_name, ret);</span><br><span class="line">		goto rados_shutdown;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">ret</span> = rbd_open(state-&gt;</span><span class="function"><span class="title">io_ctx</span>, state-&gt;</span><span class="function"><span class="title">image_name</span>, &amp;state-&gt;</span>image, NULL);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		tcmu_dev_err(dev, <span class="string">&quot;Could not open image %s. (Err %d)\n&quot;</span>,</span><br><span class="line">			     <span class="function"><span class="title">state</span>-&gt;</span>image_name, ret);</span><br><span class="line">		goto rados_destroy;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = tcmu_rbd_service_register(dev);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		goto rbd_close;</span><br><span class="line"></span><br><span class="line">	return <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">rbd_close:</span><br><span class="line">	<span class="function"><span class="title">rbd_close</span>(state-&gt;</span>image);</span><br><span class="line">	<span class="function"><span class="title">state</span>-&gt;</span>image = NULL;</span><br><span class="line">rados_destroy:</span><br><span class="line">	<span class="function"><span class="title">rados_ioctx_destroy</span>(state-&gt;</span>io_ctx);</span><br><span class="line">	<span class="function"><span class="title">state</span>-&gt;</span>io_ctx = NULL;</span><br><span class="line">rados_shutdown:</span><br><span class="line">	<span class="function"><span class="title">rados_shutdown</span>(state-&gt;</span>cluster);</span><br><span class="line">	<span class="function"><span class="title">state</span>-&gt;</span>cluster = NULL;</span><br><span class="line">	return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int tcmu_rbd_open(struct tcmu_device *dev, bool reopen)</span><br><span class="line">&#123;</span><br><span class="line">	rbd_image_info_t image_info;</span><br><span class="line">	char *pool, *<span class="keyword">name</span>, *next_opt;</span><br><span class="line">	char *config, *dev_cfg_dup;</span><br><span class="line">	struct tcmu_rbd_state *state;</span><br><span class="line">	uint32_t max_blocks;</span><br><span class="line">	int ret;</span><br><span class="line"></span><br><span class="line">	state = calloc(<span class="number">1</span>, sizeof(*state));</span><br><span class="line">	<span class="keyword">if</span> (!state)</span><br><span class="line">		return -ENOMEM;</span><br><span class="line">	tcmur_dev_set_private(dev, state);</span><br><span class="line"></span><br><span class="line">	dev_cfg_dup = strdup(tcmu_dev_get_cfgstring(dev));</span><br><span class="line">	config = dev_cfg_dup;</span><br><span class="line">	<span class="keyword">if</span> (!config) &#123;</span><br><span class="line">		ret = -ENOMEM;</span><br><span class="line">		goto free_state;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tcmu_dev_dbg(dev, <span class="string">&quot;tcmu_rbd_open config %s block size %u num lbas %&quot;</span> PRIu64 <span class="string">&quot;.\n&quot;</span>,</span><br><span class="line">		     config, tcmu_dev_get_block_size(dev),</span><br><span class="line">		     tcmu_dev_get_num_lbas(dev));</span><br><span class="line"></span><br><span class="line">	config = strchr(config, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span> (!config) &#123;</span><br><span class="line">		tcmu_dev_err(dev, <span class="string">&quot;no configuration found in cfgstring\n&quot;</span>);</span><br><span class="line">		ret = -EINVAL;</span><br><span class="line">		goto free_config;</span><br><span class="line">	&#125;</span><br><span class="line">	config += <span class="number">1</span>; <span class="comment">/* get past &#x27;/&#x27; */</span></span><br><span class="line"></span><br><span class="line">	pool = strtok(config, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (!pool) &#123;</span><br><span class="line">		tcmu_dev_err(dev, <span class="string">&quot;Could not get pool name\n&quot;</span>);</span><br><span class="line">		ret = -EINVAL;</span><br><span class="line">		goto free_config;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">state</span>-&gt;</span>pool_name = strdup(pool);</span><br><span class="line">	<span class="function"><span class="title">if</span> (!state-&gt;</span>pool_name) &#123;</span><br><span class="line">		ret = -ENOMEM;</span><br><span class="line">		tcmu_dev_err(dev, <span class="string">&quot;Could not copy pool name\n&quot;</span>);</span><br><span class="line">		goto free_config;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">name</span> = strtok(NULL, <span class="string">&quot;;&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">name</span>) &#123;</span><br><span class="line">		tcmu_dev_err(dev, <span class="string">&quot;Could not get image name\n&quot;</span>);</span><br><span class="line">		ret = -EINVAL;</span><br><span class="line">		goto free_config;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">state</span>-&gt;</span>image_name = strdup(<span class="keyword">name</span>);</span><br><span class="line">	<span class="function"><span class="title">if</span> (!state-&gt;</span>image_name) &#123;</span><br><span class="line">		ret = -ENOMEM;</span><br><span class="line">		tcmu_dev_err(dev, <span class="string">&quot;Could not copy image name\n&quot;</span>);</span><br><span class="line">		goto free_config;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* The next options are optional */</span></span><br><span class="line">	next_opt = strtok(NULL, <span class="string">&quot;;&quot;</span>);</span><br><span class="line">	<span class="keyword">while</span> (next_opt) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!strncmp(next_opt, <span class="string">&quot;osd_op_timeout=&quot;</span>, <span class="number">15</span>)) &#123;</span><br><span class="line">			<span class="function"><span class="title">state</span>-&gt;</span>osd_op_timeout = strdup(next_opt + <span class="number">15</span>);</span><br><span class="line">			<span class="function"><span class="title">if</span> (!state-&gt;</span>osd_op_timeout ||</span><br><span class="line">			    !<span class="function"><span class="title">strlen</span>(state-&gt;</span>osd_op_timeout)) &#123;</span><br><span class="line">				ret = -ENOMEM;</span><br><span class="line">				tcmu_dev_err(dev, <span class="string">&quot;Could not copy osd op timeout.\n&quot;</span>);</span><br><span class="line">				goto free_config;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strncmp(next_opt, <span class="string">&quot;conf=&quot;</span>, <span class="number">5</span>)) &#123;</span><br><span class="line">			<span class="function"><span class="title">state</span>-&gt;</span>conf_path = strdup(next_opt + <span class="number">5</span>);</span><br><span class="line">			<span class="function"><span class="title">if</span> (!state-&gt;</span><span class="function"><span class="title">conf_path</span> || !strlen(state-&gt;</span>conf_path)) &#123;</span><br><span class="line">				ret = -ENOMEM;</span><br><span class="line">				tcmu_dev_err(dev, <span class="string">&quot;Could not copy conf path.\n&quot;</span>);</span><br><span class="line">				goto free_config;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strncmp(next_opt, <span class="string">&quot;id=&quot;</span>, <span class="number">3</span>)) &#123;</span><br><span class="line">			<span class="function"><span class="title">state</span>-&gt;</span>id = strdup(next_opt + <span class="number">3</span>);</span><br><span class="line">			<span class="function"><span class="title">if</span> (!state-&gt;</span><span class="function"><span class="title">id</span> || !strlen(state-&gt;</span>id)) &#123;</span><br><span class="line">				ret = -ENOMEM;</span><br><span class="line">				tcmu_dev_err(dev, <span class="string">&quot;Could not copy id.\n&quot;</span>);</span><br><span class="line">				goto free_config;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		next_opt = strtok(NULL, <span class="string">&quot;;&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = tcmu_rbd_image_open(dev);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		goto free_config;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tcmu_rbd_check_excl_lock_enabled(dev);</span><br><span class="line"></span><br><span class="line">	ret = tcmu_rbd_check_image_size(dev, tcmu_dev_get_block_size(dev) *</span><br><span class="line">					tcmu_dev_get_num_lbas(dev));</span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		goto stop_image;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">ret</span> = rbd_stat(state-&gt;</span>image, &amp;image_info, sizeof(image_info));</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		tcmu_dev_err(dev, <span class="string">&quot;Could not stat image.\n&quot;</span>);</span><br><span class="line">		goto stop_image;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * librbd/ceph can better split and align unmaps and internal RWs, so</span></span><br><span class="line"><span class="comment">	 * just have runner pass the entire cmd to us. To try and balance</span></span><br><span class="line"><span class="comment">	 * overflowing the OSD/ceph side queues with discards/RWs limit it to</span></span><br><span class="line"><span class="comment">	 * up to 4.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	max_blocks = (image_info.obj_size * <span class="number">4</span>) / tcmu_dev_get_block_size(dev);</span><br><span class="line">	tcmu_dev_set_opt_xcopy_rw_len(dev, max_blocks);</span><br><span class="line">	tcmu_dev_set_max_unmap_len(dev, max_blocks);</span><br><span class="line">	tcmu_dev_set_opt_unmap_gran(dev, image_info.obj_size /</span><br><span class="line">				    tcmu_dev_get_block_size(dev), <span class="literal">false</span>);</span><br><span class="line">	tcmu_dev_set_write_cache_enabled(dev, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	free(dev_cfg_dup);</span><br><span class="line">	return <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">stop_image:</span><br><span class="line">	tcmu_rbd_image_close(dev);</span><br><span class="line">free_config:</span><br><span class="line">	free(dev_cfg_dup);</span><br><span class="line">free_state:</span><br><span class="line">	tcmu_rbd_state_free(state);</span><br><span class="line">	return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void tcmu_rbd_close(struct tcmu_device *dev)</span><br><span class="line">&#123;</span><br><span class="line">	struct tcmu_rbd_state *state = tcmur_dev_get_private(dev);</span><br><span class="line"></span><br><span class="line">	tcmu_rbd_image_close(dev);</span><br><span class="line">	tcmu_rbd_state_free(state);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int tcmu_rbd_aio_read(struct tcmu_device *dev, struct rbd_aio_cb *aio_cb,</span><br><span class="line">			     rbd_completion_t completion, struct iovec *iov,</span><br><span class="line">			     size_t iov_cnt, size_t length, off_t offset)</span><br><span class="line">&#123;</span><br><span class="line">	struct tcmu_rbd_state *state = tcmur_dev_get_private(dev);</span><br><span class="line">	int ret;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">aio_cb</span>-&gt;</span>bounce_buffer = malloc(length);</span><br><span class="line">	<span class="function"><span class="title">if</span> (!aio_cb-&gt;</span>bounce_buffer) &#123;</span><br><span class="line">		tcmu_dev_err(dev, <span class="string">&quot;Could not allocate bounce buffer.\n&quot;</span>);</span><br><span class="line">		return -ENOMEM;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">ret</span> = rbd_aio_read(state-&gt;</span><span class="function"><span class="title">image</span>, offset, length, aio_cb-&gt;</span>bounce_buffer,</span><br><span class="line">			   completion);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="function"><span class="title">free</span>(aio_cb-&gt;</span>bounce_buffer);</span><br><span class="line">	return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int tcmu_rbd_aio_write(struct tcmu_device *dev, struct rbd_aio_cb *aio_cb,</span><br><span class="line">			      rbd_completion_t completion, struct iovec *iov,</span><br><span class="line">			      size_t iov_cnt, size_t length, off_t offset)</span><br><span class="line">&#123;</span><br><span class="line">	struct tcmu_rbd_state *state = tcmur_dev_get_private(dev);</span><br><span class="line">	int ret;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">aio_cb</span>-&gt;</span>bounce_buffer = malloc(length);</span><br><span class="line">	<span class="function"><span class="title">if</span> (!aio_cb-&gt;</span>bounce_buffer) &#123;</span><br><span class="line">		tcmu_dev_err(dev, <span class="string">&quot;Failed to allocate bounce buffer.\n&quot;</span>);</span><br><span class="line">		return -ENOMEM;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">tcmu_memcpy_from_iovec</span>(aio_cb-&gt;</span>bounce_buffer, length, iov, iov_cnt);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">ret</span> = rbd_aio_write(state-&gt;</span><span class="function"><span class="title">image</span>, offset, length, aio_cb-&gt;</span>bounce_buffer,</span><br><span class="line">			    completion);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="function"><span class="title">free</span>(aio_cb-&gt;</span>bounce_buffer);</span><br><span class="line">	return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int tcmu_rbd_read(struct tcmu_device *dev, struct tcmulib_cmd *cmd,</span><br><span class="line">			     struct iovec *iov, size_t iov_cnt, size_t length,</span><br><span class="line">			     off_t offset)</span><br><span class="line">&#123;</span><br><span class="line">	struct rbd_aio_cb *aio_cb;</span><br><span class="line">	rbd_completion_t completion;</span><br><span class="line">	ssize_t ret;</span><br><span class="line"></span><br><span class="line">	aio_cb = calloc(<span class="number">1</span>, sizeof(*aio_cb));</span><br><span class="line">	<span class="keyword">if</span> (!aio_cb) &#123;</span><br><span class="line">		tcmu_dev_err(dev, <span class="string">&quot;Could not allocate aio_cb.\n&quot;</span>);</span><br><span class="line">		goto out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">aio_cb</span>-&gt;</span>dev = dev;</span><br><span class="line">	<span class="function"><span class="title">aio_cb</span>-&gt;</span>type = RBD_AIO_TYPE_READ;</span><br><span class="line">	<span class="function"><span class="title">aio_cb</span>-&gt;</span>read.length = length;</span><br><span class="line">	<span class="function"><span class="title">aio_cb</span>-&gt;</span>tcmulib_cmd = cmd;</span><br><span class="line">	<span class="function"><span class="title">aio_cb</span>-&gt;</span>iov = iov;</span><br><span class="line">	<span class="function"><span class="title">aio_cb</span>-&gt;</span>iov_cnt = iov_cnt;</span><br><span class="line"></span><br><span class="line">	ret = rbd_aio_create_completion</span><br><span class="line">		(aio_cb, (rbd_callback_t) rbd_finish_aio_generic, &amp;completion);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		goto out_free_aio_cb;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = tcmu_rbd_aio_read(dev, aio_cb, completion, iov, iov_cnt,</span><br><span class="line">				length, offset);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		goto out_release_tracked_aio;</span><br><span class="line"></span><br><span class="line">	return TCMU_STS_OK;</span><br><span class="line"></span><br><span class="line">out_release_tracked_aio:</span><br><span class="line">	rbd_aio_release(completion);</span><br><span class="line">out_free_aio_cb:</span><br><span class="line">	free(aio_cb);</span><br><span class="line">out:</span><br><span class="line">	return TCMU_STS_NO_RESOURCE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int tcmu_rbd_write(struct tcmu_device *dev, struct tcmulib_cmd *cmd,</span><br><span class="line">			  struct iovec *iov, size_t iov_cnt, size_t length,</span><br><span class="line">			  off_t offset)</span><br><span class="line">&#123;</span><br><span class="line">	struct rbd_aio_cb *aio_cb;</span><br><span class="line">	rbd_completion_t completion;</span><br><span class="line">	ssize_t ret;</span><br><span class="line"></span><br><span class="line">	aio_cb = calloc(<span class="number">1</span>, sizeof(*aio_cb));</span><br><span class="line">	<span class="keyword">if</span> (!aio_cb) &#123;</span><br><span class="line">		tcmu_dev_err(dev, <span class="string">&quot;Could not allocate aio_cb.\n&quot;</span>);</span><br><span class="line">		goto out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">aio_cb</span>-&gt;</span>dev = dev;</span><br><span class="line">	<span class="function"><span class="title">aio_cb</span>-&gt;</span>type = RBD_AIO_TYPE_WRITE;</span><br><span class="line">	<span class="function"><span class="title">aio_cb</span>-&gt;</span>tcmulib_cmd = cmd;</span><br><span class="line"></span><br><span class="line">	ret = rbd_aio_create_completion</span><br><span class="line">		(aio_cb, (rbd_callback_t) rbd_finish_aio_generic, &amp;completion);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		goto out_free_aio_cb;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = tcmu_rbd_aio_write(dev, aio_cb, completion, iov, iov_cnt,</span><br><span class="line">				 length, offset);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		goto out_release_tracked_aio;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return TCMU_STS_OK;</span><br><span class="line"></span><br><span class="line">out_release_tracked_aio:</span><br><span class="line">	rbd_aio_release(completion);</span><br><span class="line">out_free_aio_cb:</span><br><span class="line">	free(aio_cb);</span><br><span class="line">out:</span><br><span class="line">	return TCMU_STS_NO_RESOURCE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul>
<li>[<a target="_blank" rel="noopener" href="https://docs.ceph.com/docs/master/rbd/">1] Ceph RDB 官方文档介绍</a></li>
<li>[<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/3b430832bb44">2] 简书 - ceph rbd：总览</a></li>
<li>[<a target="_blank" rel="noopener" href="https://juejin.im/entry/5b3ae5de518825624e14256c">3] 掘金 - Ceph介绍及原理架构分享</a></li>
<li>[<a target="_blank" rel="noopener" href="https://blog.csdn.net/CSND_PAN/article/details/78728743">4] CSDN：Ceph学习——Librbd块存储库与RBD读写流程源码分析</a></li>
<li>[<a target="_blank" rel="noopener" href="https://blog.csdn.net/JDPlus/article/details/76522298">5] CSDN：Ceph RBD编程接口Librbd(C++) – 映像创建与数据读写</a></li>
<li>[<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/search/article-%E5%A4%A7%E8%AF%9DCeph">6] 腾讯云专栏：大话Ceph系列</a></li>
<li>[<a target="_blank" rel="noopener" href="https://runsisi.com/2019-02-19/librbd">7] runsisi.com - librbd 内部运行机制</a></li>
<li>[<a target="_blank" rel="noopener" href="https://blog.csdn.net/CSND_PAN/article/details/78707756">8] CSDN：Ceph学习——Librados与Osdc实现源码解析</a></li>
<li>[<a target="_blank" rel="noopener" href="https://blog.csdn.net/scaleqiao/article/details/51165598">9] CSDN：librbd代码目录解读</a></li>
<li>[<a target="_blank" rel="noopener" href="https://rjerk.xyz/index.php/archives/36/">10] Ceph: RBD 创建镜像过程以及源码分析</a></li>
<li>[<a target="_blank" rel="noopener" href="https://zhoubofsy.github.io/2017/01/22/storage/ceph/librbd-frame-analyse/">11] librbd 架构分析</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%AD%98%E5%82%A8/" rel="tag"># 存储</a>
              <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"># 分布式</a>
              <a href="/tags/ceph/" rel="tag"># ceph</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/09/30/ceph%E4%B8%AD%E7%9A%84%E5%AD%98%E5%82%A8%E7%A9%BA%E9%97%B4%E5%88%86%E9%85%8D%E5%99%A8/" rel="prev" title="ceph中的存储空间分配器">
      <i class="fa fa-chevron-left"></i> ceph中的存储空间分配器
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/10/13/CRaft/" rel="next" title="CRaft An Erasure-coding-supported Version of Raft for Reducing Storage Cost and Network Cost">
      CRaft An Erasure-coding-supported Version of Raft for Reducing Storage Cost and Network Cost <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC82MDkyNS8zNzM5NQ=="></div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Ceph-RBD"><span class="nav-number">1.</span> <span class="nav-text">Ceph RBD</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.</span> <span class="nav-text">整体介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%A0%E4%B8%AA%E9%87%8D%E8%A6%81%E7%9A%84%E5%AD%98%E5%82%A8%E7%BB%84%E7%BB%87"><span class="nav-number">2.1.</span> <span class="nav-text">几个重要的存储组织</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IO%E6%B5%81%E7%A8%8B"><span class="nav-number">2.2.</span> <span class="nav-text">IO流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RBD-IO-%E6%A1%86%E6%9E%B6"><span class="nav-number">2.2.1.</span> <span class="nav-text">RBD IO 框架</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%86%99%E6%95%B0%E6%8D%AEosd%E8%BF%87%E7%A8%8B%EF%BC%9A"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">客户端写数据osd过程：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#librbd"><span class="nav-number">2.3.</span> <span class="nav-text">librbd</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.3.1.</span> <span class="nav-text">模块介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#librbd-%E8%AF%A6%E7%BB%86%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.3.2.</span> <span class="nav-text">librbd 详细介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97"><span class="nav-number">2.3.2.1.</span> <span class="nav-text">功能模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6"><span class="nav-number">2.3.2.2.</span> <span class="nav-text">核心机制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BB%84%E6%88%90%E5%85%83%E7%B4%A0"><span class="nav-number">2.3.2.3.</span> <span class="nav-text">组成元素</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E6%8E%A5%E5%8F%A3%E5%A3%B0%E6%98%8E"><span class="nav-number">2.3.2.4.</span> <span class="nav-text">相关接口声明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#class-CEPH-RBD-API-RBD"><span class="nav-number">2.3.2.5.</span> <span class="nav-text">class CEPH_RBD_API RBD</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#class-CEPH-RBD-API-Image"><span class="nav-number">2.3.2.6.</span> <span class="nav-text">class CEPH_RBD_API Image</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.3.2.7.</span> <span class="nav-text">具体实现</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Cls"><span class="nav-number">2.3.3.</span> <span class="nav-text">Cls</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Client"><span class="nav-number">2.3.3.1.</span> <span class="nav-text">Client</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Server"><span class="nav-number">2.3.3.2.</span> <span class="nav-text">Server</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Others"><span class="nav-number">2.3.4.</span> <span class="nav-text">Others</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E7%89%87-Striper"><span class="nav-number">2.3.5.</span> <span class="nav-text">分片 Striper</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE-IO"><span class="nav-number">2.3.6.</span> <span class="nav-text">数据 IO</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#read"><span class="nav-number">2.3.6.1.</span> <span class="nav-text">read</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write"><span class="nav-number">2.3.6.2.</span> <span class="nav-text">write</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCMU-RBD"><span class="nav-number">2.3.7.</span> <span class="nav-text">TCMU-RBD</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="nav-number">2.4.</span> <span class="nav-text">参考链接</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="lzy"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">lzy</p>
  <div class="site-description" itemprop="description">选择有时候比努力更重要</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hoshilzy1026" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hoshilzy1026" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:18338064521@163.com" title="E-Mail → mailto:18338064521@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/6888391895" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;6888391895" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/31529112/ffhoshi" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;31529112&#x2F;ffhoshi" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
  </div>



      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021-12 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lzy</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">46k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">2:49</span>
</div>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
<span class="post-meta-divider">|</span>
<span id="busuanzi_container_site_uv">本站访客数<span id="busuanzi_value_site_uv"></span>人</span>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>

</body>
</html>
